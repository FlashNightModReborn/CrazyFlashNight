================================================================================
  PerformanceOptimizer 数据分析报告
  测试版本: 2026-02 (堕落城保卫战 + 开环阶跃响应)
  数据文件: 无名氏_开环阶跃响应.csv, 无名氏_堕落城保卫战测试.csv
================================================================================

目录
────
  1. 测试条件
  2. 开环阶跃响应分析
  3. 闭环战斗测试分析
  4. PID 工程行为分析
  5. 挡位有效性评估
  6. 关键结论与建议

================================================================================
1. 测试条件
================================================================================

【开环阶跃响应 (无名氏_开环阶跃响应.csv)】
  测试方法: sysid 作弊码启用开环模式，锁定 Level=0，不执行控制动作
  目的: 测量 Level=0 下系统的自然帧率（被控对象特性辨识）
  持续时间: 42.7 秒 (115,659ms ~ 158,351ms)
  采样记录: 24 条 SAMPLE (evt=1)

【闭环战斗测试 (无名氏_堕落城保卫战测试.csv)】
  测试场景: 堕落城保卫战 (data\stages\基地车库\堕落城保卫战.xml)
  场景特点: 周期性刷怪(wave-based)，性能预算周期性变化
  控制模式: 全闭环 + 前馈控制
  持续时间: 275.7 秒 (259,028ms ~ 534,689ms) ≈ 4 分 36 秒
  采样记录: 132 条 SAMPLE, 26 次挡位切换, 6 次手动设置, 1 次前馈事件

================================================================================
2. 开环阶跃响应分析
================================================================================

【FPS 统计 (Level=0 锁定)】
  均值:    17.2 FPS
  中位数:  16.0 FPS
  最小值:  13.8 FPS
  最大值:  31.0 FPS (开头两拍为游戏加载暖机)
  标准差:  4.35

  去除前2个暖机样本后，稳态 FPS ≈ 15.5 ~ 16.3 FPS

  结论: Level=0 (最高画质) 在本压力场景下稳态帧率仅 ~16 FPS，
  远低于目标帧率 26 FPS。这意味着不开启性能调度系统时，游戏不可玩。

【Kalman 滤波器跟踪】
  初始估计:  25.4 (受暖机影响)
  终态估计:  16.3
  时间常数 τ ≈ 6.6 秒 (达到 63% 稳态变化的时间)

  Kalman 滤波器能在约 7 秒内跟踪到实际帧率水平。

【PID 分量范围】
  P 项: [-0.28, +2.76]  — 与 error 成正比，主导控制输出
  I 项: [-1.50, +1.50]  — 全程饱和（100% 采样点 |I|=1.5）
  D 项: [-1.24, +0.25]  — 阻尼作用，抑制快速变化

================================================================================
3. 闭环战斗测试分析
================================================================================

【总体 FPS 统计】
  均值:    26.1 FPS
  中位数:  27.8 FPS
  最小值:  7.4 FPS (刷怪高峰的瞬时跌落)
  最大值:  32.4 FPS
  标准差:  4.71

  与开环的 16 FPS 相比，闭环控制将平均 FPS 提升了约 +10 FPS (+62%)。

【各挡位采样分布】
  ┌──────┬──────────┬───────────┬──────────┬──────────────────────┐
  │ 挡位 │ 采样数   │ 驻留时间   │ 时间占比  │ 设计意图             │
  ├──────┼──────────┼───────────┼──────────┼──────────────────────┤
  │ L0   │ 81(61.4%)│ 105.5 秒  │ 38.3%    │ 理想挡位，最高画质    │
  │ L1   │ 17(12.9%)│ 45.7 秒   │ 16.6%    │ 缓冲挡位，过渡用      │
  │ L2   │ 29(22.0%)│ 100.3 秒  │ 36.4%    │ 高压挡位，团战默认     │
  │ L3   │ 5 (3.8%) │ 24.2 秒   │ 8.8%     │ 兜底挡位，不应常驻     │
  └──────┴──────────┴───────────┴──────────┴──────────────────────┘

  注: 采样占比 ≠ 时间占比。高挡位采样周期更长 (N=frameRate×(1+level))，
  所以 L2/L3 的采样数看起来比实际驻留时间少。以驻留时间为准。

【各挡位平均 FPS (原始帧率)】
  L0: 26.7 FPS (min=14.8, max=32.4, std=4.2)
  L1: 23.0 FPS (min=18.0, max=30.0, std=4.0)
  L2: 26.2 FPS (min=7.4,  max=30.4, std=5.9)
  L3: 25.2 FPS (min=21.4, max=29.3, std=3.5)

  注意: 这些是在各挡位采样时的即时帧率，L2 的均值高于 L1 说明
  L2 的降载手段 (_quality=LOW) 有效地恢复了帧率。

【平均驻留时间 (单次)】
  L0: 7.5 秒/段 (14 段)
  L1: 6.5 秒/段 (7 段)
  L2: 10.0 秒/段 (10 段)
  L3: 12.1 秒/段 (2 段)

【挡位切换统计 (26 次)】
  L0→L1: 7 次  (切换时 FPS 均值 20.0，范围 14.8~25.0)
  L0→L2: 1 次  (跳级，FPS=19.2)
  L1→L2: 6 次  (切换时 FPS 均值 21.9，范围 18.0~26.3)
  L1→L0: 1 次  (恢复)
  L2→L0: 7 次  (恢复，切换时 FPS 通常 ≥28)
  L2→L3: 2 次  (极端压力)
  L3→L2: 2 次  (恢复)

  平均切换间隔: 275.7/26 ≈ 10.6 秒/次

【Ping-Pong 振荡 (30秒内来回切换)】
  检测到 6 次快速振荡:
  - L2↔L3: 2 次 (间隔 9.4s, 14.8s)
  - L2↔L0: 2 次 (间隔 4.4s, 6.0s)
  - L0↔L1: 2 次 (间隔 6.9s, 14.6s)

  其中 115~166 秒区间集中出现了 4 次连续振荡，
  对应刷怪波次间歇期的帧率短暂回升。

================================================================================
4. PID 工程行为分析
================================================================================

【积分项退化为方向偏置】
  开环测试: 100% 采样点 |I|=1.5 (24/24)
  闭环测试: 96.2% 采样点 |I|≥1.49 (127/132)

  原因: deltaTime 传入帧数 (30~120)，积分累加 error×30~120，
  integralMax=3 时，任何 |error|>0.025 都在首拍饱和。
  iTerm = Ki×(±3) = 0.5×(±3) = ±1.5，退化为恒定方向偏置。

  工程影响: 在4档离散系统中，积分退化不构成损失。
  round()+迟滞量化器会抹平 ±1.5 以下的精度，渐进积累本就无意义。

【Kd=-30 的阻尼效应】
  FPS 下降时: error 增大 → de/dt > 0 → D = -30 × 正 = 负
    → D 抵消 P，减缓 PID 输出上升 → 不急于降级，过滤瞬时帧率跌落
    实测 D ≈ -0.8 ~ -1.3，部分抵消 P ≈ +1.0 ~ +2.0

  FPS 回升时: error 减小 → de/dt < 0 → D = -30 × 负 = 正
    → D 与 P 叠加（但 P 此时为负），延缓恢复至低挡位
    实测 D ≈ +0.2 ~ +0.5，部分抵消 P ≈ -0.5 ~ -1.0

  综合: PID 退化为「P + 方向偏置(±1.5) + 阻尼(D)」的阈值生成器，
  稳定性由后级迟滞量化器保证。

【deltaTime=帧数 的缩放效应】
  deltaTime 范围: 30(L0) ~ 120(L3)
  积分缩放: error×30~120 → 立即饱和
  微分缩放: Δerror/30~120 → 有效增益 Kd/dt = -30/30~120 ≈ -1.0~-0.25
  若改为秒(~1~4s): D项将达 ±30~60，远超 P+I，系统发散。
  当前单位是使 |Kd|=30 工作在合理范围的必要条件。

================================================================================
5. 挡位有效性评估
================================================================================

【L0 理想挡位 — 符合设计】
  驻留时间 38.3%，平均 FPS 26.7。
  在刷怪间歇期能稳定维持最高画质，系统会积极恢复到 L0。
  评价: ★★★★★ 完全符合「理想挡位」设计意图。

【L1 缓冲挡位 — 过渡角色明确，但降载效果有限】
  驻留时间 16.6%，平均 FPS 23.0，平均驻留仅 6.5 秒。
  L0→L1 转换时 FPS 均值 20.0，处于「已经偏低」的状态。
  L1 的参数调整 (特效 20→12, 弹壳 25→12) 对帧率提升有限。

  关键数据: L0→L1 平均 ΔFPS ≈ +1.7
            L1→L2 平均 ΔFPS ≈ +6.1 (L2 引入 _quality=LOW)
  极端案例: L1 时 18.0 FPS → L2 切换后 30.3 FPS (+12.3)

  结论: L1 的核心价值是「保护画质的缓冲区」而非「显著提升帧率」。
  大多数情况下 L1 只是 L0→L2 的过渡站，驻留时间短。
  评价: ★★★☆☆ 缓冲角色基本实现，但作为独立挡位效果不显著。

【L2 高压挡位 — 战斗核心，符合设计】
  驻留时间 36.4%，平均 FPS 26.2，平均驻留 10.0 秒。
  _quality=LOW 是主要降载手段，实测 ΔFPS 提升为 L1 的 3.5 倍。
  在持续战斗中，系统倾向于稳定在 L2，符合「团战默认挡位」设计。
  评价: ★★★★★ 完全符合「高压挡位」设计意图。

【L3 兜底挡位 — 罕见出现，符合设计】
  驻留时间 8.8%，仅出现 2 段，平均驻留 12.1 秒。
  触发条件: L2 连续观测到低帧率 (16.3~17.2 FPS 区间)
  第一次: 持续高压段末尾 (252.3s)，系统降级后恢复
  第二次: 已无数据记录额外出现
  评价: ★★★★☆ 基本符合「不应常驻的兜底」设计。
  扣分原因: 8.8%驻留时间略高于「理论不应出现」的预期，
  但考虑测试场景为最高压关卡，可以接受。

【面积系数 — 对战斗帧率无直接影响】
  面积系数控制非战斗环境的 NPC 刷新密度。
  在 wave-based 战斗关卡中，敌人由脚本直接生成，面积系数不参与。
  因此 L0→L1 的面积系数变化 (300K→450K) 对战斗帧率无贡献。
  这部分解释了 L1 降载效果有限的原因。

================================================================================
6. 关键结论与建议
================================================================================

【系统整体评估: 实战可用】
  无控制系统时: 稳态 16 FPS (不可玩)
  有控制系统时: 平均 26.1 FPS (可玩，接近目标 26 FPS)
  FPS 提升幅度: +62%
  在极端高压测试中评分约 61/100，正常游戏场景预期更高。

【无需调整 PID 参数】
  1. 积分退化为方向偏置在4档离散系统中不构成损失
  2. Kd=-30 的阻尼效应在合理范围内
  3. round()+迟滞量化器是稳定性的主要保障，PID精度不是瓶颈
  4. 修改 PID 参数需要同步重调 Kd/Ki/integralMax/deltaTime 单位，无独立收益

【L1 改进方向 (如需优化)】
  优先级1: 考虑非对称迟滞阈值 — 升级门槛高于降级门槛，
          减少刷怪间歇期的频繁升降级
  优先级2: 评估 L1 是否需要引入 _quality=MEDIUM 以外的降载手段
  优先级3: 如果4档粒度足够，L1 作为缓冲区的当前设计可以保留

【Ping-Pong 振荡的缓解】
  当前 6 次 ping-pong 集中在刷怪波次间歇期。
  迟滞量化器已是第一道防线（需连续确认2次才切换）。
  如需进一步缓解，可考虑:
  - 增大迟滞宽度 (代价: 响应变慢)
  - 非对称迟滞 (升级快、降级慢)
  - 在 wave 间歇期启用保护窗口 (前馈控制已部分实现)

================================================================================
  分析完成于 2026-02
  工具: PerformanceLogger 环形缓冲 + 列式存储
  方法: 开环系统辨识 + 闭环战斗实测
================================================================================
