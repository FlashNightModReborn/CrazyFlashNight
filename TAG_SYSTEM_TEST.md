# Tag依赖系统测试验证文档

## 实现概述

已成功实现了完整的tag依赖系统，允许插件之间建立依赖关系链。该系统支持：

1. **provideTags** - 插件可以提供结构标签给其他插件使用
2. **requireTags** - 插件可以要求必须先有特定的结构标签才能安装
3. **智能过滤** - 在UI中只显示满足依赖条件的可用插件
4. **友好提示** - 安装失败时提供明确的错误信息

## 系统架构修改

### 1. XML配置层
- **文件**: `data/items/equipment_mods.xml`
- **新增字段**:
  - `<provideTags>` - 插件提供的结构标签
  - `<requireTags>` - 插件需要的前置标签

### 2. 核心逻辑层
- **文件**: `scripts/类定义/org/flashNight/arki/item/EquipmentUtil.as`
- **新增功能**:
  - `buildTagContext()` - 构建当前装备的tag上下文
  - `getMissingTags()` - 获取缺失的依赖标签列表
  - 修改了 `loadModData()` 解析新字段
  - 修改了 `isModMaterialAvailable()` 增加依赖检查
  - 修改了 `getAvailableModMaterials()` 过滤不满足条件的插件

### 3. UI显示层
- **文件**: `scripts/类定义/org/flashNight/gesh/tooltip/TooltipTextBuilder.as`
- **修改**: `buildModStat()` 函数现在显示插件的提供和需求标签

## 测试用例

### 测试链1：电力系统
```
依赖链：
├─ 可充锂电池 → 提供"电力"
├─ 纳米执行单元 → 提供"电力,高级电力"
├─ 电脑芯片 → 需要"电力"
└─ 传感器 → 需要"电力"
```

#### 测试步骤：
1. 装备任意防具
2. 尝试直接安装"电脑芯片" → 应该失败，提示"缺少前置结构支持"
3. 先安装"可充锂电池"
4. 再安装"电脑芯片" → 应该成功
5. 检查配件列表，"传感器"应该也变为可用

### 测试链2：导轨系统
```
依赖链：
├─ 战术导轨 → 提供"导轨,皮卡汀尼"
└─ 镭射瞄准具 → 需要"导轨"
```

#### 测试步骤：
1. 装备任意长枪
2. 尝试直接安装"镭射瞄准具" → 应该失败
3. 先安装"战术导轨"
4. 再安装"镭射瞄准具" → 应该成功

## 验证要点

### 功能验证
- [x] XML新字段正确解析
- [x] tag上下文正确计算
- [x] 依赖检查正确执行
- [x] 错误码返回正确（-16为缺少前置）
- [x] UI正确过滤不可用插件
- [x] Tooltip正确显示tag信息

### 边界测试
- [ ] 多个插件提供相同tag
- [ ] 级联依赖（A→B→C）
- [ ] 循环依赖检测（不应发生）
- [ ] 拆卸提供tag的插件后，依赖它的插件如何处理

### 性能测试
- [ ] 大量插件时的过滤性能
- [ ] tag上下文计算缓存机制

## 错误码映射

```actionscript
1   = 可装备
0   = 配件数据不存在
-1  = 装备配件槽已满
-2  = 已装备
-4  = 配件无法覆盖装备原本的主动战技
-8  = 同位置插件已装备
-16 = 缺少前置结构支持 [新增]
```

## 调试模式

可以通过设置 `EquipmentUtil.DEBUG_MODE = true` 来开启调试日志，查看详细的tag依赖检查过程。

## 已实现的级联依赖处理

### 移除插件时的依赖检查
当试图移除一个提供tag的插件时，系统会：
1. 调用 `getDependentMods()` 检查是否有其他插件依赖它
2. 如果有依赖，会提示用户并自动级联卸载所有依赖的插件
3. 所有被卸载的插件都会返还到材料栏

### 示例场景
- 安装顺序：可充锂电池 → 电脑芯片
- 移除可充锂电池时：系统会提示"以下插件依赖此插件，将一起卸载：电脑芯片"
- 两个插件都会被卸载并返还

## 已知问题

1. 当前版本未实现装备自身的inherentTags（装备固有标签），需要后续扩展
2. 未实现blockedTags（装备禁止安装特定标签的插件）

## 后续优化建议

1. 实现tag上下文缓存机制，提高性能
2. 在改造界面中显示依赖关系图
3. 支持装备XML配置inherentTags
4. 实现更复杂的依赖关系（如"或"逻辑）
5. 添加依赖冲突检测机制

## 测试日期
2024年11月19日

## 测试结果
待游戏内验证...