# PerformanceOptimizer 数据采集测试指南

> 本指南面向参与性能调度系统数据采集的测试人员。
> 采集的数据用于开环系统辨识（`sysid`）和闭环行为验证（`cllog`），支撑 `paper.md` 中的分析。

---

## 0. 环境准备

### 0.1 安装服务器环境（首次）

若未安装过本地服务器，需先完成一次性配置：

1. 以**管理员身份**打开 PowerShell。
2. 进入项目根目录下的 `automation/` 文件夹。
3. 执行：
   ```powershell
   .\configure_server.ps1
   ```
   该脚本会自动安装 Node.js v20.12.2 并配置 Flash Player 信任目录。

> 如遇到 PowerShell 执行策略限制，先运行：
> ```powershell
> Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy RemoteSigned
> ```
> 详见 `automation/README.md`。

### 0.2 统一游戏设置

为确保不同测试人员的数据可比，必须使用统一的启动配置。确认 `automation/config.toml` 与以下一致：

```toml
quality = "medium"
fullscreen = false
resolution_width = 1024
resolution_height = 576
fps = 30
```

**关键要求：窗口模式、默认分辨率（1024x576）** 不要修改这些参数。

### 0.3 启动游戏

在 `automation/` 目录下执行：

```powershell
.\start.ps1
```

或者直接在文件资源管理器中找到 `start.ps1`，**右键 → 使用 PowerShell 运行**。

该脚本会同时启动 Flash Player 游戏窗口和本地服务器（各一个独立窗口）。**保持服务器 PowerShell 窗口不要关闭**——日志将输出到此窗口。

---

## 1. 测试一：开环系统辨识（sysid）

### 目的

采集各性能级别（L0–L3）下的稳态 FPS，用于辨识执行器增益和被控对象时间常数。测试自动执行 7 阶段开环阶跃序列：

$$L0 \to L1 \to L2 \to L3 \to L2 \to L1 \to L0$$

每阶段保持 30 秒（帧计数）。标称总时长约 3.5 分钟，但由于帧率折损（FPS 低于 30 时同样帧数对应更长的挂钟时间），**实际耗时约 6 分钟**（参考基线数据 `fs_开环阶跃响应.csv`：355.7 秒）。

### 步骤

#### 1.1 准备战斗场景

1. 打开修改器，刷出**血牛项链**装备并穿戴。
   - 血牛项链提供极高的 HP 加成，确保挂机期间主角不会死亡。测试中断将导致数据作废。
2. 进入 **DEATH MATCH 竞技场**。
3. 选择参数：
   - 挑战对手数量：**4**
   - 对手等级：**40–60**
4. 开始挑战。

#### 1.2 制造持续高压负载

进入战斗后：

1. 打开修改器 → 兵种 → 翻到**第八页**。
2. 选择**浮士德兄弟**，刷出 **4 个**。
   - 浮士德兄弟会持续发射大量穿刺子弹，确保碰撞检测系统始终处于高压运作状态，产生稳定且具有代表性的渲染负载。
3. 保持挂机，**不要操作角色**。

#### 1.3 启动测试

1. 打开设置界面。
2. 输入作弊码：**`sysid`**
3. 屏幕将提示"系统辨识测试开始"，并显示测试序列。
4. **等待测试自动完成**（约 3.5 分钟）。测试结束后会自动导出日志到服务器控制台。
   - 如需中途终止，输入 **`stopsysid`**，已收集的数据仍会导出。

#### 1.4 保存日志

1. 切换到**服务器 PowerShell 窗口**。
2. 日志以 CSV 文本形式打印在控制台中。每行数据前会带有服务器标识头（如 `info: [F: 35609]`），**复制时需要去掉这些标识头**。实际输出示例：
   ```
   info: [F: 35609] timeMs,evt,a,b,c,d,s
   1190071,1,0,30.4,30.0182109695566,-2.45115714349634,CL
   1190071,5,-1.00455274238914,-1.5,0.0533955988928073,-2.45115714349634,
   ...
   ```
   只保留 `timeMs,evt,a,b,c,d,s` 表头及其后的纯数据行。
3. **选中全部 CSV 文本**（从表头 `timeMs,evt,a,b,c,d,s` 开始到最后一行数据），右键复制。
4. 在目标文件夹中右键 → 新建 → **文本文档**，打开后将内容粘贴进去，保存并关闭。
5. 在文件资源管理器中将该文件的后缀从 `.txt` 改为 `.csv`。
   - 如果看不到后缀名：文件资源管理器顶部 → 查看 → 勾选**文件扩展名**。
6. 按命名规约重命名文件（见第 3 节）。

---

## 2. 测试二：闭环战斗日志（cllog）

### 目的

在不干预调度系统的情况下，记录真实战斗中的闭环行为——包括级别切换、PID 输出、卡尔曼估计等。用于验证迟滞确认机制、振荡分析和 FPS 改善评估。

### 步骤

#### 2.1 进入堕落城保卫战

1. 导航至**堕落城**区域。
2. 使用修改器 → 关卡 → **解锁关卡**，使堕落城保卫战可访问。
3. 确认角色装备与等级符合**诺亚主线期间**的预期练度。
   - 不要穿戴过强或过弱的装备，目标是还原该关卡设计意图下的战斗负载。

#### 2.2 启动日志记录

1. 在**选关界面**输入作弊码：**`cllog`**
2. 屏幕将提示"闭环日志记录中"。

#### 2.3 执行战斗

1. 选择难度：**地狱**。
2. 开始挑战**堕落城保卫战**。
3. 正常游玩直到**通关**。

#### 2.4 停止记录并保存

1. 通关后，输入作弊码：**`stopcllog`**
2. 日志导出到服务器控制台。
3. 按与测试一相同的方式保存日志（见 1.4 节）。

---

## 3. 文件命名规约

所有日志文件统一按以下格式命名：

```
{测试人}_{CPU型号}_{测试内容}.csv
```

其中测试内容对应：
- 测试一（sysid）→ **开环阶跃响应**
- 测试二（cllog）→ **堕落城保卫战**

**示例：**

| 文件名 | 说明 |
|--------|------|
| `张三_i5-12400F_开环阶跃响应.csv` | 张三在 i5-12400F 上的 sysid 测试 |
| `张三_i5-12400F_堕落城保卫战.csv` | 张三在 i5-12400F 上的闭环战斗测试 |
| `李四_R5-5600X_开环阶跃响应.csv` | 李四在 R5-5600X 上的 sysid 测试 |
| `李四_R5-5600X_堕落城保卫战.csv` | 李四在 R5-5600X 上的闭环战斗测试 |

**CPU 型号获取方法：**
- Windows：设置 → 系统 → 关于 → 处理器
- 或在 PowerShell 中执行：
  ```powershell
  (Get-CimInstance Win32_Processor).Name
  ```

---

## 4. 日志格式参考

导出的 CSV 每行格式为：

```
timeMs,evt,a,b,c,d,s
```

事件类型含义：

| evt 值 | 事件类型 | 字段含义 |
|--------|---------|---------|
| 1 | `EVT_SAMPLE` | a=级别, b=实际FPS, c=去噪FPS, d=PID输出, s=标签 |
| 2 | `EVT_LEVEL_CHANGED` | a=旧级别, b=新级别, c=实际FPS, s=画质 |
| 3 | `EVT_MANUAL_SET` | a=级别, b=保持秒数 |
| 4 | `EVT_SCENE_CHANGED` | a=级别, b=实际FPS, c=目标FPS, s=画质 |
| 5 | `EVT_PID_DETAIL` | a=P项, b=I项, c=D项, d=PID输出 |

- **测试一**（sysid）：标签格式为 `OL:from>to`（如 `OL:0>1`）
- **测试二**（cllog）：标签为 `CL`

---

## 5. 注意事项

1. **不要在测试期间切换窗口焦点到其他高负载应用。** 后台进程会影响 FPS 基线。
2. **sysid 测试期间不要操作角色。** 任何操作可能引入额外负载波动，污染稳态测量。
3. **确保血牛项链已装备后再进入战斗。** 角色死亡会中断场景负载，导致数据不可用。
4. **每次测试前确认服务器窗口正常运行。** 若服务器未启动，`dump()` 将 fallback 到 `trace()` 输出，日志可能丢失。
5. **日志缓冲区容量为 4096 条。** 对于 sysid（约 117 条）和正常闭环战斗（约 200 条）均远够用。若长时间录制超长战斗，注意旧数据可能被覆盖。
6. **复制日志时注意完整性。** 确认复制从第一行 `timeMs,evt,...` 开始，到最后一行数据结束，不要遗漏或多复制 PowerShell 提示符。

---

## 6. 已有基线数据

`log/` 目录中已包含以下基线数据供参考：

| 文件 | 内容 | 来源 |
|------|------|------|
| `fs_开环阶跃响应.csv` | 开环阶跃响应（L0→1→2→3→2→1→0, 117 样本） | 低端机器 |
| `fs_堕落城保卫战测试.csv` | 闭环战斗日志（195 样本, 25 次切换, 345.5 秒） | 低端机器 |
| `数据分析报告.txt` | 2026-02 分析报告 | — |

新采集的数据将与这些基线进行跨硬件对比分析。

---

## 7. 快速检查清单

开始测试前逐项确认：

- [ ] `automation/config.toml` 设置正确（窗口模式、1024x576、30 FPS）
- [ ] 服务器已启动（`start.ps1`，PowerShell 窗口可见）
- [ ] 已记录本机 CPU 型号
- [ ] 测试一：血牛项链已装备
- [ ] 测试一：DEATH MATCH 参数正确（4人、40-60级）
- [ ] 测试一：浮士德兄弟 × 4 已刷出
- [ ] 测试二：角色练度符合诺亚主线期间
- [ ] 测试二：堕落城保卫战已解锁
- [ ] 测试二：难度选择地狱
