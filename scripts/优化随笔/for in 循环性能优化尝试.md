### ActionScript 2 实验报告：提升 `for...in` 循环性能的属性标志优化

#### 背景
在 ActionScript 2 (AS2) 中，`for...in` 循环会遍历对象的所有属性。然而，AS2 提供了 `_global.ASSetPropFlags` 函数，通过设置不同的属性标志可以控制属性的可枚举性、只读性、可删除性等，从而影响 `for...in` 循环的遍历性能。

#### 实验目的
本实验旨在通过设置不同的属性标志，观察其对 `for...in` 循环性能的影响，以确定如何使用这些标志提升遍历性能。

#### 实验方案
1. **创建测试对象**：包含 10,000 个属性。
2. **测试模式**：设置不同的属性标志，涵盖不可枚举、只读、不可删除及其组合。
3. **测试规模**：设置少量（10 个）、适量（500 个）、大量（5000 个）属性，观察性能变化。
4. **循环展开**：使用多次 `for...in` 循环，以减少测试中循环开销的影响。

#### 属性标志设置模式
- **不可枚举 (1)**：属性不会被 `for...in` 遍历到。
- **只读 (2)**：属性不可修改。
- **不可删除 (4)**：属性不可删除。
- **组合标志 (3, 5, 6, 7)**：将以上标志组合以实现不可枚举、只读、不可删除的不同组合。

#### 实验结果

| 模式          | 标志组合          | 属性设置规模 | 遍历时间 (ms) |
|---------------|-------------------|--------------|---------------|
| 无设置        | 无标志            | 无设置       | 433           |
| 无设置        | 无标志            | 少量设置     | 428           |
| 少量不可枚举  | 不可枚举 (1)      | 少量设置     | 421           |
| 少量不可枚举  | 不可枚举 (1)      | 大量设置     | 200           |
| 适量不可枚举  | 不可枚举 (1)      | 适量设置     | 218           |
| 大量不可枚举  | 不可枚举 (1)      | 大量设置     | 197           |
| 只读          | 只读 (2)          | 大量设置     | 427           |
| 不可删除      | 不可删除 (4)      | 大量设置     | 425           |
| 组合（不可枚举 + 只读）| 不可枚举 + 只读 (3) | 大量设置 | 201           |
| 组合（不可枚举 + 不可删除）| 不可枚举 + 不可删除 (5) | 大量设置 | 203  |
| 组合（不可枚举 + 只读 + 不可删除）| 不可枚举 + 只读 + 不可删除 (7) | 大量设置 | 202 |

#### 结论

1. **不可枚举标志（1）** 对 `for...in` 性能有显著影响。随着不可枚举属性数量增加，遍历时间明显减少。例如，在大量设置不可枚举属性时，遍历时间减少约 50%。
   
2. **只读（2）和不可删除（4）标志** 对 `for...in` 性能无明显影响。这些标志主要用于属性修改和删除的控制，不会影响遍历行为。

3. **组合标志（如不可枚举 + 其他）** 中，不可枚举标志对遍历性能的影响最为显著，其他标志仅影响属性操作权限，不影响遍历性能。

#### 指导建议
- **优化 `for...in` 性能**：对无需遍历的属性设置不可枚举标志（1），可有效提升性能，特别是在对象属性数量较多的情况下。
- **属性访问控制**：只读和不可删除标志可用于控制属性的操作权限，但不会影响遍历性能。

#### 实验总结
本实验结果表明，通过合理设置不可枚举标志，`for...in` 循环的性能可以显著优化。建议在不需要遍历的属性上应用不可枚举标志，以减少遍历的属性数量，提升性能。





// 初始化测试对象
var testObject = {};
for (var i = 0; i < 10000; i++) {
    testObject["prop" + i] = Math.random();
}

// 定义测试函数，包含循环展开
function testForInPerformance(obj, iterations) {
    var startTime = getTimer();
    for (var j = 0; j < iterations; j++) {
        for (var prop in obj) {
            var value = obj[prop];
        }
    }
    var endTime = getTimer();
    return endTime - startTime;
}

// 定义操作模式及其对应的标志值
var flagModes = [
    { name: "模式1", description: "无特殊属性设置", flags: 0 },
    { name: "模式2", description: "少量不可枚举属性", flags: 1 },
    { name: "模式3", description: "适量不可枚举属性", flags: 1 },
    { name: "模式4", description: "大量不可枚举属性", flags: 1 },
    { name: "模式5", description: "少量只读属性", flags: 2 },
    { name: "模式6", description: "少量不可删除属性", flags: 4 },
    { name: "模式7", description: "少量不可枚举且只读属性", flags: 3 },
    { name: "模式8", description: "少量不可枚举且不可删除属性", flags: 5 },
    { name: "模式9", description: "少量只读且不可删除属性", flags: 6 },
    { name: "模式10", description: "少量不可枚举、只读且不可删除属性", flags: 7 }
];

// 定义测试规模
var scales = [
    { name: "无设置", count: 0, startIndex: 0 },
    { name: "少量设置", count: 10, startIndex: 0 },
    { name: "适量设置", count: 500, startIndex: 10 },
    { name: "大量设置", count: 5000, startIndex: 510 }
];

// 设置循环展开次数
var iterations = 100;

// 重置ASSetPropFlags设置的函数
function resetASSetPropFlags(obj) {
    // 这里假设只需要重置前10个属性的标志
    _global.ASSetPropFlags(obj, ["prop0", "prop1", "prop2", "prop3", "prop4", "prop5", "prop6", "prop7", "prop8", "prop9"], 0, true);
    // 你可以根据需要添加更多重置操作
}

// 执行测试
for (var m = 0; m < flagModes.length; m++) {
    var mode = flagModes[m];
    for (var s = 0; s < scales.length; s++) {
        var scale = scales[s];
        var propsToSet = [];
        
        // 根据测试规模选择属性范围
        if (scale.count > 0) {
            for (var i = scale.startIndex; i < scale.startIndex + scale.count; i++) {
                propsToSet.push("prop" + i);
            }
            _global.ASSetPropFlags(testObject, propsToSet, mode.flags, true);
        }
        
        // 执行测试
        trace(mode.name + "（" + mode.description + "，" + scale.name + "）开始测试...");
        var time = testForInPerformance(testObject, iterations);
        trace(mode.name + "（" + mode.description + "，" + scale.name + "）遍历时间: " + time + "ms");
        
        // 重置属性标志，以避免影响下一个测试
        resetASSetPropFlags(testObject);
    }
}



模式1（无特殊属性设置，无设置）开始测试...
模式1（无特殊属性设置，无设置）遍历时间: 433ms
模式1（无特殊属性设置，少量设置）开始测试...
模式1（无特殊属性设置，少量设置）遍历时间: 428ms
模式1（无特殊属性设置，适量设置）开始测试...
模式1（无特殊属性设置，适量设置）遍历时间: 432ms
模式1（无特殊属性设置，大量设置）开始测试...
模式1（无特殊属性设置，大量设置）遍历时间: 426ms
模式2（少量不可枚举属性，无设置）开始测试...
模式2（少量不可枚举属性，无设置）遍历时间: 422ms
模式2（少量不可枚举属性，少量设置）开始测试...
模式2（少量不可枚举属性，少量设置）遍历时间: 421ms
模式2（少量不可枚举属性，适量设置）开始测试...
模式2（少量不可枚举属性，适量设置）遍历时间: 409ms
模式2（少量不可枚举属性，大量设置）开始测试...
模式2（少量不可枚举属性，大量设置）遍历时间: 200ms
模式3（适量不可枚举属性，无设置）开始测试...
模式3（适量不可枚举属性，无设置）遍历时间: 200ms
模式3（适量不可枚举属性，少量设置）开始测试...
模式3（适量不可枚举属性，少量设置）遍历时间: 199ms
模式3（适量不可枚举属性，适量设置）开始测试...
模式3（适量不可枚举属性，适量设置）遍历时间: 218ms
模式3（适量不可枚举属性，大量设置）开始测试...
模式3（适量不可枚举属性，大量设置）遍历时间: 203ms
模式4（大量不可枚举属性，无设置）开始测试...
模式4（大量不可枚举属性，无设置）遍历时间: 203ms
模式4（大量不可枚举属性，少量设置）开始测试...
模式4（大量不可枚举属性，少量设置）遍历时间: 200ms
模式4（大量不可枚举属性，适量设置）开始测试...
模式4（大量不可枚举属性，适量设置）遍历时间: 197ms
模式4（大量不可枚举属性，大量设置）开始测试...
模式4（大量不可枚举属性，大量设置）遍历时间: 201ms
模式5（少量只读属性，无设置）开始测试...
模式5（少量只读属性，无设置）遍历时间: 201ms
模式5（少量只读属性，少量设置）开始测试...
模式5（少量只读属性，少量设置）遍历时间: 202ms
模式5（少量只读属性，适量设置）开始测试...
模式5（少量只读属性，适量设置）遍历时间: 217ms
模式5（少量只读属性，大量设置）开始测试...
模式5（少量只读属性，大量设置）遍历时间: 427ms
模式6（少量不可删除属性，无设置）开始测试...
模式6（少量不可删除属性，无设置）遍历时间: 429ms
模式6（少量不可删除属性，少量设置）开始测试...
模式6（少量不可删除属性，少量设置）遍历时间: 427ms
模式6（少量不可删除属性，适量设置）开始测试...
模式6（少量不可删除属性，适量设置）遍历时间: 426ms
模式6（少量不可删除属性，大量设置）开始测试...
模式6（少量不可删除属性，大量设置）遍历时间: 425ms
模式7（少量不可枚举且只读属性，无设置）开始测试...
模式7（少量不可枚举且只读属性，无设置）遍历时间: 430ms
模式7（少量不可枚举且只读属性，少量设置）开始测试...
模式7（少量不可枚举且只读属性，少量设置）遍历时间: 424ms
模式7（少量不可枚举且只读属性，适量设置）开始测试...
模式7（少量不可枚举且只读属性，适量设置）遍历时间: 416ms
模式7（少量不可枚举且只读属性，大量设置）开始测试...
模式7（少量不可枚举且只读属性，大量设置）遍历时间: 201ms
模式8（少量不可枚举且不可删除属性，无设置）开始测试...
模式8（少量不可枚举且不可删除属性，无设置）遍历时间: 200ms
模式8（少量不可枚举且不可删除属性，少量设置）开始测试...
模式8（少量不可枚举且不可删除属性，少量设置）遍历时间: 199ms
模式8（少量不可枚举且不可删除属性，适量设置）开始测试...
模式8（少量不可枚举且不可删除属性，适量设置）遍历时间: 202ms
模式8（少量不可枚举且不可删除属性，大量设置）开始测试...
模式8（少量不可枚举且不可删除属性，大量设置）遍历时间: 203ms
模式9（少量只读且不可删除属性，无设置）开始测试...
模式9（少量只读且不可删除属性，无设置）遍历时间: 202ms
模式9（少量只读且不可删除属性，少量设置）开始测试...
模式9（少量只读且不可删除属性，少量设置）遍历时间: 201ms
模式9（少量只读且不可删除属性，适量设置）开始测试...
模式9（少量只读且不可删除属性，适量设置）遍历时间: 222ms
模式9（少量只读且不可删除属性，大量设置）开始测试...
模式9（少量只读且不可删除属性，大量设置）遍历时间: 435ms
模式10（少量不可枚举、只读且不可删除属性，无设置）开始测试...
模式10（少量不可枚举、只读且不可删除属性，无设置）遍历时间: 427ms
模式10（少量不可枚举、只读且不可删除属性，少量设置）开始测试...
模式10（少量不可枚举、只读且不可删除属性，少量设置）遍历时间: 429ms
模式10（少量不可枚举、只读且不可删除属性，适量设置）开始测试...
模式10（少量不可枚举、只读且不可删除属性，适量设置）遍历时间: 411ms
模式10（少量不可枚举、只读且不可删除属性，大量设置）开始测试...
模式10（少量不可枚举、只读且不可删除属性，大量设置）遍历时间: 202ms
所有测试完成。请根据上述结果对比各操作模式和设置规模下的遍历性能。












