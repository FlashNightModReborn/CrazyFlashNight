# 自优化工作流指南

> 定义 Agent 在会话收尾时执行的知识归档与文档维护流程。
> 这是 agentsDoc/ 文档体系持续生长的核心驱动机制。

---

## 1. 触发时机

在以下场景触发自优化流程：
- 用户明确结束会话前
- 完成一个较大的开发任务后
- 发现了重要的技术洞察或踩坑经验时
- 用户主动要求总结归档时

---

## 2. 自优化检查清单

### 步骤 A：回顾本次会话
- [ ] 本次会话解决了什么问题？
- [ ] 有没有发现新的 AS2 怪癖或幻觉模式？
- [ ] 有没有性能相关的发现？
- [ ] 有没有对项目架构的新理解？
- [ ] 有没有游戏设计层面的决策记录？

### 步骤 B：决策——值得归档吗？

**归档标准**（满足任一即可）：
- 跨会话有价值：其他 Agent 实例遇到同样问题时能受益
- 纠正性知识：修正了之前的错误理解或文档中的不准确信息
- 模式性经验：不是一次性的特例，而是可复用的规律
- 用户明确要求记录的内容

**不归档**：
- 纯粹的一次性调试过程
- 已在代码注释中充分记录的局部细节
- 高度不确定、需要更多验证的猜测

### 步骤 C：选择归档目标

| 发现类型 | 归档到 |
|----------|--------|
| AS2 语法/API 幻觉 | `agentsDoc/as2-anti-hallucination.md` |
| AS2 性能发现 | `agentsDoc/as2-performance.md` |
| 架构理解 | `agentsDoc/architecture.md` |
| 编码规范补充 | `agentsDoc/coding-standards.md` |
| 测试方法发现 | `agentsDoc/testing-guide.md` |
| 游戏系统理解 | `agentsDoc/game-systems.md` |
| 游戏设计决策 | `agentsDoc/game-design.md` |
| 数据结构发现 | `agentsDoc/data-schemas.md` |
| 跨 Agent 共享运营知识 | `agentsDoc/shared-notes.md` |
| 会话级临时状态 | 各 Agent 平台私有记忆（见第 3 节） |

### 步骤 D：执行归档
1. 打开目标文档
2. 找到对应的 `<!-- TODO -->` 标记或合适的位置
3. 追加内容，保持文档格式一致
4. 如果是填充 TODO，完成后移除 TODO 标记

---

## 3. 知识持久化：双轨机制

本项目有多个 Agent 协作（Claude Code、Codex、Kimi Code、Antigravity 等），知识持久化分为两条轨道：

### 轨道 A：仓库内共享记忆 — `agentsDoc/shared-notes.md`

所有 Agent 均可读写，通过 Git 提交同步。适合放入：
- 用户偏好和工作习惯
- 已知的坑和临时 workaround
- 高频操作备忘

不适合放入：
- 详细的技术文档（放 agentsDoc/ 对应主题文件）
- 已在 AGENTS.md 或 CLAUDE.md 中记录的规则
- 大段代码或配置
- 会话级临时状态（见轨道 B）

### 轨道 B：各平台私有记忆

用于**会话级易腐数据**（当前工作进度、未完成任务等），不提交到仓库。各平台路径：

| Agent 平台 | 私有记忆位置 |
|-----------|-------------|
| Claude Code | `~/.claude/projects/[项目]/memory/MEMORY.md` |
| 其他平台 | 各自的会话记忆机制 |

### 决策规则

> 如果一条信息对**其他 Agent 实例也有用** → 轨道 A（shared-notes.md）
> 如果只对**当前会话/当前 Agent** 有用 → 轨道 B（私有记忆）

---

## 4. agentsDoc/ 维护准则

- **渐进式填充**：不追求一次性完善，每次会话填充一点
- **准确性优先**：只记录已验证的信息，不记录猜测
- **格式一致**：遵循各文档已有的 section 结构
- **去重**：添加前检查是否已有相同内容
- **标记来源**：重要发现可标注发现日期或会话上下文

---

## 5. 文档健康度巡检

定期（或用户要求时）检查：
- [ ] 各文档中的 `<!-- TODO -->` 标记是否在逐步减少
- [ ] 是否有过时或不准确的信息需要更新
- [ ] 是否有新的游戏系统或文件类型需要补充索引
- [ ] AGENTS.md 的场景化索引是否覆盖了所有当前工作场景
