import org.flashNight.arki.component.Buff.*;
import org.flashNight.arki.component.Buff.Component.*;

//基因虫
_root.敌人函数.基因虫兵种库 = [
	{兵种:"敌人-普通改造僵尸", 身高:175, 权重:2},
	{兵种:"敌人-兽化改造僵尸", 身高:175, 权重:2},
	{兵种:"敌人-普通爆炸僵尸", 身高:175, 权重:3},
	{兵种:"敌人-蛙型仿生僵尸", 身高:160, 权重:3},
	{兵种:"敌人-boss大僵尸", 身高:175, 权重:4},
	{兵种:"敌人-重型改造僵尸", 身高:175, 权重:4},
	{兵种:"敌人-普通基因虫", 身高:140, 权重:5},
	{兵种:"敌人-普通尸母", 身高:290, 权重:6}
];
//这边代码非常硬，后面做别的随机刷怪就不要抄这个了
_root.敌人函数.基因虫生成僵尸 = function(){
	var 兵种库 = _root.敌人函数.基因虫兵种库;
	var 总权重 = Math.floor(this.身高 / 50); //自然刷新的基因虫身高在150-290之间，即权重在3-5之间
	var 最大权重 = 总权重 > 6 ? 6 : 总权重;
	var 目标权重 = Math.floor(2 + random(最大权重 - 1));//从最小权重2到最大权重(2-6)之间随机选取一个权重
	var 生成数量;
	if(目标权重 == 5) {
		生成数量 = Math.floor((总权重 - 1) / 2); //硬代码让随机到权重5（小型基因虫）时分裂成多个
	}else {
		生成数量 = Math.floor((总权重 - 1) / 目标权重);
	}
	if(生成数量 < 1) 生成数量 = 1;//最小生成数量为1
	else if(生成数量 > 5) 生成数量 = 5;//最大生成数量为5
	var 目标权重兵种库 = [];
	for(var i=0; i<兵种库.length; i++){
		if(兵种库[i].权重 == 目标权重) 目标权重兵种库.push(兵种库[i]);
	}
	var offset = 生成数量 * 8;
	var 名字 = "基因变身怪";
	var 是否为敌人 = this.是否为敌人;
	for(var i=0; i<生成数量; i++){
		var 目标兵种 = 目标权重兵种库[random(目标权重兵种库.length)];
		var shootX = this._x + random(2 * offset + 1) - offset;
		var shootY = this._y + random(2 * offset + 1) - offset;
		var 僵尸型敌人newname = this._name + 目标兵种.兵种 + i;
		_root.加载游戏世界人物(目标兵种.兵种,僵尸型敌人newname,_root.gameworld.getNextHighestDepth(),{_x:shootX, _y:shootY, 等级:等级, 名字:名字, 是否为敌人:是否为敌人, 身高:目标兵种.身高, 长枪:"", 手枪:"", 手枪2:"", 刀:"", 手雷:""});
	}
};

// ==================== 诺艾尔特殊函数 ====================

/**
 * 诺艾尔叠盾技能
 *
 * 【功能】
 * 为诺艾尔添加护盾，护盾期间：
 * - 获得刚体状态
 * - 防御力提升（基础防御力 + 基础防御力 * 等级 / 100）
 * - 伤害类型变为魔法-冲
 * - 护盾容量 = 满血值 * 10%
 *
 * 【边界处理】
 * - 重复施放：清空旧盾后添加新盾（重置而非叠层）
 * - 护盾破碎：自动回滚所有状态
 * - 使用 removeShieldById() 按ID精确移除旧护盾，避免误清其他护盾
 * - 回调中校验护盾ID，避免其他护盾源触发误回滚
 *
 * @param 单位 目标单位（通常是 _parent）
 */
_root.敌人函数.诺艾尔叠盾 = function(单位:MovieClip):Void {
	if (!单位 || !单位.shield) return;

	// _root.发布消息("诺艾尔叠盾技能施放，正在添加护盾...");

	// 状态回滚函数：统一处理护盾结束后的状态恢复
	// 闭包读取当前基础防御力，确保回滚到正确值
	var 回滚护盾状态 = function():Void {
		单位.盾._visible = 0;
		单位.防御力 = 单位.基础防御力;
		单位.伤害类型 = undefined;
		单位.魔法伤害属性 = undefined;
		单位.刚体 = false;
		单位.诺艾尔护盾ID = undefined;

		// _root.发布消息("诺艾尔护盾已破碎，状态已回滚。");
	};

	// 重复施放时清除旧护盾
	// 使用 removeShieldById() 按ID精确移除，避免误清其他护盾（如栈模式下的其他护盾层）
	if (单位.诺艾尔护盾ID != undefined) {
		// 注意顺序：先保存ID，再回滚状态（回滚会清空ID），最后用保存的ID移除护盾
		var 旧护盾ID:Number = 单位.诺艾尔护盾ID;
		回滚护盾状态();
		单位.shield.removeShieldById(旧护盾ID);
	}

	// 显示护盾视觉
	单位.盾._visible = 1;

	// 护盾期间的状态设置
	单位.刚体 = true;
	单位.防御力 = 单位.基础防御力 + 单位.基础防御力 * 单位.等级 / 100;
	单位.伤害类型 = "魔法";
	单位.魔法伤害属性 = "冲";

	// 计算护盾容量（10%满血值）
	var 护盾容量:Number = 单位.hp满血值 * 0.1;

	// 添加临时护盾
	// strength = Infinity 表示无强度限制（兼容原始行为）
	// duration = -1 表示永久（直到破碎）
	var 当前护盾ID:Number = _root.护盾函数.添加临时护盾(单位, 护盾容量, Infinity, -1, "诺艾尔护盾", {
		onBreak: function(shield):Void {
			// 校验护盾ID，防止其他护盾源触发误回滚
			// 只有当破碎的是当前诺艾尔护盾时才回滚
			if (单位.诺艾尔护盾ID == shield.getId()) {
				回滚护盾状态();
			}
		}
	});

	// 记录护盾ID
	单位.诺艾尔护盾ID = 当前护盾ID;
};

// ==================== 雪女特殊函数 ====================

/**
 * 雪女护盾初始化/重建
 *
 * 【护盾特性】
 * - 中强度：可挡住中等威力攻击的特殊效果（斩杀/吸血/击溃等）
 * - 低容量：容易被击破
 * - 可充能：受击后延迟回充，鼓励玩家持续施压
 * - 破碎行为：普通状态下破碎后清空护盾，进阶后破碎可自动回充
 *
 * 【数值设计】
 * - 容量：满血值 * 5%（低容量）
 * - 强度：防御力 + 等级 * 系数（普通2，进阶后5）
 * - 回充速度：每帧3.4%容量（约30帧充满）
 * - 回充延迟：30帧（1秒）
 *
 * 【使用场景】
 * - 初始化时调用：建立初始护盾
 * - 倒地起身时调用：重建护盾
 *
 * @param 单位 目标单位
 */
_root.敌人函数.雪女护盾 = function(单位:MovieClip):Void {
	if (!单位 || !单位.shield) return;

	// 先清空旧护盾（如果有）
	单位.shield.clear();

	// 护盾参数
	var 护盾容量:Number = 单位.hp满血值 * 0.25;    // 25%满血值
	var 已进阶:Boolean = 单位.宠物属性.晶能者;
	var 等级系数:Number = 已进阶 ? 5 : 2;          // 进阶后系数提升
	var 护盾强度:Number = 单位.防御力 + 单位.等级 * 等级系数;
	var 回充速度:Number = 护盾容量 * 0.034;        // 每帧3.4%容量（约30帧充满）
	var 回充延迟:Number = 30;                      // 30帧延迟（1秒）

	// 添加充能护盾
	// 普通状态：破碎时清空，只能通过倒地重建
	// 进阶后：破碎后可自动回充
	var callbacks:Object = 已进阶 ? null : {
		onBreak: function(shield):Void {
			单位.shield.clear();
		}
	};
	_root.护盾函数.添加充能护盾(单位, 护盾容量, 护盾强度, 回充速度, 回充延迟, "雪女冰盾", callbacks);
};

// ==================== 摇滚公园单位Buff函数 ====================
// 适用于：摇滚公园萝莉(吉他)、摇滚公园御姐(主唱)、摇滚公园少女(键盘)
// 这些单位在攻击时会为自己和同伴施加各种增益效果
//
// 【角色职能分工】
// - 萝莉(吉他)：主攻防增益
// - 御姐(主唱)：主回血
// - 少女(键盘)：主速度增益
//
// 【基本属性说明】
// 增益函数依赖"基本属性"来控制增益上限。
// 使用初始化敌人模板的单位会自动定义以下基本属性：
//   - 基本防御力: 来自敌人属性表
//   - 基本速度: 来自行走X速度初始值
//   - 基本空手攻击力: 来自空手攻击力初始值
//
// 【BuffManager集成】
// 增益通过BuffManager实现，使用固定ID确保同类型buff替换而非叠加：
//   - "摇滚速度": 速度增益buff
//   - "摇滚攻击": 攻击增益buff
//   - "摇滚防御": 防御增益buff
// 累计增量存储在单位的 _摇滚XX累计 属性中
//
// 注：韧性增益已移除以降低前期难度

/**
 * 摇滚公园单位 - 速度提升（BuffManager版）
 *
 * 【效果】
 * 通过BuffManager提升单位的移动速度
 *
 * 【实现】
 * 使用固定ID "摇滚速度" 的buff，每次调用累加增量并替换旧buff
 * 累计增量存储在 单位._摇滚速度累计 属性中
 * 由于行走Y/跑X/跑Y通过SpeedDeriveInitializer从行走X速度派生，
 * 只需修改行走X速度即可自动影响所有速度
 *
 * 【前置条件】
 * 需要单位定义 基本速度 属性，否则增益不生效
 *
 * @param 单位 目标单位（通常是 _parent）
 * @param 增量 每次调用增加的速度值，默认为1
 * @param 上限倍率 相对于基本速度的上限倍率，默认为2
 */
_root.敌人函数.摇滚速度提升 = function(单位:MovieClip, 增量:Number, 上限倍率:Number):Void {
	if (isNaN(增量)) 增量 = 1;
	if (isNaN(上限倍率)) 上限倍率 = 2;

	// 初始化累计值
	if (isNaN(单位._摇滚速度累计)) 单位._摇滚速度累计 = 0;

	// 计算上限（基于基本速度）
	var 累计上限:Number = 单位.基本速度 * (上限倍率 - 1); // 上限倍率转换为累加上限

	// 累加但不超过上限
	if (单位._摇滚速度累计 < 累计上限) {
		单位._摇滚速度累计 = Math.min(单位._摇滚速度累计 + 增量, 累计上限);

		// 创建并应用buff（同ID自动替换）
		// 只需修改行走X速度，其他速度通过SpeedDeriveInitializer自动派生
		var podBuff:PodBuff = new PodBuff("行走X速度", BuffCalculationType.ADD, 单位._摇滚速度累计);
		var metaBuff:MetaBuff = new MetaBuff([podBuff], [], 0);
		单位.buffManager.addBuff(metaBuff, "摇滚速度");
	}
};

/**
 * 摇滚公园单位 - 攻击力提升（BuffManager版）
 *
 * 【效果】
 * 通过BuffManager提升单位的空手攻击力
 *
 * 【实现】
 * 使用固定ID "摇滚攻击" 的buff，每次调用累加增量并替换旧buff
 * 累计增量存储在 单位._摇滚攻击累计 属性中
 *
 * 【前置条件】
 * 需要单位定义 基本空手攻击力 属性，否则增益不生效
 *
 * @param 单位 目标单位（通常是 _parent）
 * @param 百分比增量 相对于基础攻击力的增量百分比，例如0.1表示增加10%基础攻击力
 * @param 上限倍率 相对于基础攻击力的上限倍率，默认为5
 */
_root.敌人函数.摇滚攻击提升 = function(单位:MovieClip, 百分比增量:Number, 上限倍率:Number):Void {
	if (isNaN(百分比增量)) 百分比增量 = 0.1;
	if (isNaN(上限倍率)) 上限倍率 = 5;

	// 初始化累计值
	if (isNaN(单位._摇滚攻击累计)) 单位._摇滚攻击累计 = 0;

	// 计算本次增量和上限
	var 增量:Number = 单位.基本空手攻击力 * 百分比增量;
	var 累计上限:Number = 单位.基本空手攻击力 * (上限倍率 - 1); // 上限倍率转换为累加上限

	// 累加但不超过上限
	if (单位._摇滚攻击累计 < 累计上限) {
		单位._摇滚攻击累计 = Math.min(单位._摇滚攻击累计 + 增量, 累计上限);

		// 创建并应用buff（同ID自动替换）
		var podBuff:PodBuff = new PodBuff("空手攻击力", BuffCalculationType.ADD, 单位._摇滚攻击累计);
		var metaBuff:MetaBuff = new MetaBuff([podBuff], [], 0);
		单位.buffManager.addBuff(metaBuff, "摇滚攻击");
	}
};

/**
 * 摇滚公园单位 - 防御力提升（BuffManager版）
 *
 * 【效果】
 * 通过BuffManager提升单位的防御力
 *
 * 【实现】
 * 使用固定ID "摇滚防御" 的buff，每次调用累加增量并替换旧buff
 * 累计增量存储在 单位._摇滚防御累计 属性中
 *
 * 【前置条件】
 * 需要单位定义 基本防御力 属性，否则增益不生效
 *
 * @param 单位 目标单位（通常是 _parent）
 * @param 百分比增量 相对于基础防御力的增量百分比，例如0.05表示增加5%基础防御力
 * @param 上限倍率 相对于基础防御力的上限倍率，默认为10
 */
_root.敌人函数.摇滚防御提升 = function(单位:MovieClip, 百分比增量:Number, 上限倍率:Number):Void {
	if (isNaN(百分比增量)) 百分比增量 = 0.05;
	if (isNaN(上限倍率)) 上限倍率 = 10;

	// 初始化累计值
	if (isNaN(单位._摇滚防御累计)) 单位._摇滚防御累计 = 0;

	// 计算本次增量和上限
	var 增量:Number = 单位.基本防御力 * 百分比增量;
	var 累计上限:Number = 单位.基本防御力 * (上限倍率 - 1); // 上限倍率转换为累加上限

	// 累加但不超过上限
	if (单位._摇滚防御累计 < 累计上限) {
		单位._摇滚防御累计 = Math.min(单位._摇滚防御累计 + 增量, 累计上限);

		// 创建并应用buff（同ID自动替换）
		var podBuff:PodBuff = new PodBuff("防御力", BuffCalculationType.ADD, 单位._摇滚防御累计);
		var metaBuff:MetaBuff = new MetaBuff([podBuff], [], 0);
		单位.buffManager.addBuff(metaBuff, "摇滚防御");
	}
};

/**
 * 摇滚公园单位 - 韧性提升（降低被击硬直）
 * 【已废弃】此函数保留但不再被调用，以降低前期难度
 *
 * 【效果】
 * 降低单位的被击硬直度，使其更难被打断
 *
 * 【前置条件】
 * 需要单位定义 基本被击硬直度 属性，否则增益不生效（保持原始行为）
 *
 * @param 单位 目标单位（通常是 _parent）
 * @param 减少量 每次调用减少的硬直度，默认为8
 * @param 下限倍率 相对于基本被击硬直度的下限倍率，默认为0.2（即最低降到基础的1/5）
 */
_root.敌人函数.摇滚韧性提升 = function(单位:MovieClip, 减少量:Number, 下限倍率:Number):Void {
	if (!单位) return;
	// 前置条件：需要定义 基本被击硬直度 才能计算下限，否则提前退出（保持原始行为）
	if (isNaN(单位.基本被击硬直度)) return;

	if (isNaN(减少量)) 减少量 = 8;
	if (isNaN(下限倍率)) 下限倍率 = 0.2;

	var 硬直下限:Number = 单位.基本被击硬直度 * 下限倍率;

	if (单位.被击硬直度 > 硬直下限) {
		单位.被击硬直度 -= 减少量;
	}
};

/**
 * 摇滚公园单位 - 综合战斗增益
 * 【已废弃】此函数保留但不建议使用，推荐使用角色专属函数
 *
 * 【效果】
 * 同时提升速度和攻击力（韧性提升已移除以降低前期难度）
 * 用于攻击动画中的常规增益帧
 *
 * @param 单位 目标单位（通常是 _parent）
 * @param 攻击增量 攻击力增量百分比，默认0.1
 * @param 显示特效 是否显示特效，默认true
 */
_root.敌人函数.摇滚战斗增益 = function(单位:MovieClip, 攻击增量:Number, 显示特效:Boolean):Void {
	if (!单位) return;
	if (isNaN(攻击增量)) 攻击增量 = 0.1;
	if (显示特效 == undefined) 显示特效 = true;

	// 速度提升
	_root.敌人函数.摇滚速度提升(单位, 1, 2);

	// 韧性提升 - 已移除以降低前期难度
	// _root.敌人函数.摇滚韧性提升(单位, 8, 0.2);

	// 攻击力提升
	_root.敌人函数.摇滚攻击提升(单位, 攻击增量, 5);

	// 特效
	if (显示特效) {
		_root.效果("天蓝增幅", 单位._x, 单位._y, 100);
	}
};

/**
 * 摇滚公园单位 - 灯光增幅（概率触发的防御+攻击增益）
 *
 * 【效果】
 * 以一定概率提升防御力和攻击力
 * 用于攻击动画中的特殊增益帧
 *
 * @param 单位 目标单位（通常是 _parent）
 * @param 触发概率 触发概率（0-100），默认50
 * @param 防御增量 防御力增量百分比，默认0.05
 * @param 攻击增量 攻击力增量百分比，默认0.1
 * @param 防御上限倍率 防御力上限倍率，默认10
 */
_root.敌人函数.摇滚灯光增幅 = function(单位:MovieClip, 触发概率:Number, 防御增量:Number, 攻击增量:Number, 防御上限倍率:Number):Void {
	if (!单位) return;
	if (isNaN(触发概率)) 触发概率 = 50;
	if (isNaN(防御增量)) 防御增量 = 0.05;
	if (isNaN(攻击增量)) 攻击增量 = 0.1;
	if (isNaN(防御上限倍率)) 防御上限倍率 = 10;

	if (random(100) < 触发概率) {
		_root.敌人函数.摇滚防御提升(单位, 防御增量, 防御上限倍率);
		_root.敌人函数.摇滚攻击提升(单位, 攻击增量, 5);
		_root.效果("灯光增幅", 单位._x, 单位._y, 100);
	}
};

/**
 * 摇滚公园单位 - 集体加血（范围治疗）
 *
 * 【效果】
 * 以一定概率为范围内的友方单位恢复血量
 *
 * @param 单位 施法单位（通常是 _parent）
 * @param 治疗类型 治疗函数类型："主唱集体加血" | "主唱集体加血2" | "键盘集体加血"
 * @param 触发概率 触发概率（0-100），默认50，传入100表示必定触发
 * @param 范围X 治疗范围X，默认900
 * @param 范围Y 治疗范围Y，默认600
 */
_root.敌人函数.摇滚集体加血 = function(单位:MovieClip, 治疗类型:String, 触发概率:Number, 范围X:Number, 范围Y:Number):Void {
	if (!单位) return;
	if (!治疗类型) 治疗类型 = "主唱集体加血2";
	if (isNaN(触发概率)) 触发概率 = 50;
	if (isNaN(范围X)) 范围X = 900;
	if (isNaN(范围Y)) 范围Y = 600;

	if (random(100) < 触发概率) {
		// 直接调用 _范围治疗 并传入正确的 caster
		// 不能用 call 调用原函数，因为原函数内部使用 _parent 引用施法者
		// 而 _parent 在函数定义作用域解析，不会被 call 改变
		var 恢复比例:Number;
		var 特效名:String = "猩红增幅";

		switch(治疗类型) {
			case "主唱集体加血":
				恢复比例 = 0.03;
				break;
			case "主唱集体加血2":
				恢复比例 = 0.02;
				break;
			case "键盘集体加血":
				恢复比例 = 0.05;
				break;
			default:
				恢复比例 = 0.02;
		}

		_root.加血动作._范围治疗(单位, 范围X, 范围Y, 恢复比例, true, 特效名);
		_root.服务器.发布服务器消息("加血触发", 单位._name, 治疗类型);
	}
};

// ==================== 角色专属增益函数 ====================
// 根据策划设计，各角色有不同的职能分工：
// - 萝莉(吉他)：主攻防增益
// - 御姐(主唱)：主回血
// - 少女(键盘)：主速度增益

/**
 * 萝莉(吉他) - 攻防增益
 *
 * 【效果】
 * 提升攻击力和防御力，显示灯光增幅特效
 *
 * @param 单位 目标单位（通常是 _parent）
 * @param 攻击增量 攻击力增量百分比，默认0.1
 * @param 防御增量 防御力增量百分比，默认0.05
 */
_root.敌人函数.吉他攻防增益 = function(单位:MovieClip, 攻击增量:Number, 防御增量:Number):Void {
	if (!单位) return;
	if (isNaN(攻击增量)) 攻击增量 = 0.1;
	if (isNaN(防御增量)) 防御增量 = 0.05;

	_root.敌人函数.摇滚攻击提升(单位, 攻击增量, 5);
	_root.敌人函数.摇滚防御提升(单位, 防御增量, 10);
	_root.效果("灯光增幅", 单位._x, 单位._y, 100);
};

/**
 * 少女(键盘) - 速度增益
 *
 * 【效果】
 * 提升移动速度，显示天蓝增幅特效
 *
 * @param 单位 目标单位（通常是 _parent）
 * @param 增量 速度增量，默认1
 */
_root.敌人函数.键盘速度增益 = function(单位:MovieClip, 增量:Number):Void {
	if (!单位) return;
	if (isNaN(增量)) 增量 = 1;

	_root.敌人函数.摇滚速度提升(单位, 增量, 2);
	_root.效果("天蓝增幅", 单位._x, 单位._y, 100);
};

/**
 * 御姐(主唱) - 回血增益
 *
 * 【效果】
 * 为范围内友方单位回复血量
 *
 * @param 单位 施法单位（通常是 _parent）
 * @param 触发概率 触发概率（0-100），默认50
 */
_root.敌人函数.主唱回血增益 = function(单位:MovieClip, 触发概率:Number):Void {
	if (!单位) return;
	if (isNaN(触发概率)) 触发概率 = 50;

	_root.敌人函数.摇滚集体加血(单位, "主唱集体加血2", 触发概率, 900, 600);
};
