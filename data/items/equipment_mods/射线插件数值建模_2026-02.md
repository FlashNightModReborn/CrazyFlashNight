# 射线插件数值建模

日期: 2026-02-28

## 1. 建模前提

### 1.1 发射器弹药基线

发射器弹药**默认无属性加成**(无魔法/无破击)。伤害段数模型:

| 目标数 | 段数 | 总裸伤(D) |
|--------|------|-----------|
| 1 | 3 | 3D |
| 2 | 3+2 | 5D |
| 3 | 3+2+2 | 7D |
| 4(上限) | 3+2+2+2 | 9D |

- 第1个目标: 3段命中
- 后续每目标: 2段
- 期望炸2个, 最多3-4个

### 1.2 射线基础

射线严格**1段命中**。属性加成由插件赋予:
- 魔法 = ×2.0 独立乘区
- 破击 = ×1.15 独立乘区

### 1.3 瞄准难度系数

本节命中率来自 `ray_hitrate_validation.py` 的 Monte Carlo 仿真（复现 `BulletQueueProcessor.as` 的射线命中检测 + `EnemyBehavior.as/CombatModule.as` 的敌群空间分布假设）。

**等效常数命中率（额外目标，k取平均）**

| 模式 | 文档旧假设 | 仿真等效 | 偏差 |
|------|------------|----------|------|
| pierce(穿透) | 0.95 | 0.81 | -14.4% |
| chain(连锁) | 0.75 | 0.753 | +0.4% |
| fork(分裂) | 0.85 | 0.63 | -25.8% |

**逐级条件命中率（关键差异）**
> 定义：`aim_k = P(H≥k+1 | H≥k)`，H为总命中数（含主命中）。建模中仍取主命中=1.0（玩家主动瞄准）。

- pierce（波能/热能）: k=1..5 → 0.933, 0.854, 0.807, 0.757, 0.718（深层命中递减）
- chain（磁暴）: k=1..5 → 0.770, 0.742, 0.752, 0.752, 0.748（近似常数）
- fork（光棱/辉光）: k=1..5 → 0.882, 0.743, 0.662, 0.604, 0.264（第5层后“断崖式”衰减）

结论（难度排序）：**pierce(最易) > chain(中等) > fork(最难)**。

### 1.4 插件伤害乘数公式

```
最终威力 = base × (delta + pct/100) × (1 + mult/100) × dtype_mult
delta = 1 + 0.01 × (强化等级-1) × (强化等级+4)
```

常用delta值: Lv5=1.36, Lv7=1.66, Lv9=2.04, Lv13=3.04

## 2. 射线参数一览

### 2.1 插件层 (高等材料_枪械专用.xml)

| 射线 | pct | mult | 属性 | clipSize | 回本点 | 定位 |
|------|-----|------|------|----------|--------|------|
| 热能 | 0 | 45 | 破击×1.15 | +35% | 全等级恒定×1.45 | 破击前期暴力 |
| 磁暴 | 17 | 2 | 魔法×2.0 | - | ~Lv5 | 泛用连锁 |
| 光棱 | 14 | 4 | 魔法×2.0 | - | Lv5 | 精准分裂 |
| 光谱 | 14 | 4 | 魔法×2.0 | - | Lv5 | =光棱致敬(RA2/RA3) |
| 辉光 | 13 | 4 | 魔法×2.0 | - | ~Lv7 | 超远覆盖 |
| 涡旋 | 8 | 7 | 魔法×2.0 | - | ~Lv7 | 大面积撕裂 |
| 谐振波 | 4 | 7 | 魔法×2.0 | 电力→满血暴击 | ~Lv10 | 无电力可用,电力解锁暴击 |
| 等离子 | 2 | 9 | 魔法×2.0 | - | ~Lv9 | 全能全模式 |
| 波能 | 0 | 10 | 魔法×2.0 | - | ~Lv9 | 极致后期 |

### 2.2 子弹层 (bullets_cases.xml)

| 射线 | rayMode | pierceLimit | falloff | 特色 |
|------|---------|-------------|---------|------|
| 热能 | pierce | 6 | 1.00 | 高穿透无衰减, 最远射程1200 |
| 磁暴 | chain | 10 | 0.80 | 纯连锁, 高弹跳次数 |
| 光棱 | fork | 8 | 0.65 | 纯分裂, 高分裂数 |
| 光谱 | chain,fork | 5 | 0.60 | 弹跳后分裂 |
| 辉光 | fork | 5 | 0.60 | 分裂+超远射程1100 |
| 涡旋 | fork,pierce | 6 | 0.70 | 穿透逐节点分裂 |
| 谐振波 | chain,pierce | 6 | 0.70 | 穿透逐节点连锁 |
| 等离子 | chain,fork,pierce | 4 | 0.85 | 全模式, pierceLimit最低 |
| 波能 | pierce | 6 | 0.95 | 纯穿透, 贯穿一切 |

## 3. 伤害模型

### 3.1 射线多目标伤害计算

记号：`K = min(targets, pierceLimit)`，`aim_k = P(H≥k+1 | H≥k)`。

**pierce / chain（累积衰减）**
```
p1 = 1.0
p(k+1) = p(k) × aim_k
E[seg] = sum( falloff^i × p(i+1)  for i in 0..K-1 )
```

**fork（不累积衰减，所有折射子射线同倍率）**
> 代码口径：fork 的每条子射线伤害倍率恒为 `falloff`（不随 fork 序号继续衰减）。
```
p1 = 1.0
p(k+1) = p(k) × aim_k
E[seg] = 1.0 + falloff × sum( p(k)  for k in 2..K )
       = 1.0 + falloff × E[H-1]
```

**组合模式（按当前实现）**
- 组合模式共享预算：`budget = pierceLimit`（所有 pierce/chain/fork 命中都消耗同一预算）
- `hasPierce` → **per-node 管道**：沿 pierce 命中点逐节点结算；每个节点命中后倍率先进入下一档（×falloff），再触发 chain（逐跳累积衰减）与 fork（全部同倍率），直到预算耗尽
- `!hasPierce`（如 chain+fork）→ **per-phase 管道**：主命中后先 chain（第1跳倍率=falloff 且逐跳累积衰减），再用剩余预算 fork（倍率恒为 falloff，不继承 chain 深层倍率）

### 3.2 暴击乘区（谐振波专属, 电力 tagSwitch 解锁）

谐振波为唯一不硬性要求电力的射线（与涡旋相同），暴击通过 `tagSwitch` 条件解锁：

**基础版 + 电力**: `criticalhit=30`（30% 概率 ×1.5, 期望 ×1.15）
- 无条件稳定增益, 所有命中均独立判定

**强化版 + 电力**: `criticalhit=满血暴击`
- `ShootInitCore.createCritLogic`: 当 `hitTarget.hp >= hitTarget.hp满血值` 时 ×1.5
- 判定 per-hit per-target：per-node 管道中每次命中独立判定
- 首发对全满血群体 → 所有命中均 ×1.5（等效全伤害 ×1.5）
- 后续射击目标已受伤 → ×1.0（无加成）

**无电力时**: 无暴击, 纯 pct/mult 数值输出（仍可使用, 但无特色加成）

### 3.3 效率公式

```
效率 = 射线总伤 / 发射器裸总伤
     = [段数系数 × 插件乘数 × 属性乘数] / [发射器段数]
```
谐振波(电力+满血暴击)首发: 效率 ×1.5

## 4. 建模结果

### 4.1 全射线效率表 (vs 发射器裸伤害)

**Lv5 (delta=1.36)**

| 射线 | 模式 | 1T | 2T | 3T | 4T | 5T | 6T | 8T |
|------|------|-----|-----|-----|-----|-----|-----|-----|
| 发射器 | 3+2+2+2 | 3D | 5D | 7D | 9D | 9D | 9D | 9D |
| 热能 | pierce | 56% | 64% | 65% | 62% | 72% | 78% | 78% |
| 磁暴 | chain | 77% | 74% | 64% | 56% | 59% | 61% | 63% |
| 光棱 | fork | 76% | 72% | 66% | 58% | 62% | 64% | 64% |
| 光谱 | chain+fork | 76% | 73% | 65% | 58% | 64% | 64% | 64% |
| 辉光 | fork | 76% | 70% | 63% | 55% | 59% | 59% | 59% |
| 涡旋 | fork+pierce | 76% | 77% | 76% | 74% | 88% | 100% | 100% |
| 谐振波 | chain+pierce | 74% | 75% | 69% | 63% | 72% | 79% | 79% |
| 谐振波(电力+满血) | ×1.5 | **111%** | **112%** | **104%** | **95%** | **108%** | **118%** | **118%** |
| 等离子 | c+f+p | 74% | 82% | 83% | 82% | 82% | 82% | 82% |
| 波能 | pierce | 73% | 83% | 82% | 77% | 87% | 93% | 93% |

**Lv7 (delta=1.66)**

| 射线 | 模式 | 1T | 2T | 3T | 4T | 5T | 6T | 8T |
|------|------|-----|-----|-----|-----|-----|-----|-----|
| 发射器 | 3+2+2+2 | 3D | 5D | 7D | 9D | 9D | 9D | 9D |
| 热能 | pierce | 56% | 64% | 65% | 62% | 72% | 78% | 78% |
| 磁暴 | chain | 75% | 72% | 63% | 55% | 58% | 60% | 62% |
| 光棱 | fork | 75% | 71% | 64% | 57% | 61% | 63% | 63% |
| 光谱 | chain+fork | 75% | 71% | 64% | 57% | 63% | 63% | 63% |
| 辉光 | fork | 75% | 69% | 62% | 54% | 58% | 58% | 58% |
| 涡旋 | fork+pierce | 75% | 76% | 75% | 74% | 87% | 99% | 99% |
| 谐振波 | chain+pierce | 73% | 74% | 68% | 64% | 71% | 78% | 78% |
| 谐振波(电力+满血) | ×1.5 | **110%** | **111%** | **102%** | **96%** | **107%** | **117%** | **117%** |
| 等离子 | c+f+p | 74% | 82% | 82% | 82% | 82% | 82% | 82% |
| 波能 | pierce | 73% | 83% | 82% | 77% | 87% | 93% | 93% |

**Lv9 (delta=2.04)**

| 射线 | 模式 | 1T | 2T | 3T | 4T | 5T | 6T | 8T |
|------|------|-----|-----|-----|-----|-----|-----|-----|
| 发射器 | 3+2+2+2 | 3D | 5D | 7D | 9D | 9D | 9D | 9D |
| 热能 | pierce | 56% | 64% | 65% | 62% | 72% | 78% | 78% |
| 磁暴 | chain | 74% | 71% | 62% | 54% | 57% | 59% | 61% |
| 光棱 | fork | 74% | 70% | 63% | 56% | 61% | 62% | 62% |
| 光谱 | chain+fork | 74% | 70% | 63% | 56% | 62% | 62% | 62% |
| 辉光 | fork | 74% | 68% | 61% | 54% | 58% | 58% | 58% |
| 涡旋 | fork+pierce | 74% | 75% | 75% | 73% | 86% | 98% | 98% |
| 谐振波 | chain+pierce | 73% | 74% | 69% | 63% | 71% | 78% | 78% |
| 谐振波(电力+满血) | ×1.5 | **109%** | **110%** | **103%** | **94%** | **106%** | **116%** | **116%** |
| 等离子 | c+f+p | 73% | 81% | 82% | 82% | 82% | 82% | 82% |
| 波能 | pierce | 73% | 83% | 82% | 77% | 87% | 93% | 93% |

### 4.2 对群增长斜率 (6T/1T, Lv7)

| 排名 | 射线 | 6T/1T | 1T绝对值 | 6T绝对值 | 模式 |
|------|------|-------|----------|----------|------|
| 1 | 热能 | 4.21x | 1.67D | 7.02D | pierce |
| 2 | 涡旋 | 3.96x | 2.24D | 8.87D | fork+pierce |
| 3 | 波能 | 3.82x | 2.20D | 8.41D | pierce |
| 4 | 等离子 | 3.34x | 2.21D | 7.36D | c+f+p |
| 5 | 谐振波 | 3.21x | 2.19D | 7.02D | chain+pierce |
| 6 | 光谱 | 2.53x | 2.26D | 5.70D | chain+fork |
| 7 | 光棱 | 2.50x | 2.26D | 5.63D | fork |
| 8 | 磁暴 | 2.39x | 2.25D | 5.39D | chain |
| 9 | 辉光 | 2.34x | 2.24D | 5.25D | fork |

## 5. 设计分析

### 5.1 三个阵营

数据揭示射线按对群增长能力自然分为三个阵营:

**A. pierce主轴系 (6T/1T ≥ 3.2x)**
- 热能(4.21x)、涡旋(3.96x)、波能(3.82x)、等离子(3.34x)、谐振波(3.21x)
- 特征: 主轴穿透提供稳定的独立衰减叠加, 目标越多收益越高
- 6T效率普遍 78-99%
- 涡旋/谐振波无电力硬需求；谐振波电力解锁满血暴击(首发burst ×1.5)

**B. chain/fork系 (6T/1T ≈ 2.3–2.6x)**
- 光谱(2.53x)、光棱(2.50x)、磁暴(2.39x)、辉光(2.34x)
- 特征: chain 以 falloff 累积衰减；fork 以深层命中率断崖衰减；整体后续目标边际收益低
- 6T效率 58-63%

**C. 热能特殊位 (最高增长但最低基础)**
- 1T只有56%(破击×1.15), 远低于魔法系的73-76%
- 但6T/1T增长4.21x为全场最高, 加上弹容+35%补偿

### 5.2 对单弱化验证

| 射线 | 1T效率 | 弱化来源 |
|------|--------|----------|
| 热能 | 56% | 破击×1.15 vs 魔法×2.0 |
| 魔法射线 | 73-75% | 魔法×2.0, 但仍不到发射器(3段=100%) |
| 谐振波(电力+满血) | **109-111%** | 首发满血暴击×1.5突破100%, 后续回落至73% |

结论: **持续输出下所有射线对单都弱于发射器**, 这符合"射线=对群武器"的基本定位。
例外: 谐振波(电力+满血暴击)首发可达109-111%, 但仅限首击全满血目标, 后续射击回落至73%。
热能进一步弱于其他射线, 用穿透深度+弹容换回来。

### 5.3 瞄准难度 vs 回报

| 难度 | 代表 | 4T效率 | 6T效率 | 结论 |
|------|------|--------|--------|------|
| 最易(pierce) | 波能 | 77% | 93% | 最稳定, 效率最高 |
| 中等(chain) | 磁暴 | 55% | 60% | 逐级命中近似常数, 回报中等 |
| 最难(fork) | 光棱 | 57% | 63% | 深层命中衰减陡峭, 但每条折射不累积衰减 |
| 组合(p+f) | 涡旋 | 74% | 99% | per-node下fork优先吃预算, 上限最高 |
| 组合(p+c) | 谐振波 | 64% | 78% | pierce保底, chain补覆盖; 电力→满血暴击burst |
| 全量(p+c+f) | 等离子 | 82% | 82% | 预算最少, 质量>数量(高falloff) |

瞄准难度与回报的关系:
- **pierce最易瞄准, 效率也最高** — 这是合理的, 因为pierce的"高效率"需要敌人排成线, 这本身就是一种"瞄准需求"
- **fork最难吃满预算** — 深层目标稀缺导致断崖式衰减，但单条折射不继续衰减，成功时回报更高
- **chain居中** — 逐级命中更稳定，但衰减累乘导致后续收益递减明显

### 5.4 热能弹容补偿 (pierce=6, falloff=1.00, +35%弹容)

每弹仓DPS对比 (Lv7, 发射器基线=弹容×5D×期望2目标):

| 弹容 | 射线弹容 | 发射器/弹仓 | 射线1T | 射线2T | 射线3T |
|------|---------|------------|--------|--------|--------|
| 3→4 | +1 | 15.0D | 6.7D (45%) | 12.8D (85%) | 18.2D (**121%**) |
| 4→5 | +1 | 20.0D | 8.4D (42%) | 16.0D (80%) | 22.8D (**114%**) |
| 5→6 | +1 | 25.0D | 10.1D (40%) | 19.2D (77%) | 27.3D (**109%**) |
| 6→8 | +2 | 30.0D | 13.4D (45%) | 25.6D (85%) | 36.4D (**121%**) |

结论: 热能射线在穿透3个目标时, 每弹仓总伤即可**超越发射器**(109-121%)。

### 5.5 光棱修正记录

光棱 falloff 从 0.50 调整为 0.65:

| 指标 | 修正前(0.50) | 修正后(0.65) |
|------|-------------|-------------|
| 1T | 75% | 75% (不变) |
| 2T | 65% | 71% (+6%) |
| 3T | 57% | 64% (+7%) |
| 4T | 50% | 57% (+7%) |
| 6T | 54% | 63% (+9%) |

修正前光棱4T≈50%为偏弱档位, 高pierceLimit=8被低falloff限制了上限。
修正后4T/6T效率进入60%档, 分裂数量优势开始有实际意义。

### 5.6 谐振波身份重塑：电力 tagSwitch 暴击

**问题**: 谐振波(chain+pierce)与涡旋(fork+pierce)插件层完全同质(原pct=8, mult=7)，
chain per-node 严格劣于 fork per-node（6T: 80% vs 99%），无独立身份。

**方案**: 电力 tagSwitch 条件暴击 + 降低基础数值(pct 8→4)

| 维度 | 涡旋 | 谐振波(无电力) | 谐振波(有电力) |
|------|------|---------------|---------------|
| 电力需求 | 无 | 无 | tagSwitch解锁 |
| pct/mult | 8/7 | 4/7 | 4/7 |
| 暴击 | 无 | 无 | 满血暴击×1.5 |
| 1T Lv7 | 75% | 73% | 73%(持续) / 110%(burst) |
| 6T Lv7 | 99% | 78% | 78%(持续) / 117%(burst) |

**设计梯度**（电力依赖递增）:
1. 涡旋 = 完全独立，无电力需求，无电力收益
2. 谐振波 = 独立可用，电力可选解锁暴击
3. 其他射线 = 电力硬性门票

**基础版→强化版升级路径**:
- 基础版 + 电力: criticalhit=30（30%随机暴击, 期望×1.15, 稳定增益）
- 强化版 + 电力: 满血暴击（确定性×1.5, 条件触发, 需读血量择时）
- 升级感: 随机暴击 → 条件暴击 = 机制质变, 非数值堆叠

## 6. 总结

### 6.1 设计目标达成情况

| 目标 | 状态 | 说明 |
|------|------|------|
| 持续对单弱于发射器 | ✓ | 最高77%(磁暴Lv5), 最低56%(热能); 谐振波(电力+满血)首发109-111%但不可持续 |
| 特定分布下对群有优势 | ✓ | pierce主轴系6T可达78-99%, 弹容补偿后3T即超越 |
| 穿透最易瞄准 | ✓ | pierce系效率最高且最稳定 |
| 连锁次之 | ✓ | chain逐级命中稳定, 但衰减累乘导致回报中等 |
| 分裂最难 | ✓ | fork深层命中断崖式衰减, 但单条折射不累积衰减 |
| 热能=前期暴力+弱对单 | ✓ | 1T=56%全场最低, 但6T/1T=4.21x全场最高 |
| 谐振波有独立身份 | ✓ | 电力tagSwitch暴击, 涡旋/谐振波无电力梯度, burst vs sustain分化 |

### 6.2 修改清单

**第一轮 (6d1b80a): 建模假设修正**

| 文件 | 修改 | 理由 |
|------|------|------|
| bullets_cases.xml | 热能射线-强化: pierceLimit 4→6, falloff 0.82→0.90 | 拉大穿透深度, 让对群增长曲线更长 |
| bullets_cases.xml | 光棱射线-强化: falloff 0.50→0.65 | 修正4T=44%全场最弱的问题 |
| 高等材料_枪械专用.xml | 热能射线弹-强化: pct=0 mult=45 clipSize=35 | 纯独立乘区+弹容补偿 |
| 高等材料_枪械专用.xml | 注释块同步更新 | 记录设计意图和关键数据 |

**第二轮 (353e896): 按+5/+7/+9三档严格对齐回本节点**

| 文件 | 修改 | 理由 |
|------|------|------|
| 高等材料_枪械专用.xml | 磁暴: pct 16→17, mult 3→2 | 回本从~Lv4对齐到~Lv5 |
| 高等材料_枪械专用.xml | 辉光: pct 12→13, mult 5→4 | 回本从~Lv6对齐到~Lv7 |
| 高等材料_枪械专用.xml | 涡旋: pct 13→8, mult 4→7 | 保持~Lv7回本, 拉大后期优势斜率 |
| 高等材料_枪械专用.xml | 谐振波: pct 10→8, mult 6→7 | 保持~Lv7回本, 拉大后期优势斜率 |
| 高等材料_枪械专用.xml | 等离子: pct 9→2, mult 6→9 | 回本从~Lv8对齐到~Lv9, 强化后期定位 |
| 高等材料_枪械专用.xml | 波能: pct 8→0, mult 8→10 | 回本从~Lv6对齐到~Lv9, pct=0使效率等级无关 |
| 高等材料_枪械专用.xml | 基础版全部同步调整 | 基础版回本节点与强化版对齐 |

**第三轮 (2026-02-28): 命中率仿真后重算与再平衡**

| 文件 | 修改 | 理由 |
|------|------|------|
| bullets_cases.xml | 磁暴射线-强化: falloff 0.70→0.80 | chain逐级命中下对群偏弱，提高后续段质量 |
| bullets_cases.xml | 光谱射线-强化: falloff 0.65→0.60 | chain+fork 组合在新模型下偏强，回调至与光棱接近 |
| bullets_cases.xml | 热能射线-强化: falloff 0.90→1.00 | pierce深层命中递减明显，用无衰减补偿穿透收益 |
| bullets_cases.xml | 涡旋射线-强化: falloff 0.75→0.70 | per-node fork+pierce 上限偏高，压回 |
| bullets_cases.xml | 波能射线-强化: falloff 0.80→0.95 | pierce等效命中率下降，抬高后期穿透价值 |
| bullets_cases.xml | 等离子射线-强化: falloff 0.75→0.85 | 预算最少但全模式，提高每段质量（质量>数量） |
| ray_hitrate_validation.py | 同步 bullets_cases.xml falloff | 保持仿真参数一致 |
| 射线插件数值建模_2026-02.md | 命中率模型 + 全表重算 | 反映当前实现与仿真结论 |

**第四轮 (2026-02-28): 谐振波身份重塑**

| 文件 | 修改 | 理由 |
|------|------|------|
| 高等材料_枪械专用.xml | 谐振波-强化: pct 8→4, 去accuracy=15 | 降低基础数值, 为暴击腾预算 |
| 高等材料_枪械专用.xml | 谐振波(两版): 去requireTags电力 | 与涡旋同级,无电力可用 |
| 高等材料_枪械专用.xml | 谐振波(两版): 去override满血暴击, 加tagSwitch电力 | 暴击由电力条件解锁 |
| 高等材料_枪械专用.xml | 谐振波基础版: tagSwitch→criticalhit=30 | 电力解锁30%随机暴击(期望×1.15) |
| 高等材料_枪械专用.xml | 谐振波强化版: tagSwitch→满血暴击 | 电力解锁确定性满血暴击(×1.5) |
| 射线插件数值建模_2026-02.md | §2-6全文档同步 | 反映电力tagSwitch暴击设计 |
