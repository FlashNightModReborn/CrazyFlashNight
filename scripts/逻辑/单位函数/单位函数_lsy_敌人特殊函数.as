//基因虫
_root.敌人函数.基因虫兵种库 = [
	{兵种:"敌人-普通改造僵尸", 身高:175, 权重:2},
	{兵种:"敌人-兽化改造僵尸", 身高:175, 权重:2},
	{兵种:"敌人-普通爆炸僵尸", 身高:175, 权重:3},
	{兵种:"敌人-蛙型仿生僵尸", 身高:160, 权重:3},
	{兵种:"敌人-boss大僵尸", 身高:175, 权重:4},
	{兵种:"敌人-重型改造僵尸", 身高:175, 权重:4},
	{兵种:"敌人-普通基因虫", 身高:140, 权重:5},
	{兵种:"敌人-普通尸母", 身高:290, 权重:6}
];
//这边代码非常硬，后面做别的随机刷怪就不要抄这个了
_root.敌人函数.基因虫生成僵尸 = function(){
	var 兵种库 = _root.敌人函数.基因虫兵种库;
	var 总权重 = Math.floor(this.身高 / 50); //自然刷新的基因虫身高在150-290之间，即权重在3-5之间
	var 最大权重 = 总权重 > 6 ? 6 : 总权重;
	var 目标权重 = Math.floor(2 + random(最大权重 - 1));//从最小权重2到最大权重(2-6)之间随机选取一个权重
	var 生成数量;
	if(目标权重 == 5) {
		生成数量 = Math.floor((总权重 - 1) / 2); //硬代码让随机到权重5（小型基因虫）时分裂成多个
	}else {
		生成数量 = Math.floor((总权重 - 1) / 目标权重);
	}
	if(生成数量 < 1) 生成数量 = 1;//最小生成数量为1
	else if(生成数量 > 5) 生成数量 = 5;//最大生成数量为5
	var 目标权重兵种库 = [];
	for(var i=0; i<兵种库.length; i++){
		if(兵种库[i].权重 == 目标权重) 目标权重兵种库.push(兵种库[i]);
	}
	var offset = 生成数量 * 8;
	var 名字 = "基因变身怪";
	var 是否为敌人 = this.是否为敌人;
	for(var i=0; i<生成数量; i++){
		var 目标兵种 = 目标权重兵种库[random(目标权重兵种库.length)];
		var shootX = this._x + random(2 * offset + 1) - offset;
		var shootY = this._y + random(2 * offset + 1) - offset;
		var 僵尸型敌人newname = this._name + 目标兵种.兵种 + i;
		_root.加载游戏世界人物(目标兵种.兵种,僵尸型敌人newname,_root.gameworld.getNextHighestDepth(),{_x:shootX, _y:shootY, 等级:等级, 名字:名字, 是否为敌人:是否为敌人, 身高:目标兵种.身高, 长枪:"", 手枪:"", 手枪2:"", 刀:"", 手雷:""});
	}
};

// ==================== 诺艾尔特殊函数 ====================

/**
 * 诺艾尔叠盾技能
 *
 * 【功能】
 * 为诺艾尔添加护盾，护盾期间：
 * - 获得刚体状态
 * - 防御力提升（基础防御力 + 基础防御力 * 等级 / 100）
 * - 伤害类型变为魔法-冲
 * - 护盾容量 = 满血值 * 10%
 *
 * 【边界处理】
 * - 重复施放：清空旧盾后添加新盾（重置而非叠层）
 * - 护盾破碎：自动回滚所有状态
 * - 使用 clear() 而非 removeShieldById()，兼容单盾模式
 * - 回调中校验护盾ID，避免其他护盾源触发误回滚
 *
 * @param 单位 目标单位（通常是 _parent）
 */
_root.敌人函数.诺艾尔叠盾 = function(单位:MovieClip):Void {
	if (!单位 || !单位.shield) return;

	// _root.发布消息("诺艾尔叠盾技能施放，正在添加护盾...");

	// 状态回滚函数：统一处理护盾结束后的状态恢复
	// 闭包读取当前基础防御力，确保回滚到正确值
	var 回滚护盾状态 = function():Void {
		单位.盾._visible = 0;
		单位.防御力 = 单位.基础防御力;
		单位.伤害类型 = undefined;
		单位.魔法伤害属性 = undefined;
		单位.刚体 = false;
		单位.诺艾尔护盾ID = undefined;

		// _root.发布消息("诺艾尔护盾已破碎，状态已回滚。");
	};

	// 重复施放时清除旧护盾
	// 使用 clear() 而非 removeShieldById()，因为单盾模式下后者不生效
	if (单位.诺艾尔护盾ID != undefined) {
		// 先回滚状态，再清空护盾
		// 这样可以避免 clear() 触发的回调（如果有的话）干扰
		回滚护盾状态();
		单位.shield.clear();
	}

	// 显示护盾视觉
	单位.盾._visible = 1;

	// 护盾期间的状态设置
	单位.刚体 = true;
	单位.防御力 = 单位.基础防御力 + 单位.基础防御力 * 单位.等级 / 100;
	单位.伤害类型 = "魔法";
	单位.魔法伤害属性 = "冲";

	// 计算护盾容量（10%满血值）
	var 护盾容量:Number = 单位.hp满血值 * 0.1;

	// 添加临时护盾
	// strength = Infinity 表示无强度限制（兼容原始行为）
	// duration = -1 表示永久（直到破碎）
	var 当前护盾ID:Number = _root.护盾函数.添加临时护盾(单位, 护盾容量, Infinity, -1, "诺艾尔护盾", {
		onBreak: function(shield):Void {
			// 校验护盾ID，防止其他护盾源触发误回滚
			// 只有当破碎的是当前诺艾尔护盾时才回滚
			if (单位.诺艾尔护盾ID == shield.getId()) {
				回滚护盾状态();
			}
		}
	});

	// 记录护盾ID
	单位.诺艾尔护盾ID = 当前护盾ID;
};

// ==================== 雪女特殊函数 ====================

/**
 * 雪女护盾初始化/重建
 *
 * 【护盾特性】
 * - 中强度：可挡住中等威力攻击的特殊效果（斩杀/吸血/击溃等）
 * - 低容量：容易被击破
 * - 可充能：受击后延迟回充，鼓励玩家持续施压
 * - 破碎行为：普通状态下破碎后清空护盾，进阶后破碎可自动回充
 *
 * 【数值设计】
 * - 容量：满血值 * 5%（低容量）
 * - 强度：防御力 + 等级 * 系数（普通2，进阶后5）
 * - 回充速度：每帧3.4%容量（约30帧充满）
 * - 回充延迟：30帧（1秒）
 *
 * 【使用场景】
 * - 初始化时调用：建立初始护盾
 * - 倒地起身时调用：重建护盾
 *
 * @param 单位 目标单位
 */
_root.敌人函数.雪女护盾 = function(单位:MovieClip):Void {
	if (!单位 || !单位.shield) return;

	// 先清空旧护盾（如果有）
	单位.shield.clear();

	// 护盾参数
	var 护盾容量:Number = 单位.hp满血值 * 0.1;    // 5%满血值
	var 已进阶:Boolean = 单位.宠物属性.晶能者;
	var 等级系数:Number = 已进阶 ? 5 : 2;          // 进阶后系数提升
	var 护盾强度:Number = 单位.防御力 + 单位.等级 * 等级系数;
	var 回充速度:Number = 护盾容量 * 0.034;        // 每帧3.4%容量（约30帧充满）
	var 回充延迟:Number = 30;                      // 30帧延迟（1秒）

	// 添加充能护盾
	// 普通状态：破碎时清空，只能通过倒地重建
	// 进阶后：破碎后可自动回充
	var callbacks:Object = 已进阶 ? null : {
		onBreak: function(shield):Void {
			单位.shield.clear();
		}
	};
	_root.护盾函数.添加充能护盾(单位, 护盾容量, 护盾强度, 回充速度, 回充延迟, "雪女冰盾", callbacks);
};
