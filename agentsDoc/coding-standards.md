# 编码规范与文档注释模板

> 本项目的编码约定，涵盖 AS2、Node.js、XML 和 PowerShell。

---

## 1. 三大语言原则

### 原则一：注释全部中文
- 所有代码注释（包括 class 文件和帧脚本）**必须使用中文**，方便所有协作者查看

### 原则二：class 文件（引擎级）— 英文命名
- class 文件视作**引擎级代码**，不考虑无编程背景的协作者
- 类名、方法名、变量名尽可能使用英文
- 在不涉及外部中文耦合的情况下，保持英文规范

### 原则三：_root 挂载函数（业务层）— 中文命名
- `_root` 上的函数是**功能业务层**，需兼顾无编程背景的协作者
- 函数名、参数名尽可能使用中文，保证其他协作者可以无障碍阅读并自行修改
- 例：`_root.发布消息(...)`、`_root.服务器.发布服务器消息(...)`

---

## 2. ActionScript 2.0 命名约定（class 文件）

- **类名**：PascalCase — `BulletFactory`、`FrameTimer`
- **方法/变量**：camelCase — `updatePosition`、`createBullet`
- **常量**：UPPER_CASE — `MAX_HEALTH`、`DEFAULT_SPEED`
- **私有成员**：下划线前缀 — `_privateVar`、`_health`
- **接口**：`I` 前缀 — `IMusicEngine`、`IMovable`
- **包路径**：严格遵循 `org.flashNight.[子包].[模块]` 命名空间

## 3. 双轨开发策略

代码分为两种路径，遵循完全不同的开发范式：

### 非热路径（UI、功能、业务逻辑）
- 按**现代软件开发最佳实践**管理
- 优先可读性、可维护性、清晰的抽象
- 正常的错误处理和防御式编程

### 热路径（引擎级核心组件）
遵循三条极限性能原则：

1. **契约大于防护**
   - 不做运行时防御检查，通过调用方契约保证输入合法
   - 尽可能通过形式化证明确认在契约下是安全的
   - AS2 VM 无 JIT，每条防御指令都是实打实的解释执行开销

2. **允许牺牲可读性换取极限性能**
   - 位运算替代常规算术
   - 宏注入（`#include`）实现编译期代码生成
   - 边界特性利用（如 NaN 行为、原型链特性）
   - 大范围内联展开与代码重复（优于函数调用开销）
   - 副作用语句压行触发 VM 寄存器优化（参阅 `naki/Sort/evalorder.md`）
   - 性能依据参阅 `agentsDoc/as2-performance.md`

3. **零 GC 导向**
   - 热路径零内存分配，避免触发 Flash GC 暂停导致掉帧
   - 对象复用、池化、预分配
   - 避免临时字符串拼接和临时对象创建

---

## 4. 代码组织

- 每个类一个文件，文件路径与包路径一致
- 测试文件放在对应目录的 `test/` 子目录下
- 帧脚本按功能分区：展现/引擎/通信/逻辑

## 5. JSDoc 风格文档注释

<!-- TODO: 从实际代码中提取典型的 JSDoc 示例作为模板 -->
<!-- 参考文件：scripts/类定义/org/flashNight/arki/bullet/Factory/BulletFactory.as -->

### 要求
- 所有公开类和方法必须包含 JSDoc 风格注释（**中文撰写**）
- 包含 `@class`、`@param`、`@returns`、`@type` 等标签
- 复杂算法需要描述实现思路

## 6. XML 配置文件规范

- 4空格缩进
- 属性值使用双引号
- 添加中文注释说明参数用途
- 保持结构层次清晰
- **注释保护**：通过代码处理 XML 进行数据迁移或批量修改时，必须检查 XML 中的中文注释是否被保留。许多 XML 解析器/序列化器会默认丢弃注释，需确保写回时注释完整

## 7. Node.js 编码规范

<!-- TODO: 从 tools/Local Server/ 现有代码中提炼规范 -->

- 遵循 Express 项目常规约定
- 使用 winston 进行结构化日志

## 8. 调试规范

- 详见 `agentsDoc/as2-anti-hallucination.md` 调试章节
- `trace()` 可在热路径使用（编译时剔除）
- `_root.发布消息`/`_root.服务器.发布服务器消息` 热路径测试后必须注释掉
