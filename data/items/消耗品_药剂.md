# 消耗品系统文档

本文档统一管理药剂、食品类消耗品的配置说明和数值平衡理论。

---

## 一、效果词条系统 (effects)

每个物品可配置多个效果词条，使用时按顺序执行。

### 1. type="heal" 即时恢复

立即恢复生命值或魔法值。

| 参数 | 说明 | 示例 |
|------|------|------|
| hp | 恢复的生命值 | `hp="100"` 或 `hp="20%"` |
| mp | 恢复的魔法值 | `mp="50"` |
| target | 作用目标 | `self`=自己, `group`=队伍全员 |
| scaleWithAlchemy | 是否受炼金术加成 | `"true"` |

```xml
<effect type="heal" hp="150" mp="50" target="self" scaleWithAlchemy="true"/>
```

### 2. type="regen" 缓释恢复

在一段时间内持续恢复生命值或魔法值。

| 参数 | 说明 | 示例 |
|------|------|------|
| hp | 总共恢复的生命值 | `hp="300"` |
| mp | 总共恢复的魔法值 | `mp="200"` |
| duration | 持续时间(帧)，30帧≈1秒 | `duration="900"` = 30秒 |
| interval | 每隔多少帧触发一次 | 默认30(每秒一次) |
| mode | `total`=先算炼金再分摊 / `perTick`=每次固定后算炼金 | 默认perTick |
| id | 缓释效果的唯一标识 | `id="药剂_缓释_HP"` |
| stack | `refresh`=刷新时间 / `stack`=叠加层数 | |
| scaleWithAlchemy | 是否受炼金术加成 | `"true"` |

```xml
<effect type="regen" hp="300" duration="600" interval="30" mode="total" id="药剂_缓释_HP" scaleWithAlchemy="true"/>
```

### 3. type="state" 状态修改

直接修改角色的某个状态属性。

| 参数 | 说明 | 示例 |
|------|------|------|
| key | 要修改的属性 | `key="淬毒"` |
| value | 修改的数值 | `value="100"` |
| operation | `set`=直接设置 / `add`=在原值基础上增加 | |
| scaleWithAlchemy | 是否受炼金术加成 | `"true"` |

```xml
<effect type="state" key="淬毒" value="100" scaleWithAlchemy="true"/>
```

### 4. type="purify" 净化效果

清除负面状态、debuff、麻痹值等。

| 参数 | 说明 | 示例 |
|------|------|------|
| value | 净化强度 | `value="50"` |
| scaleWithAlchemy | 是否受炼金术加成 | `"true"` |
| clearDebuffs | 清除以此前缀开头的所有debuff | `clearDebuffs="debuff_"` |

```xml
<effect type="purify" value="50" scaleWithAlchemy="true" clearDebuffs="debuff_"/>
```

### 5. type="buff" 属性增益/减益

为角色添加临时的属性修改效果。

| 参数 | 说明 | 示例 |
|------|------|------|
| property | 【必填】要修改的属性 | `"伤害加成"`, `"防御力"`, `"行走X速度"` |
| calc | 【必填】计算方式 | 见下方说明 |
| value | 【必填】修改的数值 | 正数为增益，负数为减益 |
| duration | 持续时间(帧) | `duration="1800"` = 60秒，不填=永久 |
| buffId | Buff的唯一标识 | 见下方命名规范 |
| stackable | 是否允许叠加多个实例 | 默认false |

#### calc 计算类型

| 类型 | 语义 | 说明 |
|------|------|------|
| **叠加型** | | |
| add | 加法累加 | 多个+50会变成+150 |
| multiply | 乘区相加 | 多个×1.2会变成×1.4(不是×1.44) |
| percent | 百分比相加 | 多个+20%会变成+40%(不是+44%) |
| **独占型** | | |
| add_positive | 正向加法 | 多个+50/+80/+100，只算+100 |
| add_negative | 负向加法 | 多个-20/-50/-30，只算-50 |
| mult_positive | 正向乘法 | 多个×1.3/×1.5/×1.2，只算×1.5 |
| mult_negative | 负向乘法 | 多个×0.8/×0.6/×0.7，只算×0.6 |
| **边界控制** | | |
| override | 强制覆盖 | 无视其他计算，直接设为此值 |
| max | 下限保底 | 结果不会低于此值 |
| min | 上限封顶 | 结果不会高于此值 |

**常用场景：**
- 药剂/食品增益 → `add_positive` (同类不叠加，只取最好的)
- 药剂/食品减益 → `add_negative` (只取最强的debuff)
- 叠层技能 → `add` (允许累加)
- 速度增益 → `mult_positive` (防止速度爆炸)
- 减速/减伤 → `mult_negative` (只取最强效果)

#### buffId 命名规范

| 类型 | 格式 | 示例 |
|------|------|------|
| 增益(buff) | 来源_属性名 | `药剂_伤害加成`, `食品_防御力`, `菜品_速度` |
| 减益(debuff) | **debuff_**来源_属性名 | `debuff_药剂_防御力`, `debuff_酒类_速度` |
| 不填buffId | | 每次使用都会创建新实例，可以叠加多个 |

> **重要**：减益必须以 `debuff_` 开头，净化效果才能正确清除！

```xml
<!-- 增益示例 -->
<effect type="buff" property="伤害加成" calc="add_positive" value="50" duration="1800" buffId="药剂_伤害加成"/>
<!-- 减益示例 -->
<effect type="buff" property="防御力" calc="add_negative" value="-20" duration="1800" buffId="debuff_药剂_防御力"/>
```

### 6. type="playEffect" 播放特效

| 参数 | 说明 |
|------|------|
| name | 特效资源名称 |
| offsetX | X轴偏移(可选) |
| offsetY | Y轴偏移(可选) |
| scale | 缩放比例(可选) |

```xml
<effect type="playEffect" name="药剂动画"/>
```

### 7. type="message" 发布消息

| 参数 | 说明 |
|------|------|
| text | 要显示的文字 |
| condition | 触发条件，如 `grantSuccess`=获得物品成功时才显示 |

```xml
<effect type="message" text="你感到力量涌入体内..." condition="grantSuccess"/>
```

### 8. type="grantItem" 获得物品

| 参数 | 说明 |
|------|------|
| name | 要获得的物品名称 |
| count | 获得数量，默认1 |
| chance | 获得概率(0-1) |

```xml
<effect type="grantItem" name="幻层残响" count="1"/>
```

### 9. type="global" 修改全局变量

| 参数 | 说明 |
|------|------|
| key | 全局变量的键名 |
| operation | `set`=直接设置 / `add`=增加 / `multiply`=乘以 |
| value | 操作的数值 |

```xml
<effect type="global" key="任务进度" operation="add" value="1"/>
```

---

## 二、数值平衡理论

### 0. 符号定义表（全局约定）

| 符号 | 名称 | 定义 | 取值 | 量纲 |
|------|------|------|------|------|
| **α** | buff战斗利用率 | buff持续时间内的有效战斗占比 | **5** | 无量纲 |
| **λ** | HoT缓释折价 | 延迟恢复的风险折扣 | **0.7** | 无量纲 |
| **τ** | 毒性折扣系数 | 负面效果对总价值的折损率 | 按效果定 | 无量纲 |

> **重要**：本文档所有公式统一使用上述符号，不再使用 β/γ 等未定义符号。

### 1. 基础属性换算比

基于装备体系的加权总分计算，定义统一换算单位 **StdHP（标准HP）**：

| 属性 | StdHP换算 | 说明 |
|------|----------|------|
| HP | ×1 | 基准单位 |
| MP | ×1 | 与HP等价 |
| 防御 | ×2 | 1防御 = 2 StdHP |
| 攻击 | ×3 | 1攻击 = 3 StdHP |

等价关系：
- **1 攻击 = 3 HP = 3 MP = 1.5 防御**
- **1 防御 = 2 HP = 2 MP = 0.67 攻击**
- **HP 与 MP 等价：1 HP = 1 MP**

### 2. 金币-StdHP 基准换算

核心基准（以 `消耗品_药剂.xml` 为标定）：

> **1 金币 ≈ 1 StdHP**（瞬间回复、self目标、标准档位）

即：`Gold_base ≈ StdHP_inst`

### 3. CD补偿函数（缓释规则）

药剂统一 4s CD，缓释效果通过额外CD换取更高总量：

```
m_cd(t) = 1 + 0.208795 × t^0.522879
```

锚点：
| 额外CD(秒) | 效能倍率 |
|-----------|---------|
| 0 | 1.0 |
| 2 | 1.3 |
| 20 | 2.0 |

### 4. 定价剖面（Pricing Profile）

#### 药剂定价

| 类型 | 公式 | 示例 |
|------|------|------|
| HP标准回复(self) | Gold = HP | 抗生素 500HP=500金 |
| MP标准回复(self) | Gold = MP | 普通mp药剂 100MP=100金 |
| 新手友好折扣 | Gold = 0.67 × StdHP | 普通hp药剂 150HP=100金 |
| MP高阶线 | Gold = 2.0~2.5 × MP | 肾上腺素/大MP药剂 |
| 群体回复(group) | Gold = 1.67~2.0 × StdHP | 粉尘/战队药箱 |
| 净化 | Gold = 120 × purify_value | 净化药剂 50=6000金 |
| 淬毒 | 分段幂函数 | 见下方 |

**淬毒定价公式：**
```
value ≤ 200: Gold = 0.01150104 × value^2.5138138
value > 200: Gold = 7000 × (value/200)^1.2683579
```

#### 食品定价

食品采用**综合战斗价值**定价，包含：

```
V_total = V_inst + V_hot + V_buff + V_special

其中：
- V_inst = HP + MP（瞬间恢复）
- V_hot = HoT总量 × λ（缓释折价，λ=0.7）
- V_buff = α × (3×ATK + 2×DEF) + V_speed（见下方速度换算）
- V_special = 净化/淬毒等特殊效果价值
```

**参数取值：**
| 参数 | 符号 | 值 | 推导 |
|------|------|-----|------|
| buff战斗利用率 | α | **5** | 60秒buff中约5秒有效战斗 |
| HoT缓释折价 | λ | **0.7** | 延迟生效的风险折扣 |

> **α=5 的来源**：伤害加成每点价值=3×5=15金币，防御每点价值=2×5=10金币，与验算表一致。

### 5. 物品分类与定价域

| 分类 | use标签 | 定价逻辑 | 说明 |
|------|---------|---------|------|
| 战斗药剂 | 药剂 | StdHP模型 | 纯战斗消耗品 |
| 战斗食品 | 药剂 | 综合价值模型 | 恢复+buff |
| 烹饪材料 | 材料 | 产出经济 | 不参与战斗价值验算 |

### 6. 定价档位（Tier）

建议为药剂/食品添加显式档位字段，复用装备的"线性×指数"曲线：

```
恢复量 ~ A × 1.6^tier
价格 ~ B × 1.6^tier
```

| Tier | 价格区间 | 典型物品 |
|------|---------|---------|
| 0 | 50-200 | 饮用水、基础蔬菜 |
| 1 | 200-600 | 普通药剂、罐头 |
| 2 | 600-2000 | 加强药剂、普通菜品 |
| 3 | 2000-6000 | 高级菜品、特效食品 |
| 4 | 6000+ | 稀有药剂、顶级食品 |

---

## 三、设计建议

### 1. 药剂 vs 食品 的差异化

| 维度 | 药剂 | 食品 |
|------|------|------|
| 核心价值 | 高瞬时恢复 | 恢复+buff组合 |
| buff | 无或单一 | 多重buff |
| 性价比 | 纯恢复最优 | buff加成后更优 |
| 使用场景 | 紧急回复 | 战前准备 |

### 2. HoT设计建议

将缓释规则分为两段可调参数：
- **HoT折价 λ**：反映延迟与不确定性（当前取值0.7，建议范围0.5~0.8）
- **CD补偿 m_cd(t)**：反映"缓释给更高总量"的设计意图

### 3. Buff属性换算表

| 属性 | 每点价值(金币) | 公式 |
|------|--------------|------|
| 伤害加成 | **15** | 3 × α = 3 × 5 |
| 防御力 | **10** | 2 × α = 2 × 5 |
| 速度(百分比) | 见下表 | 按档位定价 |

### 4. 速度Buff平衡理论

#### 基础速度参考
| 阶段 | 基础速度 | 说明 |
|------|---------|------|
| 前期 | 5~7 m/s | 初始角色 |
| 中期 | 10 m/s | 中等装备 |
| 后期 | 12 m/s | 高级装备 |

#### 速度Buff设计原则

速度buff采用**百分比乘法**，配合 `calc="mult_positive"`（保守乘法，只取最高）。

```xml
<!-- 示例：+10%速度 -->
<effect type="buff" property="行走X速度" calc="mult_positive" value="1.1" duration="1800" buffId="食品_速度"/>
```

**设计理由**：
- **百分比对所有阶段玩家体感一致**：+10%对前期6m/s和后期12m/s都是"快了一点"
- **保守乘法防止膨胀**：多个速度buff只取最高，避免叠加失控
- **与游戏现有机制一致**：游戏中速度普遍使用保守乘法加成

#### 速度Buff档位（百分比制）

| 档位 | 价格区间 | buff值(乘数) | 实际加速 | StdHP价值 |
|------|---------|-------------|---------|-----------|
| 基础 | 300 | ×1.05 | +5% | 50 |
| 普通 | 2000 | ×1.10 | +10% | 150 |
| 高级 | 4000~6000 | ×1.15 | +15% | 300 |
| 顶级 | 10000 | ×1.20 | +20% | 500 |

#### 速度价值换算

```
V_speed = K × (乘数 - 1)
其中 K = 1000（每10%速度 ≈ 100 StdHP）
```

示例：
- 普通菜品 ×1.10 → (1.10-1)×1000 = 100 StdHP
- 高级食品 ×1.15 → (1.15-1)×1000 = 150 StdHP
- 顶级食品 ×1.20 → (1.20-1)×1000 = 200 StdHP

> **注意**：速度价值是体验溢价，不严格遵循StdHP线性换算。上表为建议参考值。

### 5. 负面效果处理

- **直接扣值**：负面buff换算为StdHP后减去
- **折扣系数**：`V *= (1 - τ × Toxicity)`，其中 τ 为毒性折扣系数

---

## 四、验算参考

### 药剂基准验算（误差≈0）

| 名称 | 价格 | 效果 | 理论价 |
|------|------|------|-------|
| 普通hp药剂 | 100 | HP150 | 100 (0.67折扣) |
| 抗生素 | 500 | HP500 | 500 |
| 加强抗生素药剂 | 1500 | HP1500 | 1500 |
| 普通mp药剂 | 100 | MP100 | 100 |
| 肾上腺素 | 600 | MP300 | 600 (2×) |
| 大MP药剂 | 3000 | MP1500 | 3000 (2×) |
| 普通hp粉尘 | 500 | HP300(group) | 500 (1.67×) |
| 战队药箱 | 3000 | HP1500(group) | 3000 (2×) |
| 净化药剂 | 6000 | purify50 | 6000 (120×) |
| 格格巫的毒 | 500 | 淬毒70 | 500 |
| 稀释的毒 | 7000 | 淬毒200 | 7000 |
| 丽丽丝的毒 | 1000000 | 淬毒10000 | 1000000 |

---

## 五、相关文件

| 文件 | 说明 |
|------|------|
| `消耗品_药剂.xml` | 药剂类物品配置 |
| `消耗品_药剂_食品.xml` | 食品类物品配置 |
| `消耗品_药剂.md` | 本文档 |
