import org.flashNight.gesh.pratt.*;
// 运行完整的Parser测试
PrattEvaluator_TestSuite.runAllTests();



========== PrattEvaluator 100%覆盖测试开始 ==========

--- 测试分组1：构造函数和初始化 ---
  ✅ 构造函数：应该成功创建PrattEvaluator实例
  ✅ 初始化：Math对象应该被预置
  ✅ 初始化：PI常量应该被预置
  ✅ 初始化：E常量应该被预置
  ✅ 内置函数：isNaN应该正常工作
  ✅ 内置函数：parseInt应该正常工作
  ✅ 内置函数：parseFloat应该正常工作
  ✅ 内置函数：String应该正常工作
  ✅ 内置函数：Number应该正常工作
  ✅ 内置函数：Boolean应该正常工作
  ✅ 数学函数：max应该正常工作
  ✅ 数学函数：min应该正常工作
  ✅ 数学函数：clamp应该正常工作
  ✅ 数学函数：abs应该正常工作
  ✅ 数学函数：floor应该正常工作
  ✅ 数学函数：ceil应该正常工作
  ✅ 数学函数：round应该正常工作
  ✅ 初始状态：getContext应该返回非null对象
  ✅ 初始状态：context应该是对象类型

--- 测试分组2：上下文管理 ---
  ✅ 变量管理：setVariable和getVariable应该正常工作
  ✅ 变量类型：字符串变量应该正确
  ✅ 变量类型：布尔变量应该正确
  ✅ 变量类型：null变量应该正确
  ✅ 变量类型：undefined变量应该正确
  ✅ 变量类型：对象变量应该正确
  ✅ 变量类型：数组变量应该正确
  ✅ 函数管理：setFunction应该正常工作
  ✅ 复杂函数：应该正确处理数组参数
  ✅ 函数覆盖：第一个函数应该正常
  ✅ 函数覆盖：第二个函数应该覆盖第一个
  ✅ 变量覆盖：原始值应该正确
  ✅ 变量覆盖：修改值应该正确
  ✅ 清除上下文：用户变量应该被清除
  ✅ 清除上下文：用户函数应该被清除
  ✅ 清除上下文：内置Math对象应该保留
  ✅ 清除上下文：内置函数应该继续工作
  ✅ 获取上下文：getContext应该返回对象
  ✅ 直接上下文：直接设置的变量应该可用
  ✅ 上下文隔离：第一个evaluator的变量应该独立
  ✅ 上下文隔离：第二个evaluator的变量应该独立

--- 测试分组3：基础求值API ---
  ✅ 基础求值：简单表达式应该正确
  ✅ 基础求值：复杂表达式应该正确
  ✅ 上下文求值：变量表达式应该正确
  ✅ 求值类型：字符串结果应该正确
  ✅ 求值类型：布尔结果应该正确
  ✅ 求值类型：null结果应该正确
  ✅ 函数求值：函数调用应该正确
  ✅ 对象求值：属性访问应该正确
  ✅ 数组求值：索引访问应该正确
  ✅ 嵌套求值：复杂表达式应该正确
  ✅ parse方法：应该返回表达式对象
  ✅ parse方法：应该解析为正确的表达式类型
  ✅ 手动求值：解析后的表达式应该可以手动求值
  ✅ 缓存求值：第一次结果应该正确
  ✅ 缓存求值：第二次结果应该正确
  ✅ 缓存求值：第二次应该更快或相等
  ✅ 非缓存求值：结果应该正确
    --- 对象字面量测试 ---
  ✅ 求值类型：对象字面量（带表达式）结果应该正确
  ✅ 对象字面量：空对象 {} 应该被正确解析
  ✅ 对象字面量：解析后的空对象应该没有属性
  ✅ 对象字面量：应该支持多种基础值类型 (number, string, bool, null)
  ✅ 对象字面量：应该支持变量和函数调用作为值
  ✅ 对象字面量：应该支持嵌套对象
  ✅ 集成：对象字面量应该可以在数组字面量中使用
  ✅ 集成：数组字面量应该可以作为对象的值

--- 测试分组4：高级求值功能 ---
  ✅ 安全求值：正确表达式应该返回结果
  ✅ 安全求值：错误表达式应该返回默认值
  ✅ 安全求值：除零错误应该返回默认值
  ✅ 安全求值：语法错误应该返回默认值
  ✅ 安全求值：数字默认值应该正确
  ✅ 安全求值：布尔默认值应该正确
  ✅ 安全求值：null默认值应该正确
  ✅ 表达式验证：有效表达式应该通过验证
  ✅ 表达式验证：有效表达式不应该有错误
  ✅ 表达式验证：无效表达式应该未通过验证
  ✅ 表达式验证：无效表达式应该有错误信息
  ✅ 表达式验证：括号不匹配应该未通过验证
  ✅ 表达式验证：空表达式应该未通过验证
  ✅ 复杂验证：复杂有效表达式应该通过验证
  ✅ 变量提取：简单表达式应该提取正确数量的变量
  ✅ 变量提取：应该包含变量x
  ✅ 变量提取：应该包含变量y
  ✅ 复杂变量提取：应该包含变量a
  ✅ 复杂变量提取：应该包含变量c
  ✅ 复杂变量提取：应该包含变量d
  ✅ 复杂变量提取：应该包含函数名
  ✅ 复杂变量提取：应该包含变量e
  ✅ 复杂变量提取：应该包含变量f
  ✅ 变量提取：重复变量应该只出现一次
  ✅ 变量提取：无变量表达式应该返回空数组
  ✅ 三元变量提取：应该提取所有分支的变量
  ✅ 三元变量提取：应该包含条件变量
  ✅ 三元变量提取：应该包含真值变量
  ✅ 三元变量提取：应该包含假值变量
  ✅ 批量求值：应该返回正确数量的结果
  ✅ 批量求值：第一个表达式应该成功
  ✅ 批量求值：第二个表达式应该成功
  ✅ 批量求值：第三个表达式应该成功
  ✅ 批量求值：错误表达式应该失败
  ✅ 批量求值：第五个表达式应该成功
  ✅ 批量求值：失败的表达式应该有错误信息
  ✅ 批量求值：空数组应该返回空结果
  ✅ 变量提取（对象）：应该能提取对象字面量值中的变量 var1
  ✅ 变量提取（对象）：应该能提取嵌套对象值中的变量 var2
  ✅ 变量提取（对象）：应该正确处理对象中重复的变量

--- 测试分组5：工厂方法 ---
  ✅ 标准工厂：应该创建有效的evaluator
  ✅ 标准工厂：应该包含Math功能
  ✅ 标准工厂：应该包含通用数学函数
  ✅ 标准工厂：应该支持typeof运算符
  ✅ Buff工厂：应该创建有效的evaluator
  ✅ Buff工厂：SET_BASE函数应该正常工作
  ✅ Buff工厂：ADD_FLAT函数应该正常工作
  ✅ Buff工厂：ADD_PERCENT_BASE函数应该正常工作
  ✅ Buff工厂：ADD_PERCENT_CURRENT函数应该正常工作
  ✅ Buff工厂：MUL_PERCENT函数应该正常工作
  ✅ Buff工厂：ADD_FINAL函数应该正常工作
  ✅ Buff工厂：CLAMP_MAX函数应该正常工作
  ✅ Buff工厂：CLAMP_MIN函数应该正常工作
  ✅ Buff工厂：buffValue函数应该正确计算
  ✅ Buff工厂：hasTag应该正确识别存在的标签
  ✅ Buff工厂：hasTag应该正确识别不存在的标签
  ✅ Buff工厂：hasTag应该正确处理null标签数组
  ✅ Buff工厂：stackCount应该返回模拟值
  ✅ Buff工厂：应该继承标准功能
  ✅ 自定义工厂：应该创建有效的evaluator
  ✅ 自定义工厂：基础功能应该正常
  ✅ 工厂独立性：第一个evaluator应该独立
  ✅ 工厂独立性：第二个evaluator应该独立
  ✅ 工厂分离：标准evaluator不应该有Buff函数

--- 测试分组6：缓存机制 ---
  ✅ 缓存基础：第一次求值结果应该正确
  ✅ 缓存基础：第二次求值结果应该正确
  ✅ 缓存性能：第二次求值应该更快或相近
  ✅ 非缓存：结果应该正确
  ✅ 缓存上下文：初始结果应该正确
  ✅ 缓存上下文：变量改变后结果应该更新
  ✅ 复杂缓存：重复求值应该产生相同结果
  ✅ 缓存独立性：第一个表达式应该正确缓存
  ✅ 缓存独立性：第二个表达式应该正确缓存
  ✅ 函数缓存：第一次应该调用函数
  ✅ 函数缓存：第二次应该使用缓存，不再调用函数
  ✅ 缓存清除前：结果应该正确
  ✅ 缓存清除后：缓存应该被清除
  ✅ 大量缓存：批量访问应该高效

--- 测试分组7：错误处理和安全性 ---
  ✅ 语法错误：应该抛出异常
  ✅ 运行时错误：应该指出未定义变量
  ✅ 除零错误：应该有相应错误信息
  ✅ null访问错误：应该有相应错误信息
  ✅ undefined访问错误：应该有相应错误信息
  ✅ 函数调用错误：应该指出未知函数
  ✅ 非函数调用错误：应该抛出异常
  ✅ 安全错误处理：应该返回安全的默认值
  ✅ 内存保护：应该防止过大的内存分配或优雅失败
    --- 对象字面量错误处理 ---
  ✅ 对象字面量错误：缺少逗号应该抛出异常
  ✅ 对象字面量错误：缺少冒号应该抛出异常
  ✅ 对象字面量特性：尾随逗号应该被正确解析和支持
  ✅ 对象字面量错误：未闭合的花括号应该抛出异常

--- 测试分组8：实用工具方法 ---
  ✅ 性能测试：应该记录表达式
  ✅ 性能测试：应该记录迭代次数
  ✅ 性能测试：应该记录总时间
  ✅ 性能测试：应该记录平均时间
  ✅ 性能测试：平均时间应该正确计算
  ✅ 性能测试：时间应该非负
  ✅ 复杂性能测试：迭代次数应该正确
  ✅ 复杂性能测试：平均时间应该非负
  ✅ 变量性能测试：应该记录正确的表达式
  ✅ 变量性能测试：迭代次数应该正确
  ✅ 函数性能测试：平均时间应该非负
  ✅ 单次迭代：应该正确处理
  ✅ 单次迭代：平均时间等于总时间
  ✅ 大量迭代：应该正确处理
  ✅ 大量迭代：平均时间应该小于等于总时间
  ✅ 零次迭代：应该正确处理
  ✅ 零次迭代：总时间应该为0
  ✅ 零次迭代：平均时间应该是0或NaN
  ✅ 性能测试缓存：benchmark应该不使用缓存，每次都执行
  ✅ 性能比较：复杂表达式应该不快于简单表达式
  ✅ 错误性能测试：错误表达式应该导致benchmark失败
  ✅ 可靠性测试：每次都应该正确执行
  ✅ 可靠性测试：时间测量应该稳定
  ✅ 可靠性测试：每次都应该正确执行
  ✅ 可靠性测试：时间测量应该稳定
  ✅ 可靠性测试：每次都应该正确执行
  ✅ 可靠性测试：时间测量应该稳定
  ✅ 可靠性测试：每次都应该正确执行
  ✅ 可靠性测试：时间测量应该稳定
  ✅ 可靠性测试：每次都应该正确执行
  ✅ 可靠性测试：时间测量应该稳定

--- 测试分组9：性能功能 ---
  ✅ 缓存性能：使用缓存应该不慢于不使用缓存
  ✅ 大量变量设置：应该在合理时间内完成
  ✅ 大量变量求值：应该高效处理
  ✅ 嵌套性能：深度嵌套应该在合理时间内处理
  ✅ 函数开销：复杂函数应该比简单函数慢
  ✅ 内存优化：大量临时变量操作应该高效
  ✅ 并发模拟：快速连续访问应该稳定
  ✅ 复杂度性能：更复杂的表达式应该不显著更快
  ✅ 复杂度性能：更复杂的表达式应该不显著更快
  ✅ 复杂度性能：更复杂的表达式应该不显著更快
  ✅ 复杂度性能：更复杂的表达式应该不显著更快
  ✅ 复杂度性能：更复杂的表达式应该不显著更快
  ✅ 缓存命中率：缓存命中应该不慢于首次执行

--- 测试分组10：集成场景 ---
  ✅ 游戏场景：普通伤害计算应该正确
  ✅ 游戏场景：暴击伤害计算应该正确
  ✅ 商业场景：折扣计算应该正确
  ✅ 商业场景：最终金额应该正确
  ✅ 科学场景：物理计算应该正确
  ✅ 科学场景：动能计算应该正确
  ✅ 配置场景：cacheEnabled应该有有效值
  ✅ 配置场景：maxConnections应该有有效值
  ✅ 配置场景：logLevel应该有有效值
  ✅ 配置场景：uiTheme应该有有效值
  ✅ 配置场景：缓存应该在生产环境启用
  ✅ 配置场景：移动端连接数应该受限
  ✅ 协作场景：多evaluator协作应该正确
  ✅ 实时场景：平均温度计算应该正确
  ✅ 实时场景：平均湿度计算应该正确
  ✅ 实时场景：舒适度指数应该正确

--- 测试分组11：边界条件 ---
  ✅ 边界条件：空表达式应该返回默认值
  ✅ 边界条件：纯空白应该返回默认值
  ✅ 边界条件：极大数字应该是number类型
  ✅ 边界条件：极小数字应该是number类型
  ✅ 边界条件：1 / 0应该抛出除零错误
  ✅ 边界条件：1 / 0在安全模式下可以返回Infinity
  ✅ 边界条件：NaN运算应该产生NaN
  ✅ 边界条件：NaN检测应该正确
  ✅ 边界条件：极长字符串操作应该正确
  ✅ 边界条件：深度嵌套访问应该正确
  ✅ 边界条件：大量变量应该正确处理
  ✅ 边界条件：空数组长度应该为0
  ✅ 边界条件：大数组长度应该正确
  ✅ 边界条件：大数组访问应该正确
  ✅ 边界条件：特殊字符应该正确处理
  ✅ 边界条件：循环引用对象的普通属性应该可访问
  ✅ 边界条件：大量函数参数应该正确传递
  ✅ 边界条件：嵌套函数调用应该正确
  ✅ 边界条件：复杂三元嵌套应该正确
  ✅ Falsy边界：0 || 'default'应该正确处理
  ✅ Falsy边界：'' || 'default'应该正确处理
  ✅ Falsy边界：false || 'default'应该正确处理
  ✅ Falsy边界：null || 'default'应该正确处理
  ✅ Falsy边界：undefined || 'default'应该正确处理

--- 测试分组12：内存和资源管理 ---
  ✅ 内存管理：大量缓存后基础功能应该正常
  ✅ 上下文管理：大量变量设置应该成功
  ✅ 上下文清理：变量应该被正确清理
  ✅ 上下文清理：内置功能应该保留
  ✅ 资源管理：重复创建销毁应该高效
  ✅ 闭包内存：函数闭包应该正确工作
  ✅ 大对象：应该正确处理大对象
  ✅ 字符串内存：字符串操作应该正确
  ✅ 数组内存：大数组访问应该正确
  ✅ 递归结构：函数应该正确执行（即使不能真正递归）
  ✅ 内存监控：内存密集操作应该在合理时间内完成
  ✅ 清理性能：上下文清理应该快速
  ✅ 内存隔离：工厂1应该独立
  ✅ 内存隔离：工厂2应该独立
  ✅ 批量内存：批量操作应该处理所有表达式
  ✅ 批量内存：批量操作应该高效
  ✅ 批量内存：批量结果应该正确

========== PrattEvaluator 测试结果 ==========
总计: 257 个测试
通过: 257 个
失败: 0 个
覆盖率: 100%
✅ PrattEvaluator 所有测试通过！
==========================================
