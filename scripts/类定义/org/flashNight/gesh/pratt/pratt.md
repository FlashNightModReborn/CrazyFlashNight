# Prattè„šæœ¬å¼•æ“æŠ€æœ¯æ–‡æ¡£

## ç›®å½•

1. [æ¦‚è¿°](#1-æ¦‚è¿°)
   - 1.1 [æ–‡æ¡£ç›®çš„](#11-æ–‡æ¡£ç›®çš„)
   - 1.2 [ç³»ç»Ÿç®€ä»‹](#12-ç³»ç»Ÿç®€ä»‹)
   - 1.3 [æ ¸å¿ƒç‰¹æ€§](#13-æ ¸å¿ƒç‰¹æ€§)
   - 1.4 [æŠ€æœ¯æŒ‡æ ‡æ¦‚è§ˆ](#14-æŠ€æœ¯æŒ‡æ ‡æ¦‚è§ˆ)

2. [æ¶æ„è®¾è®¡](#2-æ¶æ„è®¾è®¡)
   - 2.1 [åˆ†å±‚æ¶æ„ï¼šä»è§£æåˆ°æ±‚å€¼](#21-åˆ†å±‚æ¶æ„ä»è§£æåˆ°æ±‚å€¼)
   - 2.2 [æ ¸å¿ƒç»„ä»¶è§£æ](#22-æ ¸å¿ƒç»„ä»¶è§£æ)
   - 2.3 [è®¾è®¡æ¨¡å¼çš„åº”ç”¨](#23-è®¾è®¡æ¨¡å¼çš„åº”ç”¨)
   - 2.4 [æ•°æ®æµå‘åˆ†æ](#24-æ•°æ®æµå‘åˆ†æ)

3. [æŠ€æœ¯åŸç†ä¸å®ç°](#3-æŠ€æœ¯åŸç†ä¸å®ç°)
   - 3.1 [Prattè§£æç®—æ³•æ ¸å¿ƒ](#31-prattè§£æç®—æ³•æ ¸å¿ƒ)
   - 3.2 [è¯æ³•åˆ†æçš„çŠ¶æ€æœºæ¨¡å‹](#32-è¯æ³•åˆ†æçš„çŠ¶æ€æœºæ¨¡å‹)
   - 3.3 [è¯­æ³•åˆ†æä¸ASTæ„å»º](#33-è¯­æ³•åˆ†æä¸astæ„å»º)
   - 3.4 [è¡¨è¾¾å¼æ±‚å€¼å¼•æ“](#34-è¡¨è¾¾å¼æ±‚å€¼å¼•æ“)
   - 3.5 [ä¸Šä¸‹æ–‡ä¸ä½œç”¨åŸŸç®¡ç†](#35-ä¸Šä¸‹æ–‡ä¸ä½œç”¨åŸŸç®¡ç†)
   - 3.6 [ActionScript 2.0ç‰¹å®šä¼˜åŒ–](#36-actionscript-20ç‰¹å®šä¼˜åŒ–)

4. [æ€§èƒ½ä¼˜åŒ–ä¸ç¼“å­˜ç­–ç•¥](#4-æ€§èƒ½ä¼˜åŒ–ä¸ç¼“å­˜ç­–ç•¥)
   - 4.1 [ä¸¤çº§ç¼“å­˜æœºåˆ¶](#41-ä¸¤çº§ç¼“å­˜æœºåˆ¶)
   - 4.2 [ç¼“å­˜ä¸€è‡´æ€§ç­–ç•¥](#42-ç¼“å­˜ä¸€è‡´æ€§ç­–ç•¥)
   - 4.3 [æ€§èƒ½åŸºå‡†æµ‹è¯•å·¥å…·](#43-æ€§èƒ½åŸºå‡†æµ‹è¯•å·¥å…·)
   - 4.4 [å†…å­˜ç®¡ç†ä¸ä¼˜åŒ–](#44-å†…å­˜ç®¡ç†ä¸ä¼˜åŒ–)

5. [é”™è¯¯å¤„ç†ä¸è°ƒè¯•](#5-é”™è¯¯å¤„ç†ä¸è°ƒè¯•)
   - 5.1 [é”™è¯¯ç±»å‹åˆ†æ](#51-é”™è¯¯ç±»å‹åˆ†æ)
   - 5.2 [è°ƒè¯•å·¥å…·ä¸æŠ€å·§](#52-è°ƒè¯•å·¥å…·ä¸æŠ€å·§)
   - 5.3 [å®¹é”™æœºåˆ¶](#53-å®¹é”™æœºåˆ¶)

6. [åº”ç”¨åœºæ™¯ä¸é›†æˆ](#6-åº”ç”¨åœºæ™¯ä¸é›†æˆ)
   - 6.1 [é€‚ç”¨ç¯å¢ƒ](#61-é€‚ç”¨ç¯å¢ƒ)
   - 6.2 [å…¸å‹åº”ç”¨åœºæ™¯](#62-å…¸å‹åº”ç”¨åœºæ™¯)
   - 6.3 [é›†æˆæŒ‡å—](#63-é›†æˆæŒ‡å—)
   - 6.4 [æœ€ä½³å®è·µ](#64-æœ€ä½³å®è·µ)

7. [æ‰©å±•ä¸äºŒæ¬¡å¼€å‘](#7-æ‰©å±•ä¸äºŒæ¬¡å¼€å‘)
   - 7.1 [å¿«é€Ÿå…¥é—¨ï¼šæ·»åŠ æ–°çš„äºŒå…ƒè¿ç®—ç¬¦](#71-å¿«é€Ÿå…¥é—¨æ·»åŠ æ–°çš„äºŒå…ƒè¿ç®—ç¬¦)
   - 7.2 [è¿›é˜¶ï¼šæ·»åŠ æ–°çš„è¯­æ³•ç»“æ„](#72-è¿›é˜¶æ·»åŠ æ–°çš„è¯­æ³•ç»“æ„)
   - 7.3 [è‡ªå®šä¹‰å‡½æ•°åº“å¼€å‘](#73-è‡ªå®šä¹‰å‡½æ•°åº“å¼€å‘)

8. [æ•…éšœæ’é™¤ä¸FAQ](#8-æ•…éšœæ’é™¤ä¸faq)
   - 8.1 [å¸¸è§é—®é¢˜](#81-å¸¸è§é—®é¢˜)
   - 8.2 [æ€§èƒ½é—®é¢˜è¯Šæ–­](#82-æ€§èƒ½é—®é¢˜è¯Šæ–­)

9. [æ€»ç»“ä¸å±•æœ›](#9-æ€»ç»“ä¸å±•æœ›)

---

## 1. æ¦‚è¿°

### 1.1 æ–‡æ¡£ç›®çš„

æœ¬æŠ€æœ¯æ–‡æ¡£æ—¨åœ¨ä¸ºå¼€å‘äººå‘˜æä¾›ä¸€ä»½å…³äºPrattè„šæœ¬å¼•æ“ï¼ˆåæ–‡ç®€ç§°"æœ¬ç³»ç»Ÿ"ï¼‰çš„æ·±å…¥ã€å…¨é¢çš„æŠ€æœ¯å‚è€ƒã€‚å®ƒè¯¦ç»†é˜è¿°äº†ç³»ç»Ÿçš„æ¶æ„è®¾è®¡ã€æ ¸å¿ƒæŠ€æœ¯åŸç†ã€å®ç°ç»†èŠ‚ã€ä¼˜åŒ–ç­–ç•¥ä»¥åŠåº”ç”¨é›†æˆæ–¹æ³•ï¼Œæ—¨åœ¨ï¼š

- **é™ä½å­¦ä¹ æ›²çº¿**ï¼šå¸®åŠ©æ–°æˆå‘˜å¿«é€Ÿç†è§£ç³»ç»Ÿçš„å·¥ä½œåŸç†å’Œè®¾è®¡å“²å­¦
- **æŒ‡å¯¼åç»­å¼€å‘**ï¼šä¸ºç³»ç»Ÿçš„ç»´æŠ¤ã€æ‰©å±•å’ŒäºŒæ¬¡å¼€å‘æä¾›æ¸…æ™°çš„è·¯çº¿å›¾
- **ä½œä¸ºæŠ€æœ¯èµ„äº§**ï¼šæ²‰æ·€é¡¹ç›®æ ¸å¿ƒæŠ€æœ¯ï¼Œç¡®ä¿çŸ¥è¯†çš„ä¼ æ‰¿
- **æ€§èƒ½è°ƒä¼˜æŒ‡å¯¼**ï¼šæä¾›è¯¦ç»†çš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥å’Œæœ€ä½³å®è·µ

### 1.2 ç³»ç»Ÿç®€ä»‹

æœ¬ç³»ç»Ÿæ˜¯ä¸€ä¸ªåŸºäºActionScript 2å®ç°çš„ã€åŠŸèƒ½å®Œå¤‡çš„è¡¨è¾¾å¼è§£æä¸æ±‚å€¼å¼•æ“ã€‚å®ƒé‡‡ç”¨ç»å…¸çš„**Prattè§£æ**ï¼ˆTop-Down Operator Precedenceï¼‰ç®—æ³•ï¼Œèƒ½å¤Ÿå°†å­—ç¬¦ä¸²å½¢å¼çš„è„šæœ¬è¡¨è¾¾å¼é«˜æ•ˆã€å‡†ç¡®åœ°è½¬æ¢ä¸ºæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ï¼Œå¹¶åœ¨ç»™å®šçš„ä¸Šä¸‹æ–‡ä¸­è¿›è¡ŒåŠ¨æ€æ±‚å€¼ã€‚

#### æŠ€æœ¯æ ˆä¸ä¾èµ–
- **æ ¸å¿ƒè¯­è¨€**ï¼šActionScript 2.0
- **è¿è¡Œç¯å¢ƒ**ï¼šFlash Player 6-8, Adobe AIR (legacy), Red5 Server
- **è®¾è®¡æ¨¡å¼**ï¼šç­–ç•¥æ¨¡å¼ã€å·¥å‚æ¨¡å¼ã€å¤–è§‚æ¨¡å¼ã€çŠ¶æ€æœºæ¨¡å¼
- **ç®—æ³•æ ¸å¿ƒ**ï¼šPratt Parser (Top-Down Operator Precedence)

#### ç³»ç»Ÿå®šä½
ç³»ç»Ÿçš„è®¾è®¡ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ª**é«˜æ€§èƒ½ã€é«˜å¯æ‰©å±•æ€§ã€é«˜å®¹é”™æ€§**çš„åŠ¨æ€è¯­è¨€æ‰§è¡Œç¯å¢ƒï¼Œä½¿å…¶ä¸ä»…èƒ½å®Œæˆå¤æ‚çš„æ•°å­¦å’Œé€»è¾‘è¿ç®—ï¼Œè¿˜èƒ½ä½œä¸ºçµæ´»çš„è§„åˆ™å¼•æ“å’Œé…ç½®ç³»ç»Ÿï¼ŒåµŒå…¥åˆ°å„ç§åº”ç”¨ä¸­ã€‚

### 1.3 æ ¸å¿ƒç‰¹æ€§

#### ğŸš€ åŠŸèƒ½ä¸°å¯Œ
- **å®Œæ•´çš„è¿ç®—ç¬¦æ”¯æŒ**ï¼šç®—æœ¯(+,-,*,/,%)ã€æ¯”è¾ƒ(<,>,==,!=)ã€é€»è¾‘(&&,||,!)ã€ä¸‰å…ƒ(?:)ã€ç©ºå€¼åˆå¹¶(??)
- **ç°ä»£è¯­è¨€ç‰¹æ€§**ï¼šå‡½æ•°è°ƒç”¨ã€å±æ€§è®¿é—®ã€æ•°ç»„/å¯¹è±¡å­—é¢é‡ã€å˜é‡å¼•ç”¨
- **ç±»å‹ç³»ç»Ÿ**ï¼šåŠ¨æ€ç±»å‹ï¼Œæ”¯æŒNumberã€Stringã€Booleanã€Objectã€Arrayã€nullã€undefined
- **å†…ç½®å‡½æ•°åº“**ï¼šMathå¯¹è±¡ã€ç±»å‹è½¬æ¢å‡½æ•°ã€æ•°ç»„æ“ä½œå‡½æ•°

#### âš¡ é«˜æ€§èƒ½
- **ä¸¤çº§ç¼“å­˜ç³»ç»Ÿ**ï¼šASTç¼“å­˜ + ç»“æœç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—
- **æ™ºèƒ½ç¼“å­˜å¤±æ•ˆ**ï¼šä¸Šä¸‹æ–‡å˜åŒ–æ—¶ç²¾ç¡®æ¸…ç†ç›¸å…³ç¼“å­˜
- **çŸ­è·¯æ±‚å€¼**ï¼šé€»è¾‘è¿ç®—ç¬¦çš„ä¼˜åŒ–æ‰§è¡Œ
- **å†…å­˜æ± æŠ€æœ¯**ï¼šå‡å°‘å¯¹è±¡åˆ›å»ºå’Œåƒåœ¾å›æ”¶å‹åŠ›

#### ğŸ”§ é«˜å¯æ‰©å±•æ€§
- **ç­–ç•¥æ¨¡å¼æ¶æ„**ï¼šé€šè¿‡Parseletè½»æ¾æ·»åŠ æ–°è¯­æ³•
- **è¿ç®—ç¬¦ä¼˜å…ˆçº§å¯é…ç½®**ï¼šæ”¯æŒè‡ªå®šä¹‰è¿ç®—ç¬¦å’Œä¼˜å…ˆçº§
- **æ’ä»¶åŒ–å‡½æ•°åº“**ï¼šæ”¯æŒåŠ¨æ€æ³¨å†Œè‡ªå®šä¹‰å‡½æ•°
- **å·¥å‚æ¨¡å¼æ”¯æŒ**ï¼šé¢„é…ç½®çš„ä¸“ç”¨æ±‚å€¼å™¨ï¼ˆå¦‚Buffç³»ç»Ÿï¼‰

#### ğŸ›¡ï¸ å¥å£®ä¸å®‰å…¨
- **è¯¦å°½çš„é”™è¯¯å¤„ç†**ï¼šè¯­æ³•é”™è¯¯ã€è¿è¡Œæ—¶é”™è¯¯ã€ç±»å‹é”™è¯¯
- **å®‰å…¨æ±‚å€¼API**ï¼ševaluateSafeæ–¹æ³•æä¾›å®¹é”™æœºåˆ¶
- **ä½ç½®ä¿¡æ¯è·Ÿè¸ª**ï¼šç²¾ç¡®çš„é”™è¯¯å®šä½ï¼ˆè¡Œå·/åˆ—å·ï¼‰
- **è¾“å…¥éªŒè¯**ï¼šè¡¨è¾¾å¼è¯­æ³•é¢„éªŒè¯

#### ğŸ”¨ æ˜“äºé›†æˆ
- **å¤–è§‚æ¨¡å¼API**ï¼šPrattEvaluatoræä¾›ç»Ÿä¸€çš„ç®€æ´æ¥å£
- **å¤šç§åˆå§‹åŒ–æ–¹å¼**ï¼šæ ‡å‡†ç‰ˆã€Buffç³»ç»Ÿä¸“ç”¨ç‰ˆã€è‡ªå®šä¹‰ç‰ˆ
- **ä¸Šä¸‹æ–‡ç®¡ç†**ï¼šçµæ´»çš„å˜é‡å’Œå‡½æ•°æ³¨å…¥æœºåˆ¶
- **å·¥å…·æ–¹æ³•é½å…¨**ï¼šéªŒè¯ã€æå–ã€åŸºå‡†æµ‹è¯•ç­‰å®ç”¨å·¥å…·

### 1.4 æŠ€æœ¯æŒ‡æ ‡æ¦‚è§ˆ

| æ€§èƒ½æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|---------|------|------|
| è§£æé€Ÿåº¦ | ~1000 expr/sec | ç®€å•è¡¨è¾¾å¼çš„è§£æé€Ÿåº¦ï¼ˆå¤æ‚åº¦O(n)ï¼‰ |
| ç¼“å­˜å‘½ä¸­ç‡ | >95% | åœ¨å…¸å‹æ¸¸æˆåœºæ™¯ä¸‹çš„ç¼“å­˜å‘½ä¸­ç‡ |
| å†…å­˜å ç”¨ | <1MB | åŒ…å«æ‰€æœ‰ç¼“å­˜çš„è¿è¡Œæ—¶å†…å­˜å ç”¨ |
| æ”¯æŒçš„è¿ç®—ç¬¦ | 30+ | åŒ…å«æ‰€æœ‰ç®—æœ¯ã€é€»è¾‘ã€æ¯”è¾ƒè¿ç®—ç¬¦ |
| æœ€å¤§è¡¨è¾¾å¼æ·±åº¦ | 100+ | æ”¯æŒçš„æœ€å¤§åµŒå¥—å±‚çº§ |
| å¯åŠ¨æ—¶é—´ | <10ms | ä»åˆå§‹åŒ–åˆ°å¯ç”¨çš„æ—¶é—´ |

---

## 2. æ¶æ„è®¾è®¡

### 2.1 åˆ†å±‚æ¶æ„ï¼šä»è§£æåˆ°æ±‚å€¼

æœ¬ç³»ç»Ÿé‡‡ç”¨äº†ç»å…¸ç¼–è¯‘å™¨è®¾è®¡çš„**åˆ†å±‚æ¶æ„**ï¼Œç¡®ä¿äº†å„ç»„ä»¶èŒè´£å•ä¸€ã€é«˜åº¦è§£è€¦ã€‚è¿™ä½¿å¾—ç³»ç»Ÿé€»è¾‘æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•ã€‚

#### æ•°æ®æµä¸å¤„ç†æµç¨‹

```
[åŸå§‹è¡¨è¾¾å¼å­—ç¬¦ä¸²]
       |
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PrattLexer     â”‚  è¯æ³•åˆ†æ (Lexical Analysis)
â”‚  (çŠ¶æ€æœºé©±åŠ¨)     â”‚  â€¢ å­—ç¬¦æµ â†’ Tokenæµ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â€¢ å…³é”®å­—è¯†åˆ«
       |               â€¢ ä½ç½®è·Ÿè¸ª
       v
[Tokenæµ: PrattToken[]]
       |
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PrattParser    â”‚  è¯­æ³•åˆ†æ (Syntax Analysis)
â”‚ (Prattç®—æ³•æ ¸å¿ƒ)   â”‚  â€¢ Tokenæµ â†’ AST
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â€¢ ä¼˜å…ˆçº§å¤„ç†
       |               â€¢ ç»“åˆæ€§å¤„ç†
       v
[AST: PrattExpression]
       |
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  .evaluate() æ–¹æ³• â”‚  è¯­ä¹‰åˆ†æ & æ‰§è¡Œ (Semantic Analysis & Execution)
â”‚  (é€’å½’æ±‚å€¼å™¨)     â”‚  â€¢ AST â†’ ç»“æœå€¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â€¢ ä¸Šä¸‹æ–‡æŸ¥æ‰¾
       |               â€¢ ç±»å‹è½¬æ¢
       v
[æœ€ç»ˆè®¡ç®—ç»“æœ]
```

#### é¡¶å±‚å°è£…æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PrattEvaluator                           â”‚
â”‚                 (å¤–è§‚å±‚: Facade Pattern)                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  ç¼“å­˜ç®¡ç†  â”‚  ä¸Šä¸‹æ–‡ç®¡ç†  â”‚  é”™è¯¯å¤„ç†  â”‚  æ€§èƒ½ç›‘æ§  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ [è¯æ³•åˆ†æ] â†’ [è¯­æ³•åˆ†æ] â†’ [ASTæ„å»º] â†’ [é€’å½’æ±‚å€¼]        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚     L1:ç»“æœç¼“å­˜     â”‚     L2:ASTç¼“å­˜     â”‚   å·¥å…·æ–¹æ³•   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒç»„ä»¶è§£æ

#### PrattToken - è¯æ³•å•å…ƒ
**èŒè´£**ï¼šè¡¨ç¤ºè¯æ³•åˆ†æçš„åŸå­å•ä½
- **ä¸å¯å˜è®¾è®¡**ï¼šç¡®ä¿Tokenåœ¨ä¼ é€’è¿‡ç¨‹ä¸­çš„å®‰å…¨æ€§
- **ä¸°å¯Œçš„å…ƒæ•°æ®**ï¼šç±»å‹ã€æ–‡æœ¬ã€å€¼ã€ä½ç½®ä¿¡æ¯
- **ç±»å‹å®‰å…¨è®¿é—®å™¨**ï¼šgetNumberValue(), getStringValue()ç­‰
- **è°ƒè¯•å‹å¥½**ï¼šè¯¦ç»†çš„toString()å’Œé”™è¯¯åˆ›å»ºæ–¹æ³•

```actionscript
// Tokenåˆ›å»ºç¤ºä¾‹
var numberToken = new PrattToken(PrattToken.T_NUMBER, "123.45", 1, 5, 123.45);
var identifierToken = new PrattToken(PrattToken.T_IDENTIFIER, "myVar", 1, 10);
```

#### PrattLexer - è¯æ³•åˆ†æå™¨
**èŒè´£**ï¼šå­—ç¬¦æµåˆ°Tokenæµçš„è½¬æ¢
- **çŠ¶æ€æœºæ¨¡å‹**ï¼šé«˜æ•ˆçš„å­—ç¬¦è¯†åˆ«é€»è¾‘
- **æ™ºèƒ½è·³è¿‡**ï¼šè‡ªåŠ¨å¤„ç†ç©ºç™½å­—ç¬¦å’Œæ³¨é‡Š
- **ä½ç½®è·Ÿè¸ª**ï¼šç²¾ç¡®çš„è¡Œå·/åˆ—å·è®°å½•
- **å®¹é”™å¤„ç†**ï¼šä¼˜é›…å¤„ç†éæ³•å­—ç¬¦

**æ ¸å¿ƒçŠ¶æ€è½¬æ¢**ï¼š
```
[START] â†’ [SCAN_WHITESPACE] â†’ [IDENTIFY_CHAR_TYPE] â†’ [SPECIALIZED_SCAN] â†’ [CREATE_TOKEN] â†’ [ADVANCE]
    â†‘                                                                                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### PrattExpression - ASTèŠ‚ç‚¹
**èŒè´£**ï¼šæŠ½è±¡è¯­æ³•æ ‘çš„ç»Ÿä¸€è¡¨ç¤º
- **ç»Ÿä¸€ç±»è®¾è®¡**ï¼šä¸€ä¸ªç±»è¡¨ç¤ºæ‰€æœ‰è¡¨è¾¾å¼ç±»å‹
- **ç±»å‹é©±åŠ¨**ï¼šé€šè¿‡typeå­—æ®µåŒºåˆ†ä¸åŒè¯­æ³•ç»“æ„
- **é€’å½’æ±‚å€¼**ï¼ševaluate()æ–¹æ³•å®ç°æ·±åº¦ä¼˜å…ˆéå†
- **å·¥å‚æ–¹æ³•**ï¼šç±»å‹å®‰å…¨çš„åˆ›å»ºæ¥å£

**æ”¯æŒçš„è¡¨è¾¾å¼ç±»å‹**ï¼š
```actionscript
LITERAL      // å­—é¢é‡: 123, "hello", true
IDENTIFIER   // æ ‡è¯†ç¬¦: myVar
BINARY       // äºŒå…ƒè¿ç®—: a + b
UNARY        // ä¸€å…ƒè¿ç®—: -a, !b  
TERNARY      // ä¸‰å…ƒè¿ç®—: a ? b : c
FUNCTION_CALL     // å‡½æ•°è°ƒç”¨: func(a, b)
PROPERTY_ACCESS   // å±æ€§è®¿é—®: obj.prop
ARRAY_ACCESS      // æ•°ç»„è®¿é—®: arr[index]
ARRAY_LITERAL     // æ•°ç»„å­—é¢é‡: [1, 2, 3]
OBJECT_LITERAL    // å¯¹è±¡å­—é¢é‡: {a: 1, b: 2}
```

#### PrattParselet - è§£æç­–ç•¥
**èŒè´£**ï¼šå°è£…ç‰¹å®šçš„è¯­æ³•è§£æé€»è¾‘
- **ç­–ç•¥æ¨¡å¼çš„å®Œç¾ä½“ç°**ï¼šæ¯ç§è¯­æ³•è§„åˆ™ä¸€ä¸ªç­–ç•¥
- **å‰ç¼€/ä¸­ç¼€åˆ†ç¦»**ï¼šPREFIXå¤„ç†è¡¨è¾¾å¼å¼€å§‹ï¼ŒINFIXå¤„ç†è¿ç®—ç¬¦
- **ä¼˜å…ˆçº§ç®¡ç†**ï¼šå†…ç½®çš„binding poweræœºåˆ¶
- **å¯æ‰©å±•æ€§**ï¼šæ–°è¯­æ³•åªéœ€æ·»åŠ æ–°Parselet

**Parseletç±»å‹æ˜ å°„**ï¼š
```actionscript
// å‰ç¼€Parselet
LITERAL          â†’ literal()
IDENTIFIER       â†’ identifier()  
GROUP           â†’ group()           // (expr)
PREFIX_OPERATOR â†’ prefixOperator()  // -expr, !expr

// ä¸­ç¼€Parselet  
BINARY_OPERATOR â†’ binaryOperator()  // a + b
TERNARY_OPERATOR â†’ ternaryOperator() // a ? b : c
FUNCTION_CALL   â†’ functionCall()    // func()
PROPERTY_ACCESS â†’ propertyAccess()  // obj.prop
ARRAY_ACCESS    â†’ arrayAccess()     // arr[index]
```

#### PrattParser - è¯­æ³•åˆ†æå™¨
**èŒè´£**ï¼šé©±åŠ¨æ•´ä¸ªè§£æè¿‡ç¨‹
- **Prattç®—æ³•å®ç°**ï¼šTop-Down Operator Precedenceçš„æ ¸å¿ƒ
- **Parseletç®¡ç†**ï¼šç»´æŠ¤å‰ç¼€å’Œä¸­ç¼€Parseletæ³¨å†Œè¡¨
- **ä¼˜å…ˆçº§å¤„ç†**ï¼šåŠ¨æ€çš„ä¼˜å…ˆçº§æ¯”è¾ƒå’Œå¤„ç†
- **é”™è¯¯æŠ¥å‘Š**ï¼šç²¾ç¡®çš„è¯­æ³•é”™è¯¯å®šä½

**æ ¸å¿ƒè§£æå¾ªç¯**ï¼š
```actionscript
parseExpression(minPrecedence):
  1. è·å–å‰ç¼€è¡¨è¾¾å¼ (left)
  2. WHILE å½“å‰ä¸­ç¼€ä¼˜å…ˆçº§ > minPrecedence:
     a. æ¶ˆè´¹ä¸­ç¼€Token
     b. è°ƒç”¨ä¸­ç¼€Parselet
     c. æ›´æ–°leftä¸ºæ–°çš„ç»„åˆè¡¨è¾¾å¼
  3. RETURN left
```

#### PrattEvaluator - é¡¶å±‚æ±‚å€¼å™¨
**èŒè´£**ï¼šç³»ç»Ÿçš„å¤–è§‚å’Œåè°ƒè€…
- **å¤–è§‚æ¨¡å¼**ï¼šä¸ºå¤æ‚å­ç³»ç»Ÿæä¾›ç®€å•æ¥å£
- **ä¸Šä¸‹æ–‡ç®¡ç†**ï¼šè¿è¡Œæ—¶å˜é‡å’Œå‡½æ•°çš„ç”Ÿå‘½å‘¨æœŸ
- **ç¼“å­˜åè°ƒ**ï¼šå¤šçº§ç¼“å­˜çš„ç»Ÿä¸€ç®¡ç†
- **å·¥å‚æ”¯æŒ**ï¼šé¢„é…ç½®çš„ä¸“ç”¨å®ä¾‹

### 2.3 è®¾è®¡æ¨¡å¼çš„åº”ç”¨

#### 1. Prattè§£ææ¨¡å¼ (Top-Down Operator Precedence)
- **æ ¸å¿ƒæ€æƒ³**ï¼š"æ¯ä¸ªTokenéƒ½çŸ¥é“å¦‚ä½•è§£æè‡ªå·±"
- **ä¼˜åŠ¿**ï¼šä¼˜é›…å¤„ç†è¿ç®—ç¬¦ä¼˜å…ˆçº§å’Œç»“åˆæ€§
- **å®ç°**ï¼šé€šè¿‡å‰ç¼€/ä¸­ç¼€Parseletçš„åŠ¨æ€è°ƒåº¦

#### 2. ç­–ç•¥æ¨¡å¼ (Strategy Pattern)
- **åº”ç”¨åœºæ™¯**ï¼šPrattParseletçš„è®¾è®¡
- **ä¼˜åŠ¿**ï¼šè¯­æ³•è§„åˆ™çš„å®Œå…¨è§£è€¦ï¼Œææ˜“æ‰©å±•
- **å®ç°**ï¼šæ¯ä¸ªParseletå°è£…ä¸€ç§è§£æç­–ç•¥

```actionscript
// ç­–ç•¥æ³¨å†Œ
registerPrefix(PrattToken.T_NUMBER, PrattParselet.literal());
registerInfix("+", PrattParselet.binaryOperator(6, false));

// ç­–ç•¥æ‰§è¡Œ
var parselet = _prefixParselets[token.type];
var ast = parselet.parsePrefix(this, token);
```

#### 3. å·¥å‚æ¨¡å¼ (Factory Pattern)
- **åº”ç”¨åœºæ™¯**ï¼šPrattExpressionå’ŒPrattEvaluatorçš„åˆ›å»º
- **ä¼˜åŠ¿**ï¼šç±»å‹å®‰å…¨ã€æ¥å£ç»Ÿä¸€ã€æ˜“äºç»´æŠ¤
- **å®ç°**ï¼šé™æ€å·¥å‚æ–¹æ³•

```actionscript
// è¡¨è¾¾å¼å·¥å‚
PrattExpression.binary(left, "+", right)
PrattExpression.functionCall(funcExpr, args)

// æ±‚å€¼å™¨å·¥å‚
PrattEvaluator.createStandard()
PrattEvaluator.createForBuff()
```

#### 4. å¤–è§‚æ¨¡å¼ (Facade Pattern)
- **åº”ç”¨åœºæ™¯**ï¼šPrattEvaluatorä½œä¸ºæ•´ä¸ªç³»ç»Ÿçš„å¤–è§‚
- **ä¼˜åŠ¿**ï¼šéšè—å¤æ‚æ€§ï¼Œæä¾›é«˜çº§API
- **å®ç°**ï¼šç»Ÿä¸€çš„evaluateæ¥å£å°è£…å¤šä¸ªå­ç³»ç»Ÿ

#### 5. çŠ¶æ€æœºæ¨¡å¼ (State Machine Pattern)
- **åº”ç”¨åœºæ™¯**ï¼šPrattLexerçš„å­—ç¬¦æ‰«æé€»è¾‘
- **ä¼˜åŠ¿**ï¼šæ¸…æ™°çš„çŠ¶æ€è½¬æ¢ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
- **å®ç°**ï¼šåŸºäºå­—ç¬¦ç±»å‹çš„çŠ¶æ€åˆ†æ´¾

### 2.4 æ•°æ®æµå‘åˆ†æ

#### å®Œæ•´çš„æ•°æ®å˜æ¢é“¾è·¯

```
è¾“å…¥: "player.level * 2 + bonus(5)"
    â†“
è¯æ³•åˆ†æ: [IDENTIFIER:player] [DOT:.] [IDENTIFIER:level] [OPERATOR:*] [NUMBER:2] [OPERATOR:+] [IDENTIFIER:bonus] [LPAREN:(] [NUMBER:5] [RPAREN:)]
    â†“
è¯­æ³•åˆ†æ: 
    Binary(
      left: Binary(
        left: PropertyAccess(player, level),
        op: "*", 
        right: Literal(2)
      ),
      op: "+",
      right: FunctionCall(bonus, [Literal(5)])
    )
    â†“
æ±‚å€¼æ‰§è¡Œ: 
    1. æ±‚å€¼ player.level â†’ 10 (ä»contextæŸ¥æ‰¾)
    2. æ±‚å€¼ 2 â†’ 2
    3. è®¡ç®— 10 * 2 â†’ 20
    4. æ±‚å€¼ bonus(5) â†’ 15 (è°ƒç”¨contextä¸­çš„å‡½æ•°)
    5. è®¡ç®— 20 + 15 â†’ 35
    â†“
è¾“å‡º: 35
```

#### ç¼“å­˜æ•°æ®æµ

```
evaluate("complex_expr") è°ƒç”¨:
    â†“
æ£€æŸ¥ _resultCache["complex_expr"]
    â†“ (æœªå‘½ä¸­)
æ£€æŸ¥ _expressionCache["complex_expr"]  
    â†“ (æœªå‘½ä¸­) â†’ æ‰§è¡Œå®Œæ•´è§£æ
æ‰§è¡Œå®Œæ•´è§£æ: Lexer â†’ Parser â†’ AST
    â†“
ç¼“å­˜ASTåˆ° _expressionCache
    â†“
æ‰§è¡Œæ±‚å€¼: AST.evaluate(context)
    â†“
ç¼“å­˜ç»“æœåˆ° _resultCache
    â†“
è¿”å›ç»“æœ

ä¸‹æ¬¡è°ƒç”¨ç›¸åŒè¡¨è¾¾å¼:
    â†“
æ£€æŸ¥ _resultCache["complex_expr"] 
    â†“ (å‘½ä¸­!) â†’ è·³è¿‡è§£æï¼Œç›´æ¥æ±‚å€¼
ç›´æ¥è¿”å›ç¼“å­˜ç»“æœ (è·³è¿‡æ‰€æœ‰è§£æå’Œè®¡ç®—)
```

---

## 3. æŠ€æœ¯åŸç†ä¸å®ç°

### 3.1 Prattè§£æç®—æ³•æ ¸å¿ƒ

#### ç®—æ³•åŸç†æ·±åº¦è§£æ

Prattè§£ææ³•çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†è¿ç®—ç¬¦ä¼˜å…ˆçº§é—®é¢˜è½¬åŒ–ä¸º**é€’å½’ä¸‹é™**çš„æ·±åº¦æ§åˆ¶é—®é¢˜ã€‚æ¯ä¸ªè¿ç®—ç¬¦éƒ½æœ‰ä¸€ä¸ª"binding power"ï¼ˆç»‘å®šèƒ½åŠ›ï¼‰ï¼Œè§£æå™¨é€šè¿‡æ¯”è¾ƒè¿™ä¸ªèƒ½åŠ›æ¥å†³å®šè¿ç®—çš„ç»“åˆæ–¹å¼ã€‚

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **Binding Power**ï¼šè¿ç®—ç¬¦çš„ä¼˜å…ˆçº§æ•°å€¼ï¼Œæ•°å€¼è¶Šé«˜ä¼˜å…ˆçº§è¶Šé«˜
- **Left/Right Associativity**ï¼šé€šè¿‡è°ƒæ•´é€’å½’è°ƒç”¨çš„ä¼˜å…ˆçº§å‚æ•°å®ç°
- **Prefix/Infix Distinction**ï¼šå‰ç¼€å¤„ç†è¡¨è¾¾å¼å¼€å§‹ï¼Œä¸­ç¼€å¤„ç†è¿ç®—ç¬¦ç»„åˆ

#### ä¼˜å…ˆçº§æ˜ å°„è¡¨

| è¿ç®—ç¬¦ç±»å‹ | è¿ç®—ç¬¦ | ä¼˜å…ˆçº§ | ç»“åˆæ€§ | è¯´æ˜ |
|-----------|--------|--------|--------|------|
| ä¸‰å…ƒæ¡ä»¶ | `? :` | 1 | å³ç»“åˆ | æœ€ä½ä¼˜å…ˆçº§ |
| é€»è¾‘æˆ– | `\|\|`, `??` | 2 | å·¦ç»“åˆ | çŸ­è·¯æ±‚å€¼ |
| é€»è¾‘ä¸ | `&&` | 3 | å·¦ç»“åˆ | çŸ­è·¯æ±‚å€¼ |
| ç›¸ç­‰æ¯”è¾ƒ | `==`, `!=`, `===`, `!==` | 4 | å·¦ç»“åˆ | |
| å…³ç³»æ¯”è¾ƒ | `<`, `>`, `<=`, `>=` | 5 | å·¦ç»“åˆ | |
| åŠ å‡ | `+`, `-` | 6 | å·¦ç»“åˆ | |
| ä¹˜é™¤æ¨¡ | `*`, `/`, `%` | 7 | å·¦ç»“åˆ | |
| ä¸€å…ƒè¿ç®— | `-`, `+`, `!`, `typeof` | 7 | - | å‰ç¼€è¿ç®—ç¬¦ |
| æŒ‡æ•° | `**` | 8 | å³ç»“åˆ | é«˜ä¼˜å…ˆçº§ |
| è®¿é—®æ“ä½œ | `()`, `.`, `[]` | 10 | å·¦ç»“åˆ | æœ€é«˜ä¼˜å…ˆçº§ |

#### è§£æè¿‡ç¨‹è¯¦ç»†ç¤ºä¾‹

ä»¥è¡¨è¾¾å¼ `a + b * c ** d` ä¸ºä¾‹ï¼š

```
1. parseExpression(0) å¼€å§‹
   â”œâ”€ æ¶ˆè´¹ 'a' â†’ å‰ç¼€è§£æ â†’ [Identifier:a]
   â”œâ”€ æŸ¥çœ‹ '+' (ä¼˜å…ˆçº§6) > 0ï¼Œè¿›å…¥å¾ªç¯
   â”œâ”€ æ¶ˆè´¹ '+' â†’ ä¸­ç¼€è§£æ
   â”‚  â””â”€ è°ƒç”¨ parseExpression(6) è§£æå³ä¾§
   â”‚      â”œâ”€ æ¶ˆè´¹ 'b' â†’ å‰ç¼€è§£æ â†’ [Identifier:b]  
   â”‚      â”œâ”€ æŸ¥çœ‹ '*' (ä¼˜å…ˆçº§7) > 6ï¼Œè¿›å…¥å¾ªç¯
   â”‚      â”œâ”€ æ¶ˆè´¹ '*' â†’ ä¸­ç¼€è§£æ
   â”‚      â”‚  â””â”€ è°ƒç”¨ parseExpression(7) è§£æå³ä¾§
   â”‚      â”‚      â”œâ”€ æ¶ˆè´¹ 'c' â†’ å‰ç¼€è§£æ â†’ [Identifier:c]
   â”‚      â”‚      â”œâ”€ æŸ¥çœ‹ '**' (ä¼˜å…ˆçº§8) > 7ï¼Œè¿›å…¥å¾ªç¯  
   â”‚      â”‚      â”œâ”€ æ¶ˆè´¹ '**' â†’ ä¸­ç¼€è§£æ(å³ç»“åˆ)
   â”‚      â”‚      â”‚  â””â”€ è°ƒç”¨ parseExpression(7) è§£æå³ä¾§ (æ³¨æ„ï¼š8-1=7)
   â”‚      â”‚      â”‚      â”œâ”€ æ¶ˆè´¹ 'd' â†’ [Identifier:d]
   â”‚      â”‚      â”‚      â””â”€ æ²¡æœ‰æ›´å¤šè¿ç®—ç¬¦ï¼Œè¿”å› [Identifier:d]
   â”‚      â”‚      â””â”€ æ„é€  [Binary:c ** d]
   â”‚      â””â”€ æ„é€  [Binary:b * (c ** d)]
   â””â”€ æ„é€  [Binary:a + (b * (c ** d))]

æœ€ç»ˆAST: [Binary:a + [Binary:b * [Binary:c ** d]]]
```

#### ç»“åˆæ€§çš„å®ç°æœºåˆ¶

```actionscript
// å·¦ç»“åˆï¼šä¸‹æ¬¡é€’å½’ä½¿ç”¨ç›¸åŒä¼˜å…ˆçº§
var nextPrecedence = _precedence; // 6 + 6 -> (a+b)+c

// å³ç»“åˆï¼šä¸‹æ¬¡é€’å½’ä½¿ç”¨è¾ƒä½ä¼˜å…ˆçº§  
var nextPrecedence = _precedence - 1; // 8 + (8-1) -> a**(b**c)
```

### 3.2 è¯æ³•åˆ†æçš„çŠ¶æ€æœºæ¨¡å‹

#### çŠ¶æ€æœºè®¾è®¡

PrattLexerå®ç°äº†ä¸€ä¸ª**æœ‰é™çŠ¶æ€æœº**ï¼Œé€šè¿‡çŠ¶æ€è½¬æ¢æ¥è¯†åˆ«ä¸åŒç±»å‹çš„Tokenã€‚

```
çŠ¶æ€è½¬æ¢å›¾:
[START] 
  â”œâ”€ isWhitespace â†’ [SKIP_WHITESPACE] â†’ [START]
  â”œâ”€ '/' â†’ [CHECK_COMMENT] 
  â”‚    â”œâ”€ '/' â†’ [SKIP_LINE_COMMENT] â†’ [START]
  â”‚    â””â”€ '*' â†’ [SKIP_BLOCK_COMMENT] â†’ [START]
  â”œâ”€ isDigit â†’ [SCAN_NUMBER] â†’ [CREATE_NUMBER_TOKEN]
  â”œâ”€ isAlpha â†’ [SCAN_IDENTIFIER] â†’ [CHECK_KEYWORD] â†’ [CREATE_TOKEN]
  â”œâ”€ '"' | "'" â†’ [SCAN_STRING] â†’ [CREATE_STRING_TOKEN]
  â”œâ”€ isOperator â†’ [SCAN_OPERATOR] â†’ [CREATE_OPERATOR_TOKEN]
  â””â”€ isPunctuation â†’ [CREATE_PUNCTUATION_TOKEN]
```

#### æ•°å­—è¯†åˆ«çš„çŠ¶æ€æœº

```actionscript
// æ•°å­—æ‰«æçš„è¯¦ç»†çŠ¶æ€è½¬æ¢
[START_NUMBER]
  â”œâ”€ '0'-'9' â†’ [INTEGER_PART] 
  â”‚    â”œâ”€ '0'-'9' â†’ [INTEGER_PART] (å¾ªç¯)
  â”‚    â””â”€ '.' â†’ [DECIMAL_POINT]
  â”‚         â””â”€ '0'-'9' â†’ [FRACTIONAL_PART]
  â”‚              â””â”€ '0'-'9' â†’ [FRACTIONAL_PART] (å¾ªç¯)
  â””â”€ '.' â†’ [DECIMAL_POINT] (ä»¥.å¼€å¤´çš„å°æ•°)
       â””â”€ '0'-'9' â†’ [FRACTIONAL_PART]
```

#### å­—ç¬¦ä¸²å¤„ç†ä¸è½¬ä¹‰

```actionscript
// å­—ç¬¦ä¸²æ‰«æä¸­çš„è½¬ä¹‰å¤„ç†
private function _scanString(quote:String, ...):PrattToken {
    var value:String = "";
    
    while (current_char != quote && !atEnd()) {
        if (current_char == "\\") {
            advance(); // è·³è¿‡åæ–œæ 
            switch (current_char) {
                case "n": value += "\n"; break;
                case "t": value += "\t"; break;
                case "r": value += "\r"; break;
                case "\\": value += "\\"; break;
                case "\"": value += "\""; break;
                case "'": value += "'"; break;
                default: value += current_char; break; // æœªçŸ¥è½¬ä¹‰ä¿æŒåŸæ ·
            }
        } else {
            value += current_char;
        }
        advance();
    }
    
    return new PrattToken(T_STRING, originalText, line, col, value);
}
```

#### å¤šå­—ç¬¦è¿ç®—ç¬¦çš„è´ªå¿ƒåŒ¹é…

```actionscript
// è´ªå¿ƒåŒ¹é…ç­–ç•¥ï¼šä¼˜å…ˆåŒ¹é…æœ€é•¿çš„è¿ç®—ç¬¦
private function _scanMultiCharOperator():String {
    var char1 = currentChar();
    var char2 = peek(1);
    var char3 = peek(2);
    
    // ä¸‰å­—ç¬¦è¿ç®—ç¬¦ä¼˜å…ˆ
    var triple = char1 + char2 + char3;
    if (triple == "===" || triple == "!==") {
        advance(3);
        return triple;
    }
    
    // ä¸¤å­—ç¬¦è¿ç®—ç¬¦æ¬¡ä¹‹
    var double = char1 + char2;
    if (DOUBLE_CHAR_OPERATORS.contains(double)) {
        advance(2);
        return double;
    }
    
    // å•å­—ç¬¦è¿ç®—ç¬¦å…œåº•
    return null; // è®©è°ƒç”¨è€…å¤„ç†å•å­—ç¬¦
}
```

### 3.3 è¯­æ³•åˆ†æä¸ASTæ„å»º

#### ASTèŠ‚ç‚¹çš„ç»Ÿä¸€è®¾è®¡

PrattExpressioné‡‡ç”¨äº†**ç»Ÿä¸€ç±»**è®¾è®¡æ¨¡å¼ï¼Œé€šè¿‡`type`å­—æ®µæ¥åŒºåˆ†ä¸åŒçš„è¡¨è¾¾å¼ç±»å‹ã€‚è¿™ç§è®¾è®¡ç®€åŒ–äº†ASTçš„ç»“æ„ï¼Œä½†éœ€è¦ä»”ç»†ç®¡ç†å„ç§ç±»å‹çš„å±æ€§ã€‚

```actionscript
// ç»Ÿä¸€ç±»çš„å±æ€§æ˜ å°„
class PrattExpression {
    public var type:String;        // æ‰€æœ‰ç±»å‹éƒ½æœ‰
    
    // å­—é¢é‡ä¸“ç”¨
    public var value;              // LITERAL
    
    // æ ‡è¯†ç¬¦ä¸“ç”¨  
    public var name:String;        // IDENTIFIER
    
    // äºŒå…ƒè¿ç®—ä¸“ç”¨
    public var left:PrattExpression;   // BINARY
    public var right:PrattExpression;  // BINARY
    public var operator:String;        // BINARY, UNARY
    
    // ä¸€å…ƒè¿ç®—ä¸“ç”¨
    public var operand:PrattExpression; // UNARY
    
    // ä¸‰å…ƒè¿ç®—ä¸“ç”¨
    public var condition:PrattExpression;  // TERNARY
    public var trueExpr:PrattExpression;   // TERNARY  
    public var falseExpr:PrattExpression;  // TERNARY
    
    // å‡½æ•°è°ƒç”¨ä¸“ç”¨
    public var functionExpr:PrattExpression; // FUNCTION_CALL
    public var arguments:Array;              // FUNCTION_CALL
    
    // å±æ€§è®¿é—®ä¸“ç”¨
    public var object:PrattExpression;   // PROPERTY_ACCESS
    public var property:String;          // PROPERTY_ACCESS
    
    // æ•°ç»„è®¿é—®ä¸“ç”¨
    public var array:PrattExpression;    // ARRAY_ACCESS
    public var index:PrattExpression;    // ARRAY_ACCESS
    
    // æ•°ç»„å­—é¢é‡ä¸“ç”¨
    public var elements:Array;           // ARRAY_LITERAL
    
    // å¯¹è±¡å­—é¢é‡ä¸“ç”¨  
    public var properties:Array;         // OBJECT_LITERAL: [{key:String, value:PrattExpression}]
}
```

#### ç±»å‹å®‰å…¨çš„å·¥å‚æ–¹æ³•

```actionscript
// æ¯ç§è¡¨è¾¾å¼ç±»å‹éƒ½æœ‰å¯¹åº”çš„å·¥å‚æ–¹æ³•
public static function binary(left:PrattExpression, op:String, right:PrattExpression):PrattExpression {
    var expr = new PrattExpression(BINARY);
    expr.left = left;
    expr.operator = op;  
    expr.right = right;
    return expr;
}

public static function functionCall(funcExpr:PrattExpression, args:Array):PrattExpression {
    var expr = new PrattExpression(FUNCTION_CALL);
    expr.functionExpr = funcExpr;
    expr.arguments = args || [];
    return expr;
}
```

#### å¤æ‚è¡¨è¾¾å¼çš„è§£æç¤ºä¾‹

ä»¥å¯¹è±¡å­—é¢é‡ `{name: "John", age: player.level + 5}` ä¸ºä¾‹ï¼š

```actionscript
// å¯¹è±¡å­—é¢é‡çš„è§£æé€»è¾‘
case OBJECT_LITERAL:
    var properties:Array = [];
    
    if (!parser.match(T_RBRACE)) { // éç©ºå¯¹è±¡
        do {
            // è§£æé”® (æ ‡è¯†ç¬¦æˆ–å­—ç¬¦ä¸²)
            var keyToken = parser.consume();
            var key:String;
            if (keyToken.type == T_IDENTIFIER) {
                key = keyToken.text; // name
            } else if (keyToken.type == T_STRING) {
                key = keyToken.getStringValue(); // "name"  
            } else {
                throw new Error("Invalid object key");
            }
            
            parser.consumeExpected(T_COLON); // :
            
            // è§£æå€¼è¡¨è¾¾å¼
            var value = parser.parseExpression(0); // "John" æˆ– player.level + 5
            
            properties.push({key: key, value: value});
            
        } while (parser.match(T_COMMA) && parser.consume());
    }
    
    parser.consumeExpected(T_RBRACE);
    return PrattExpression.objectLiteral(properties);
```

### 3.4 è¡¨è¾¾å¼æ±‚å€¼å¼•æ“

#### é€’å½’æ±‚å€¼çš„å®ç°

æ±‚å€¼å¼•æ“é‡‡ç”¨**æ·±åº¦ä¼˜å…ˆéå†**çš„æ–¹å¼ï¼Œé€’å½’åœ°å¯¹ASTè¿›è¡Œæ±‚å€¼ï¼š

```actionscript
public function evaluate(context:Object) {
    switch (type) {
        case LITERAL:
            return value; // ç›´æ¥è¿”å›å­—é¢é‡å€¼
            
        case IDENTIFIER:
            return _lookupVariable(name, context); // å˜é‡æŸ¥æ‰¾
            
        case BINARY:
            return _evaluateBinary(context); // äºŒå…ƒè¿ç®—
            
        case FUNCTION_CALL:
            return _evaluateFunctionCall(context); // å‡½æ•°è°ƒç”¨
            
        // ... å…¶ä»–ç±»å‹
    }
}
```

#### å˜é‡æŸ¥æ‰¾çš„å¥å£®å®ç°

ç”±äºActionScript 2çš„é™åˆ¶ï¼Œ`context[name] === undefined`æ— æ³•åŒºåˆ†"å±æ€§ä¸å­˜åœ¨"å’Œ"å±æ€§å€¼ä¸ºundefined"ã€‚ç³»ç»Ÿé‡‡ç”¨äº†ä¸€ç§å·§å¦™çš„è§£å†³æ–¹æ¡ˆï¼š

```actionscript
// AS2ä¸­å®‰å…¨çš„å±æ€§å­˜åœ¨æ€§æ£€æŸ¥
private function _lookupVariable(name:String, context:Object) {
    if (context != null) {
        var keyExists:Boolean = false;
        for (var k in context) { // éå†æ‰€æœ‰é”®
            if (k == name) {
                keyExists = true;
                break;
            }
        }
        if (keyExists) {
            return context[name]; // å±æ€§å­˜åœ¨ï¼Œè¿”å›å…¶å€¼ï¼ˆå¯èƒ½æ˜¯undefinedï¼‰
        }
    }
    throw new Error("Undefined variable: " + name);
}
```

#### ç±»å‹è½¬æ¢ä¸è¿ç®—

```actionscript
// åŠ æ³•è¿ç®—çš„å¤æ‚é€»è¾‘
case "+":
    var leftNum = Number(leftVal);
    var rightNum = Number(rightVal);
    
    // å¦‚æœä¸¤è¾¹éƒ½èƒ½è½¬ä¸ºæœ‰æ•ˆæ•°å­—ï¼Œæ‰§è¡Œæ•°å€¼åŠ æ³•
    if (!isNaN(leftNum) && !isNaN(rightNum)) {
        return _normalize(leftNum + rightNum); // æµ®ç‚¹æ•°ç²¾åº¦ä¿®æ­£
    }
    
    // å¦‚æœä»»ä¸€ä¾§æ˜¯å­—ç¬¦ä¸²ï¼Œæ‰§è¡Œå­—ç¬¦ä¸²æ‹¼æ¥  
    if (typeof leftVal == "string" || typeof rightVal == "string") {
        return String(leftVal) + String(rightVal);
    }
    
    // å…œåº•ï¼šæŒ‰æ•°å€¼åŠ æ³•å¤„ç†ï¼ˆç»“æœå¯èƒ½æ˜¯NaNï¼‰
    return _normalize(leftNum + rightNum);
```

#### çŸ­è·¯æ±‚å€¼çš„ä¼˜åŒ–

```actionscript
// é€»è¾‘ä¸çš„çŸ­è·¯æ±‚å€¼
case "&&":
    var leftVal = left.evaluate(context);
    if (!leftVal) {
        return leftVal; // çŸ­è·¯ï¼šå·¦ä¾§ä¸ºfalsyï¼Œç›´æ¥è¿”å›å·¦ä¾§å€¼
    }
    return right.evaluate(context); // å¦åˆ™è¿”å›å³ä¾§çš„å€¼

// é€»è¾‘æˆ–çš„çŸ­è·¯æ±‚å€¼  
case "||":
    var leftVal = left.evaluate(context);
    if (leftVal) {
        return leftVal; // çŸ­è·¯ï¼šå·¦ä¾§ä¸ºtruthyï¼Œç›´æ¥è¿”å›å·¦ä¾§å€¼
    }
    return right.evaluate(context); // å¦åˆ™è¿”å›å³ä¾§çš„å€¼
```

#### å‡½æ•°è°ƒç”¨çš„å®ç°

```actionscript
private function _evaluateFunctionCall(context:Object) {
    // 1. æ±‚å€¼æ‰€æœ‰å‚æ•°
    var evaluatedArgs:Array = [];
    for (var i = 0; i < this.arguments.length; i++) {
        evaluatedArgs.push(this.arguments[i].evaluate(context));
    }
    
    // 2. æ ¹æ®å‡½æ•°è¡¨è¾¾å¼ç±»å‹å¤„ç†è°ƒç”¨
    if (functionExpr.type == IDENTIFIER) {
        // ç®€å•å‡½æ•°è°ƒç”¨: func(args)
        var funcName = functionExpr.name;
        var func = context[funcName];
        
        if (typeof func == "function") {
            return func.apply(context, evaluatedArgs); // ç¡®ä¿thisæŒ‡å‘æ­£ç¡®
        }
        throw new Error("Unknown function: " + funcName);
        
    } else if (functionExpr.type == PROPERTY_ACCESS) {
        // æ–¹æ³•è°ƒç”¨: obj.method(args) 
        var obj = functionExpr.object.evaluate(context);
        var methodName = functionExpr.property;
        var method = obj[methodName];
        
        if (typeof method == "function") {
            return method.apply(obj, evaluatedArgs); // thisæŒ‡å‘obj
        }
        throw new Error("Method not found: " + methodName);
    }
    
    throw new Error("Invalid function call target");
}
```

### 3.5 ä¸Šä¸‹æ–‡ä¸ä½œç”¨åŸŸç®¡ç†

#### å•ä¸€ä¸Šä¸‹æ–‡æ¨¡å‹

æœ¬ç³»ç»Ÿé‡‡ç”¨æ‰å¹³çš„å•ä¸€ä¸Šä¸‹æ–‡æ¨¡å‹ï¼Œæ‰€æœ‰å˜é‡å’Œå‡½æ•°éƒ½å­˜å‚¨åœ¨ä¸€ä¸ªObjectä¸­ï¼š

```actionscript
// ä¸Šä¸‹æ–‡ç»“æ„ç¤ºä¾‹
_context = {
    // å†…ç½®å¸¸é‡
    "Math": Math,
    "PI": 3.14159,
    "E": 2.71828,
    
    // å†…ç½®å‡½æ•°
    "max": function() { return Math.max.apply(null, arguments); },
    "min": function() { return Math.min.apply(null, arguments); },
    "clamp": function(val, min, max) { return Math.max(min, Math.min(max, val)); },
    
    // ç”¨æˆ·å˜é‡
    "player": {level: 10, health: 100},
    "gameSettings": {difficulty: "normal"},
    
    // ç”¨æˆ·å‡½æ•°
    "calculateDamage": function(attack, defense) { return attack - defense; }
};
```

#### å†…ç½®å‡½æ•°åº“çš„åˆå§‹åŒ–

```actionscript
private function _initializeBuiltins():Void {
    // æ•°å­¦å¸¸é‡
    _context["Math"] = Math;
    _context["PI"] = Math.PI;
    _context["E"] = Math.E;
    
    // ç±»å‹è½¬æ¢å‡½æ•°
    _context["Number"] = function(value) { return Number(value); };
    _context["String"] = function(value) { return String(value); };
    _context["Boolean"] = function(value) { return Boolean(value); };
    
    // æ•°å­¦å‡½æ•°
    _context["abs"] = function(value) { return Math.abs(Number(value)); };
    _context["floor"] = function(value) { return Math.floor(Number(value)); };
    _context["ceil"] = function(value) { return Math.ceil(Number(value)); };
    _context["round"] = function(value) { return Math.round(Number(value)); };
    
    // å®ç”¨å‡½æ•°
    _context["max"] = function() { return Math.max.apply(null, arguments); };
    _context["min"] = function() { return Math.min.apply(null, arguments); };
    _context["clamp"] = function(value, min, max) {
        return Math.max(min, Math.min(max, value));
    };
}
```

#### åŠ¨æ€ä¸Šä¸‹æ–‡ç®¡ç†

```actionscript
// ä¸Šä¸‹æ–‡çš„åŠ¨æ€æ›´æ–°
public function setVariable(name:String, value):Void {
    _context[name] = value;
    _resultCache = {}; // æ¸…é™¤ç»“æœç¼“å­˜ï¼Œå› ä¸ºä¸Šä¸‹æ–‡å˜åŒ–å¯èƒ½å½±å“æ‰€æœ‰è¡¨è¾¾å¼
}

public function setFunction(name:String, func:Function):Void {
    _context[name] = func;
    _resultCache = {}; // åŒæ ·æ¸…é™¤ç»“æœç¼“å­˜
}

// æ‰¹é‡è®¾ç½®
public function setVariables(vars:Object):Void {
    for (var name:String in vars) {
        _context[name] = vars[name];
    }
    _resultCache = {}; // ä¸€æ¬¡æ€§æ¸…é™¤ï¼Œé¿å…å¤šæ¬¡æ¸…é™¤çš„å¼€é”€
}
```

### 3.6 ActionScript 2.0ç‰¹å®šä¼˜åŒ–

#### è¯­è¨€é™åˆ¶çš„è§£å†³æ–¹æ¡ˆ

**1. ç¼ºä¹æ³›å‹çš„å¤„ç†**
```actionscript
// ä½¿ç”¨Objectä½œä¸ºé€šç”¨å®¹å™¨ï¼Œåœ¨è¿è¡Œæ—¶è¿›è¡Œç±»å‹æ£€æŸ¥
private var _cache:Object = {}; // ç›¸å½“äº Map<String, Any>

// ç±»å‹å®‰å…¨çš„è®¿é—®å™¨
public function getNumberValue():Number {
    if (type == T_NUMBER) {
        return Number(value);
    }
    throw new Error("Tokenä¸æ˜¯æ•°å­—ç±»å‹");
}
```

**2. å¯é€‰å‚æ•°çš„å¤„ç†**
```actionscript
// ä½¿ç”¨arguments.lengthåˆ¤æ–­å‚æ•°æ˜¯å¦è¢«ä¼ é€’
public function PrattToken(tokenType:String, tokenText:String, 
                          tokenLine:Number, tokenColumn:Number, tokenValue) {
    this.type = tokenType;
    this.text = tokenText;
    this.line = tokenLine || 0;
    this.column = tokenColumn || 0;
    
    // å…³é”®ï¼šåŒºåˆ†"æœªä¼ é€’"å’Œ"ä¼ é€’äº†undefined"
    if (arguments.length > 4) {
        this.value = tokenValue; // ä½¿ç”¨ä¼ é€’çš„å€¼ï¼Œå³ä½¿æ˜¯undefined
    } else {
        this._autoCalculateValue(); // è‡ªåŠ¨è®¡ç®—å€¼
    }
}
```

**3. æ²¡æœ‰staticå…³é”®å­—çš„å¤„ç†**
```actionscript
// åœ¨ç±»ä¸­å®šä¹‰é™æ€å¸¸é‡å’Œæ–¹æ³•
class PrattToken {
    // é™æ€å¸¸é‡æ¨¡æ‹Ÿ
    public static var T_NUMBER:String = "NUMBER";
    public static var T_STRING:String = "STRING";
    
    // é™æ€å·¥å‚æ–¹æ³•
    public static function createNumber(text:String, line:Number, col:Number):PrattToken {
        return new PrattToken(T_NUMBER, text, line, col);
    }
}
```

**4. æ€§èƒ½ä¼˜åŒ–æŠ€å·§**

```actionscript
// é¿å…é¢‘ç¹çš„å¯¹è±¡åˆ›å»º
private var _tempArray:Array = []; // é‡ç”¨æ•°ç»„å¯¹è±¡

// å­—ç¬¦ä¸²è¿æ¥çš„ä¼˜åŒ–
private function _buildErrorMessage(parts:Array):String {
    // AS2ä¸­Array.joinæ¯”å­—ç¬¦ä¸²è¿æ¥æ›´é«˜æ•ˆ
    return parts.join("");
}

// æµ®ç‚¹æ•°ç²¾åº¦çš„ä¿®æ­£
private static function _normalize(n:Number):Number {
    // ä¿®æ­£æµ®ç‚¹æ•°è¿ç®—è¯¯å·®
    return Math.abs(n - Math.round(n)) < 1e-9 ? Math.round(n) : n;
}
```

---

## 4. æ€§èƒ½ä¼˜åŒ–ä¸ç¼“å­˜ç­–ç•¥

### 4.1 ä¸¤çº§ç¼“å­˜æœºåˆ¶

#### ç¼“å­˜æ¶æ„è®¾è®¡

æœ¬ç³»ç»Ÿå®ç°äº†ä¸€å¥—ç²¾å¿ƒè®¾è®¡çš„**ä¸¤çº§ç¼“å­˜æ¶æ„**ï¼Œåœ¨ä¿è¯æ­£ç¡®æ€§çš„å‰æä¸‹æœ€å¤§åŒ–æ€§èƒ½ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             ç¼“å­˜å±‚æ¬¡ç»“æ„                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  L1: ç»“æœç¼“å­˜ (_resultCache)            â”‚
â”‚  â”œâ”€ Key: String (è¡¨è¾¾å¼æ–‡æœ¬)             â”‚
â”‚  â”œâ”€ Value: Any (æœ€ç»ˆè®¡ç®—ç»“æœ)            â”‚
â”‚  â”œâ”€ å‘½ä¸­ç‡: >95% (ç”Ÿäº§ç¯å¢ƒ)              â”‚
â”‚  â””â”€ å¤±æ•ˆæ¡ä»¶: ä¸Šä¸‹æ–‡å˜åŒ–                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  L2: ASTç¼“å­˜ (_expressionCache)         â”‚
â”‚  â”œâ”€ Key: String (è¡¨è¾¾å¼æ–‡æœ¬)             â”‚  
â”‚  â”œâ”€ Value: PrattExpression (ASTå¯¹è±¡)     â”‚
â”‚  â”œâ”€ å‘½ä¸­ç‡: ~80% (ç»“æœç¼“å­˜æœªå‘½ä¸­æ—¶)       â”‚
â”‚  â””â”€ å¤±æ•ˆæ¡ä»¶: å‡ ä¹ä¸å¤±æ•ˆ                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç¼“å­˜è®¿é—®æµç¨‹

```actionscript
public function evaluate(expression:String, useCache:Boolean) {
    if (useCache == undefined) useCache = true;
    
    // === L1: ç»“æœç¼“å­˜æ£€æŸ¥ ===
    if (useCache && _resultCache[expression] !== undefined) {
        return _resultCache[expression]; // æœ€å¿«è·¯å¾„ï¼šç›´æ¥è¿”å›
    }

    var ast:PrattExpression;
    
    // === L2: ASTç¼“å­˜æ£€æŸ¥ ===
    if (useCache && _expressionCache[expression]) {
        ast = _expressionCache[expression]; // è·³è¿‡è§£æï¼Œç›´æ¥æ±‚å€¼
    } else {
        // === å®Œæ•´è§£æè·¯å¾„ ===
        var lexer:PrattLexer = new PrattLexer(expression);
        var parser:PrattParser = new PrattParser(lexer);
        ast = parser.parse();
        
        // ç¼“å­˜æ–°è§£æçš„AST
        if (useCache) {
            _expressionCache[expression] = ast;
        }
    }
    
    // === æ±‚å€¼å¹¶ç¼“å­˜ç»“æœ ===
    var result = ast.evaluate(_context);
    
    if (useCache) {
        _resultCache[expression] = result;
    }
    
    return result;
}
```

#### ç¼“å­˜æ€§èƒ½åˆ†æ

| ç¼“å­˜å±‚çº§ | å¹³å‡è®¿é—®æ—¶é—´ | å†…å­˜å ç”¨/é¡¹ | é€‚ç”¨åœºæ™¯ |
|---------|-------------|------------|----------|
| L1 ç»“æœç¼“å­˜ | ~0.01ms | ~8 bytes | ä¸Šä¸‹æ–‡æœªå˜åŒ–çš„é‡å¤æ±‚å€¼ |
| L2 ASTç¼“å­˜ | ~0.1ms | ~200 bytes | ä¸Šä¸‹æ–‡å˜åŒ–ä½†è¡¨è¾¾å¼ç›¸åŒ |
| æ— ç¼“å­˜ | ~2-10ms | 0 | åŠ¨æ€è¡¨è¾¾å¼æˆ–è°ƒè¯•æ¨¡å¼ |

### 4.2 ç¼“å­˜ä¸€è‡´æ€§ç­–ç•¥

#### æ™ºèƒ½ç¼“å­˜å¤±æ•ˆ

ç³»ç»Ÿé‡‡ç”¨**ç²¾ç¡®å¤±æ•ˆ**ç­–ç•¥ï¼Œåªåœ¨å¿…è¦æ—¶æ¸…é™¤ç›¸å…³ç¼“å­˜ï¼š

```actionscript
public function setVariable(name:String, value):Void {
    _context[name] = value;
    
    // åªæ¸…é™¤ç»“æœç¼“å­˜ï¼Œä¿ç•™ASTç¼“å­˜
    _resultCache = {}; 
    
    // ASTç¼“å­˜ä¿ç•™çš„åŸå› ï¼š
    // 1. è¡¨è¾¾å¼çš„è¯­æ³•ç»“æ„æœªå˜åŒ–
    // 2. é‡æ–°è§£ææˆæœ¬é«˜ï¼ŒASTé‡ç”¨å®‰å…¨
    // 3. å†…å­˜å ç”¨ç›¸å¯¹è¾ƒå°
}

public function clearContext():Void {
    _context = {};
    _resultCache = {};     // æ¸…é™¤ç»“æœç¼“å­˜
    _expressionCache = {}; // æ¸…é™¤ASTç¼“å­˜
    _initializeBuiltins(); // é‡æ–°åˆå§‹åŒ–å†…ç½®å‡½æ•°
}
```

#### ç¼“å­˜é”®çš„è®¾è®¡

```actionscript
// ç¼“å­˜é”®å°±æ˜¯è¡¨è¾¾å¼çš„åŸå§‹å­—ç¬¦ä¸²
var key:String = "player.level * 2 + bonus(5)";

// ä¼˜åŠ¿ï¼š
// 1. ç®€å•ç›´æ¥ï¼Œæ— éœ€é¢å¤–è®¡ç®—hash
// 2. è°ƒè¯•å‹å¥½ï¼Œå¯ç›´æ¥æŸ¥çœ‹ç¼“å­˜å†…å®¹
// 3. å­—ç¬¦ä¸²æ¯”è¾ƒåœ¨AS2ä¸­æ•ˆç‡è¾ƒé«˜

// æ½œåœ¨é—®é¢˜åŠè§£å†³æ–¹æ¡ˆï¼š
// 1. ç©ºæ ¼æ•æ„Ÿï¼š"a+b" != "a + b"
//    è§£å†³ï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­è§„èŒƒåŒ–è¡¨è¾¾å¼æ ¼å¼
// 2. å†…å­˜å ç”¨ï¼šé•¿è¡¨è¾¾å¼ä½œä¸ºé”®å ç”¨è¾ƒå¤šå†…å­˜
//    è§£å†³ï¼šåœ¨å†…å­˜æ•æ„Ÿåœºæ™¯ä¸‹å¯è€ƒè™‘hashé”®
```

#### ç¼“å­˜ç»Ÿè®¡ä¸ç›‘æ§

```actionscript
// ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯ï¼ˆç”¨äºæ€§èƒ½åˆ†æï¼‰
private var _cacheStats:Object = {
    resultHits: 0,      // L1ç¼“å­˜å‘½ä¸­æ¬¡æ•°
    resultMisses: 0,    // L1ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°  
    astHits: 0,         // L2ç¼“å­˜å‘½ä¸­æ¬¡æ•°
    astMisses: 0,       // L2ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°
    totalEvaluations: 0 // æ€»æ±‚å€¼æ¬¡æ•°
};

public function getCacheStats():Object {
    var stats = _cacheStats;
    return {
        resultHitRate: stats.resultHits / (stats.resultHits + stats.resultMisses),
        astHitRate: stats.astHits / (stats.astHits + stats.astMisses),
        overallEfficiency: (stats.resultHits + stats.astHits) / stats.totalEvaluations
    };
}
```

### 4.3 æ€§èƒ½åŸºå‡†æµ‹è¯•å·¥å…·

#### åŸºå‡†æµ‹è¯•çš„å®ç°

```actionscript
public function benchmark(expression:String, iterations:Number):Object {
    if (iterations <= 0) iterations = 1000;
    
    // é¢„çƒ­ï¼šé¿å…é¦–æ¬¡è°ƒç”¨çš„å¼€é”€å½±å“æµ‹è¯•ç»“æœ
    for (var i = 0; i < 10; i++) {
        evaluate(expression, false);
    }
    
    var startTime:Number = getTimer();
    
    // æ ¸å¿ƒæµ‹è¯•å¾ªç¯ï¼šç¦ç”¨ç¼“å­˜ä»¥æµ‹é‡çœŸå®æ€§èƒ½
    for (var i = 0; i < iterations; i++) {
        evaluate(expression, false);
    }
    
    var totalTime:Number = getTimer() - startTime;
    
    return {
        expression: expression,
        iterations: iterations,
        totalTime: totalTime,
        averageTime: totalTime / iterations,
        throughput: iterations / (totalTime / 1000), // æ¯ç§’å¤„ç†æ¬¡æ•°
        
        // è¯¦ç»†çš„æ€§èƒ½åˆ†çº§
        complexity: _analyzeComplexity(expression),
        performance: _categorizePerformance(totalTime / iterations)
    };
}

// è¡¨è¾¾å¼å¤æ‚åº¦åˆ†æ
private function _analyzeComplexity(expr:String):String {
    var operators = expr.match(/[+\-*/()]/g).length;
    var functions = expr.match(/\w+\s*\(/g).length;
    var properties = expr.match(/\.\w+/g).length;
    
    var score = operators + functions * 2 + properties;
    
    if (score < 5) return "SIMPLE";
    if (score < 15) return "MEDIUM"; 
    if (score < 30) return "COMPLEX";
    return "VERY_COMPLEX";
}
```

#### æ€§èƒ½åŸºå‡†å‚è€ƒ

| è¡¨è¾¾å¼ç±»å‹ | ç¤ºä¾‹ | å¹³å‡è€—æ—¶ | ååé‡ |
|-----------|------|---------|--------|
| ç®€å•ç®—æœ¯ | `a + b * 2` | ~0.1ms | ~10000/s |
| å‡½æ•°è°ƒç”¨ | `max(a, b, c)` | ~0.3ms | ~3000/s |
| å±æ€§è®¿é—® | `player.stats.attack` | ~0.2ms | ~5000/s |
| å¤æ‚è¡¨è¾¾å¼ | `(a+b)*func(c.d, e?f:g)` | ~1.0ms | ~1000/s |
| æ·±åº¦åµŒå¥— | `f(g(h(i(j(k())))))` | ~2.0ms | ~500/s |

### 4.4 å†…å­˜ç®¡ç†ä¸ä¼˜åŒ–

#### å¯¹è±¡é‡ç”¨ç­–ç•¥

```actionscript
// é‡ç”¨ä¸´æ—¶å¯¹è±¡ï¼Œå‡å°‘GCå‹åŠ›
private var _tempTokenArray:Array = [];
private var _tempArgArray:Array = [];

private function _reuseArray(arr:Array):Array {
    arr.length = 0; // æ¸…ç©ºä½†ä¿ç•™æ•°ç»„å¯¹è±¡
    return arr;
}

// åœ¨è§£æè¿‡ç¨‹ä¸­é‡ç”¨æ•°ç»„
var args:Array = _reuseArray(_tempArgArray);
args.push(arg1, arg2, arg3);
```

#### å†…å­˜æ³„æ¼é¢„é˜²

```actionscript
// ç¼“å­˜å¤§å°é™åˆ¶ï¼Œé˜²æ­¢æ— é™å¢é•¿
private static var MAX_CACHE_SIZE:Number = 1000;

private function _enforceMaxCacheSize():Void {
    var count:Number = 0;
    for (var key:String in _resultCache) {
        count++;
    }
    
    if (count > MAX_CACHE_SIZE) {
        // ç®€å•çš„LRUï¼šæ¸…ç©ºæœ€è€çš„ä¸€åŠç¼“å­˜
        _resultCache = {};
        trace("Cache cleared due to size limit");
    }
}

// æ˜¾å¼æ¸…ç†æ–¹æ³•
public function dispose():Void {
    _context = null;
    _resultCache = null;
    _expressionCache = null;
    _parser = null;
}
```

#### WeakReferenceæ¨¡æ‹Ÿï¼ˆAS2ç¯å¢ƒï¼‰

```actionscript
// ç”±äºAS2ç¼ºä¹WeakReferenceï¼Œä½¿ç”¨å®šæ—¶æ¸…ç†ç­–ç•¥
private var _lastCleanupTime:Number = 0;
private static var CLEANUP_INTERVAL:Number = 60000; // 1åˆ†é’Ÿ

private function _periodicCleanup():Void {
    var now:Number = getTimer();
    if (now - _lastCleanupTime > CLEANUP_INTERVAL) {
        _enforceMaxCacheSize();
        _lastCleanupTime = now;
    }
}
```

---

## 5. é”™è¯¯å¤„ç†ä¸è°ƒè¯•

### 5.1 é”™è¯¯ç±»å‹åˆ†æ

#### é”™è¯¯åˆ†ç±»ä½“ç³»

æœ¬ç³»ç»Ÿçš„é”™è¯¯å¤„ç†è¦†ç›–äº†ä»è¯æ³•åˆ†æåˆ°è¿è¡Œæ—¶æ±‚å€¼çš„æ•´ä¸ªé“¾è·¯ï¼š

```
é”™è¯¯ç±»å‹å±‚æ¬¡ç»“æ„:
â”œâ”€ è¯æ³•é”™è¯¯ (Lexical Errors)
â”‚  â”œâ”€ éæ³•å­—ç¬¦: "æ— æ³•è¯†åˆ«çš„å­—ç¬¦ '@' at line 1, column 5"
â”‚  â”œâ”€ æœªé—­åˆå­—ç¬¦ä¸²: "æœªç»ˆæ­¢çš„å­—ç¬¦ä¸² at line 2, column 10"
â”‚  â””â”€ éæ³•æ•°å­—æ ¼å¼: "Invalid number format '123.45.67'"
â”‚
â”œâ”€ è¯­æ³•é”™è¯¯ (Syntax Errors)  
â”‚  â”œâ”€ ç¼ºå°‘æ“ä½œæ•°: "Expected expression after '+'"
â”‚  â”œâ”€ æ‹¬å·ä¸åŒ¹é…: "Expected ')' but got EOF"
â”‚  â”œâ”€ éæ³•çš„è¯­æ³•ç»“æ„: "Invalid object key"
â”‚  â””â”€ è¿ç®—ç¬¦ä½¿ç”¨é”™è¯¯: "Cannot use '**' as prefix operator"
â”‚
â”œâ”€ è¯­ä¹‰é”™è¯¯ (Semantic Errors)
â”‚  â”œâ”€ å˜é‡æœªå®šä¹‰: "Undefined variable: playerStats"
â”‚  â”œâ”€ å‡½æ•°ä¸å­˜åœ¨: "Unknown function: calculateBonus"
â”‚  â”œâ”€ ç±»å‹é”™è¯¯: "Cannot call property 'name' as function"
â”‚  â””â”€ å‚æ•°é”™è¯¯: "Function 'max' expects at least 1 argument"
â”‚
â””â”€ è¿è¡Œæ—¶é”™è¯¯ (Runtime Errors)
   â”œâ”€ é™¤é›¶é”™è¯¯: "Division by zero"
   â”œâ”€ ç©ºå¼•ç”¨: "Cannot access property 'level' of null"
   â”œâ”€ æ•°ç»„è¶Šç•Œ: "Array index out of bounds"
   â””â”€ æ ˆæº¢å‡º: "Maximum call stack size exceeded"
```

#### é”™è¯¯ä¿¡æ¯çš„æ ‡å‡†åŒ–

```actionscript
// ç»Ÿä¸€çš„é”™è¯¯åˆ›å»ºæœºåˆ¶
class PrattError extends Error {
    public var errorType:String;
    public var line:Number;
    public var column:Number;
    public var expression:String;
    
    public function PrattError(type:String, message:String, token:PrattToken, expr:String) {
        super(message);
        this.errorType = type;
        this.line = token ? token.line : 0;
        this.column = token ? token.column : 0;
        this.expression = expr;
    }
    
    public function getDetailedMessage():String {
        var msg:String = "[" + errorType + "] " + message;
        if (line > 0) {
            msg += " at line " + line + ", column " + column;
        }
        if (expression) {
            msg += "\nExpression: " + expression;
            if (column > 0) {
                msg += "\n" + _createPointer(column);
            }
        }
        return msg;
    }
    
    private function _createPointer(col:Number):String {
        var pointer:String = "";
        for (var i = 0; i < col - 1; i++) {
            pointer += " ";
        }
        return pointer + "^";
    }
}
```

### 5.2 è°ƒè¯•å·¥å…·ä¸æŠ€å·§

#### ASTå¯è§†åŒ–å·¥å…·

```actionscript
// ASTç»“æ„çš„å¯è§†åŒ–è¾“å‡º
public function visualizeAST(expression:String):String {
    try {
        var ast:PrattExpression = parse(expression);
        return _formatAST(ast, 0);
    } catch (e) {
        return "Parse Error: " + e.message;
    }
}

private function _formatAST(node:PrattExpression, indent:Number):String {
    var spaces:String = "";
    for (var i = 0; i < indent; i++) spaces += "  ";
    
    var result:String = spaces + node.type;
    
    switch (node.type) {
        case PrattExpression.LITERAL:
            result += ": " + node.value;
            break;
            
        case PrattExpression.IDENTIFIER:
            result += ": " + node.name;
            break;
            
        case PrattExpression.BINARY:
            result += ": " + node.operator + "\n";
            result += _formatAST(node.left, indent + 1) + "\n";
            result += _formatAST(node.right, indent + 1);
            break;
            
        case PrattExpression.FUNCTION_CALL:
            result += ": " + node.functionExpr.name + "\n";
            for (var i = 0; i < node.arguments.length; i++) {
                result += _formatAST(node.arguments[i], indent + 1);
                if (i < node.arguments.length - 1) result += "\n";
            }
            break;
    }
    
    return result;
}

// è¾“å‡ºç¤ºä¾‹:
// visualizeAST("a + b * func(c)")
// BINARY: +
//   IDENTIFIER: a
//   BINARY: *
//     IDENTIFIER: b
//     FUNCTION_CALL: func
//       IDENTIFIER: c
```

#### æ‰§è¡Œè¿½è¸ªå™¨

```actionscript
// è¡¨è¾¾å¼æ±‚å€¼çš„æ­¥éª¤è¿½è¸ª
public function traceEvaluation(expression:String):Array {
    var steps:Array = [];
    var ast:PrattExpression = parse(expression);
    
    _traceEvaluateNode(ast, _context, steps, "");
    
    return steps;
}

private function _traceEvaluateNode(node:PrattExpression, context:Object, 
                                   steps:Array, path:String) {
    var stepInfo:Object = {
        path: path,
        type: node.type,
        input: _nodeToString(node),
        context: _extractRelevantContext(node, context)
    };
    
    try {
        stepInfo.result = node.evaluate(context);
        stepInfo.success = true;
    } catch (e) {
        stepInfo.error = e.message;
        stepInfo.success = false;
    }
    
    steps.push(stepInfo);
}

// ä½¿ç”¨ç¤ºä¾‹:
// var trace = evaluator.traceEvaluation("player.level + bonus(5)");
// trace åŒ…å«æ¯ä¸ªå­è¡¨è¾¾å¼çš„æ±‚å€¼æ­¥éª¤å’Œç»“æœ
```

#### æ€§èƒ½åˆ†æå™¨

```actionscript
// ç»†ç²’åº¦çš„æ€§èƒ½åˆ†æ
public function profileExpression(expression:String):Object {
    var profile:Object = {
        totalTime: 0,
        parseTime: 0,
        evaluateTime: 0,
        cacheStatus: "MISS",
        nodeCount: 0,
        maxDepth: 0
    };
    
    var startTime:Number = getTimer();
    
    // è§£æé˜¶æ®µè®¡æ—¶
    var parseStart:Number = getTimer();
    var ast:PrattExpression = parse(expression);
    profile.parseTime = getTimer() - parseStart;
    
    // ASTåˆ†æ
    profile.nodeCount = _countNodes(ast);
    profile.maxDepth = _calculateDepth(ast);
    
    // æ±‚å€¼é˜¶æ®µè®¡æ—¶
    var evalStart:Number = getTimer();
    var result = ast.evaluate(_context);
    profile.evaluateTime = getTimer() - evalStart;
    
    profile.totalTime = getTimer() - startTime;
    profile.result = result;
    
    return profile;
}
```

### 5.3 å®¹é”™æœºåˆ¶

#### å®‰å…¨æ±‚å€¼æ¥å£

```actionscript
public function evaluateSafe(expression:String, defaultValue, options:Object) {
    // optionså¯ä»¥åŒ…å«ï¼šmaxRetries, timeout, validationModeç­‰
    options = options || {};
    
    // 1. å¿«é€Ÿè¯­æ³•é¢„æ£€æŸ¥
    if (options.validateFirst !== false) {
        var validation = validate(expression);
        if (!validation.valid) {
            _logError("Validation failed", expression, validation.error);
            return defaultValue;
        }
    }
    
    // 2. æ‰§è¡Œæ±‚å€¼ï¼Œæ•è·æ‰€æœ‰å¯èƒ½çš„å¼‚å¸¸
    try {
        var result = evaluate(expression);
        
        // 3. ç»“æœç±»å‹éªŒè¯ï¼ˆå¯é€‰ï¼‰
        if (options.expectedType && !_validateResultType(result, options.expectedType)) {
            _logError("Type mismatch", expression, "Expected " + options.expectedType);
            return defaultValue;
        }
        
        return result;
        
    } catch (e) {
        // 4. å¼‚å¸¸åˆ†ç±»å¤„ç†
        _logError(e.name || "Unknown error", expression, e.message);
        
        // 5. é‡è¯•æœºåˆ¶ï¼ˆå¯¹äºå¯èƒ½æ˜¯ä¸´æ—¶æ€§çš„é”™è¯¯ï¼‰
        if (options.maxRetries > 0 && _isRetryableError(e)) {
            options.maxRetries--;
            return evaluateSafe(expression, defaultValue, options);
        }
        
        return defaultValue;
    }
}

// é”™è¯¯åˆ†ç±»ï¼šåˆ¤æ–­æ˜¯å¦å¯é‡è¯•
private function _isRetryableError(error:Error):Boolean {
    var retryablePatterns:Array = [
        "timeout", "network", "temporary", "lock"
    ];
    
    var message:String = error.message.toLowerCase();
    for (var i = 0; i < retryablePatterns.length; i++) {
        if (message.indexOf(retryablePatterns[i]) >= 0) {
            return true;
        }
    }
    return false;
}
```

#### æ¸è¿›å¼é”™è¯¯æ¢å¤

```actionscript
// éƒ¨åˆ†æ±‚å€¼ï¼šå³ä½¿è¡¨è¾¾å¼çš„ä¸€éƒ¨åˆ†å‡ºé”™ï¼Œä¹Ÿå°è¯•è®¡ç®—å…¶ä»–éƒ¨åˆ†
public function evaluatePartial(expression:String):Object {
    var ast:PrattExpression = parse(expression);
    var results:Object = {
        success: false,
        fullResult: null,
        partialResults: [],
        errors: []
    };
    
    try {
        results.fullResult = ast.evaluate(_context);
        results.success = true;
    } catch (e) {
        // å…¨é‡æ±‚å€¼å¤±è´¥ï¼Œå°è¯•éƒ¨åˆ†æ±‚å€¼
        _collectPartialResults(ast, _context, results);
    }
    
    return results;
}

private function _collectPartialResults(node:PrattExpression, context:Object, results:Object):Void {
    try {
        var value = node.evaluate(context);
        results.partialResults.push({
            path: _getNodePath(node),
            type: node.type,
            value: value
        });
    } catch (e) {
        results.errors.push({
            path: _getNodePath(node),
            error: e.message
        });
        
        // é€’å½’å°è¯•å­èŠ‚ç‚¹
        if (node.left) _collectPartialResults(node.left, context, results);
        if (node.right) _collectPartialResults(node.right, context, results);
    }
}
```

#### é”™è¯¯æ¢å¤ç­–ç•¥

```actionscript
// æ™ºèƒ½çš„é”™è¯¯æ¢å¤å’Œå»ºè®®
public function suggestFixes(expression:String, error:Error):Array {
    var suggestions:Array = [];
    var errorMsg:String = error.message.toLowerCase();
    
    // å˜é‡åæ‹¼å†™å»ºè®®
    if (errorMsg.indexOf("undefined variable") >= 0) {
        var varName:String = _extractVarName(error.message);
        var similar:Array = _findSimilarVariables(varName);
        
        for (var i = 0; i < similar.length; i++) {
            suggestions.push({
                type: "TYPO_FIX",
                original: varName,
                suggestion: similar[i],
                confidence: _calculateSimilarity(varName, similar[i])
            });
        }
    }
    
    // å‡½æ•°åå»ºè®®
    if (errorMsg.indexOf("unknown function") >= 0) {
        var funcName:String = _extractFuncName(error.message);
        var availableFuncs:Array = _getAvailableFunctions();
        
        suggestions.push({
            type: "FUNCTION_LIST",
            available: availableFuncs,
            mostSimilar: _findMostSimilar(funcName, availableFuncs)
        });
    }
    
    // è¯­æ³•ä¿®å¤å»ºè®®
    if (errorMsg.indexOf("expected") >= 0) {
        suggestions.push({
            type: "SYNTAX_FIX",
            hint: "Check for missing parentheses, quotes, or operators",
            examples: ["func()", "obj.prop", "a + b"]
        });
    }
    
    return suggestions;
}
```

---

## 6. åº”ç”¨åœºæ™¯ä¸é›†æˆ

### 6.1 é€‚ç”¨ç¯å¢ƒ

#### ä¸»è¦è¿è¡Œç¯å¢ƒ

**Flash Player ç”Ÿæ€ç³»ç»Ÿ**
- **Flash Player 6-8**ï¼šæ ¸å¿ƒç›®æ ‡ç¯å¢ƒï¼ŒAS2çš„åŸç”Ÿè¿è¡Œæ—¶
- **Adobe AIR (Legacy)**ï¼šæ¡Œé¢åº”ç”¨éƒ¨ç½²ï¼Œæ”¯æŒæ–‡ä»¶ç³»ç»Ÿè®¿é—®
- **Adobe Flex 1.x-2.x**ï¼šå¯Œäº’è”ç½‘åº”ç”¨æ¡†æ¶
- **Red5 Server**ï¼šJava-based FlashæœåŠ¡å™¨ï¼Œæ”¯æŒæœåŠ¡ç«¯AS2æ‰§è¡Œ

**ç¯å¢ƒå…¼å®¹æ€§çŸ©é˜µ**

| ç¯å¢ƒ | å…¼å®¹æ€§ | ç‰¹æ®Šè¯´æ˜ |
|------|--------|----------|
| Flash Player 6 | âœ… å®Œå…¨æ”¯æŒ | æœ€å°å…¼å®¹ç‰ˆæœ¬ |
| Flash Player 7-8 | âœ… å®Œå…¨æ”¯æŒ | æ¨èç‰ˆæœ¬ï¼Œæ€§èƒ½æœ€ä½³ |
| Flash Player 9+ | âš ï¸ éƒ¨åˆ†æ”¯æŒ | AS3ä¼˜å…ˆï¼ŒAS2å‘åå…¼å®¹ |
| Adobe AIR 1.x | âœ… å®Œå…¨æ”¯æŒ | æ”¯æŒæ¡Œé¢åº”ç”¨ |
| Red5 Server | âœ… å®Œå…¨æ”¯æŒ | æœåŠ¡ç«¯æ‰§è¡Œ |
| MTASCç¼–è¯‘å™¨ | âœ… å®Œå…¨æ”¯æŒ | å¼€æºAS2ç¼–è¯‘å™¨ |

#### ç°ä»£åŒ–ç§»æ¤æ½œåŠ›

**é«˜ç§»æ¤æ€§è®¾è®¡**
```javascript
// ç³»ç»Ÿçš„æ ¸å¿ƒç®—æ³•ä¸AS2ç‰¹æ€§è€¦åˆåº¦æä½ï¼Œç§»æ¤åˆ°ç°ä»£è¯­è¨€éå¸¸ç›´æ¥ï¼š

// TypeScriptç§»æ¤ç¤ºä¾‹
class PrattToken {
    constructor(
        public type: TokenType,
        public text: string,
        public line: number = 0,
        public column: number = 0,
        public value?: any
    ) {
        if (value === undefined) {
            this.value = this.calculateValue();
        }
    }
}

// JavaScriptç§»æ¤ç¤ºä¾‹  
class PrattEvaluator {
    constructor() {
        this._context = new Map();        // æ›¿ä»£AS2çš„Object
        this._resultCache = new Map();    // ç°ä»£Map API
        this._expressionCache = new Map();
        this.initializeBuiltins();
    }
}
```

**ç§»æ¤æ”¶ç›Šåˆ†æ**
- **æ€§èƒ½æå‡**ï¼šç°ä»£JITç¼–è¯‘å™¨å¸¦æ¥5-10xæ€§èƒ½æå‡
- **åŠŸèƒ½å¢å¼º**ï¼šES6+ç‰¹æ€§ï¼ˆç®­å¤´å‡½æ•°ã€è§£æ„ã€æ¨¡å—åŒ–ï¼‰
- **å·¥å…·é“¾å®Œå–„**ï¼šTypeScriptç±»å‹æ£€æŸ¥ã€ç°ä»£è°ƒè¯•å·¥å…·
- **ç”Ÿæ€ä¸°å¯Œ**ï¼šNPMç”Ÿæ€ã€ç°ä»£æµ‹è¯•æ¡†æ¶

### 6.2 å…¸å‹åº”ç”¨åœºæ™¯

#### æ¸¸æˆå¼€å‘é¢†åŸŸ

**1. åŠ¨æ€æˆ˜æ–—å…¬å¼ç³»ç»Ÿ**
```actionscript
// å¤æ‚çš„ä¼¤å®³è®¡ç®—å…¬å¼
var damageEvaluator = PrattEvaluator.createForBuff();

// è®¾ç½®æ¸¸æˆæ•°æ®ä¸Šä¸‹æ–‡
damageEvaluator.setVariable("attacker", {
    level: 50,
    attack: 120,
    critRate: 0.25,
    weapon: {damage: 80, enchant: 15}
});

damageEvaluator.setVariable("target", {
    level: 45, 
    defense: 90,
    resistance: 0.1,
    buffs: [{type: "shield", value: 0.2}]
});

// åŠ¨æ€ä¼¤å®³å…¬å¼
var formula = `
    (attacker.attack + attacker.weapon.damage + attacker.weapon.enchant) 
    * (1 + (attacker.level - target.level) * 0.02)
    * (random() < attacker.critRate ? 2.0 : 1.0)
    - target.defense * (1 - target.resistance)
    * (hasShield(target.buffs) ? 0.8 : 1.0)
`;

var damage = damageEvaluator.evaluateSafe(formula, 0);
trace("è®¡ç®—ä¼¤å®³: " + damage);
```

**2. Buff/Debuffæ•ˆæœç³»ç»Ÿ**
```actionscript
// ä¸“ç”¨çš„Buffç³»ç»Ÿæ±‚å€¼å™¨
var buffEvaluator = PrattEvaluator.createForBuff();

// Buffé…ç½®æ•°æ®ï¼ˆé€šå¸¸æ¥è‡ªé…ç½®æ–‡ä»¶æˆ–æ•°æ®åº“ï¼‰
var buffConfigs = [
    {
        id: "strength_potion",
        effect: "ADD_PERCENT_BASE(player.level * 0.1)",
        duration: 300,
        stackable: false
    },
    {
        id: "berser_rage", 
        effect: "MUL_PERCENT(50) + CLAMP_MAX(player.health * 0.8)",
        duration: 60,
        stackable: true,
        maxStacks: 3
    },
    {
        id: "weakness_curse",
        effect: "ADD_PERCENT_CURRENT(-25) + ADD_FINAL(-10)",
        duration: 120,
        removable: true
    }
];

// åº”ç”¨Buffæ•ˆæœ
function applyBuff(playerId, buffId) {
    var config = findBuffConfig(buffId);
    var effect = buffEvaluator.evaluate(config.effect);
    
    // effect è¿”å›æ“ä½œæè¿°å¯¹è±¡ï¼Œå¦‚ {type: "ADD_PERCENT_BASE", value: 5}
    BuffManager.applyEffect(playerId, effect, config.duration);
}
```

**3. AIè¡Œä¸ºå†³ç­–æ ‘**
```actionscript
// AIå†³ç­–è¡¨è¾¾å¼
var aiEvaluator = PrattEvaluator.createStandard();

// è®¾ç½®AIæ„ŸçŸ¥æ•°æ®
aiEvaluator.setVariable("self", {
    health: 0.6, mana: 0.8, position: {x: 100, y: 200}
});
aiEvaluator.setVariable("target", {
    health: 0.3, distance: 150, isVisible: true
});
aiEvaluator.setVariable("environment", {
    hasAllies: true, isSafe: false, timeOfDay: "night"
});

// å¤æ‚çš„AIå†³ç­–é€»è¾‘
var aiDecisions = [
    {
        condition: "self.health < 0.2 && hasEscapeRoute()",
        action: "RETREAT",
        priority: 10
    },
    {
        condition: "target.health < 0.1 && target.distance < 50",
        action: "EXECUTE_FINISHER", 
        priority: 9
    },
    {
        condition: "self.mana > 0.5 && target.distance < 200 && target.isVisible",
        action: "CAST_SPELL",
        priority: 8
    },
    {
        condition: "environment.hasAllies && !environment.isSafe",
        action: "CALL_FOR_HELP",
        priority: 7
    }
];

// AIå†³ç­–å¾ªç¯
function makeAIDecision() {
    for (var i = 0; i < aiDecisions.length; i++) {
        var decision = aiDecisions[i];
        if (aiEvaluator.evaluateSafe(decision.condition, false)) {
            return {action: decision.action, priority: decision.priority};
        }
    }
    return {action: "IDLE", priority: 0};
}
```

#### ä¸šåŠ¡è§„åˆ™å¼•æ“

**1. ç”µå•†æŠ˜æ‰£è§„åˆ™**
```actionscript
// å¤æ‚çš„ä¿ƒé”€è§„åˆ™å¼•æ“
var discountEvaluator = PrattEvaluator.createStandard();

// æ³¨å†Œè‡ªå®šä¹‰å‡½æ•°
discountEvaluator.setFunction("daysSinceLastOrder", function(customerId) {
    return CustomerDB.getDaysSinceLastOrder(customerId);
});

discountEvaluator.setFunction("isVipMember", function(customerId) {
    return CustomerDB.getVipStatus(customerId);
});

discountEvaluator.setFunction("categoryCount", function(order, category) {
    return OrderUtils.countItemsByCategory(order, category);
});

// ä¿ƒé”€è§„åˆ™é…ç½®
var promotionRules = [
    {
        name: "æ–°ç”¨æˆ·é¦–å•æŠ˜æ‰£",
        condition: "daysSinceLastOrder(customer.id) == -1 && order.amount > 100",
        discount: "min(order.amount * 0.2, 50)",
        code: "FIRST_ORDER"
    },
    {
        name: "VIPä¸“äº«æŠ˜æ‰£", 
        condition: "isVipMember(customer.id) && order.amount > 500",
        discount: "order.amount * 0.15",
        code: "VIP_DISCOUNT"
    },
    {
        name: "å“ç±»æ»¡å‡",
        condition: "categoryCount(order, 'electronics') >= 3",
        discount: "50 + categoryCount(order, 'electronics') * 10",
        code: "CATEGORY_BULK"
    },
    {
        name: "èŠ‚æ—¥ç‰¹æƒ ",
        condition: "isHoliday() && order.amount > 200",
        discount: "order.amount * (isWeekend() ? 0.25 : 0.2)",
        code: "HOLIDAY_SPECIAL"
    }
];

// è®¡ç®—æœ€ä¼˜æŠ˜æ‰£
function calculateBestDiscount(order, customer) {
    discountEvaluator.setVariable("order", order);
    discountEvaluator.setVariable("customer", customer);
    
    var bestDiscount = {amount: 0, rule: null};
    
    for (var i = 0; i < promotionRules.length; i++) {
        var rule = promotionRules[i];
        
        if (discountEvaluator.evaluateSafe(rule.condition, false)) {
            var discountAmount = discountEvaluator.evaluateSafe(rule.discount, 0);
            
            if (discountAmount > bestDiscount.amount) {
                bestDiscount = {
                    amount: discountAmount,
                    rule: rule,
                    savings: discountAmount,
                    finalAmount: order.amount - discountAmount
                };
            }
        }
    }
    
    return bestDiscount;
}
```

**2. åŠ¨æ€è¡¨å•éªŒè¯**
```actionscript
// å¤æ‚è¡¨å•éªŒè¯è§„åˆ™
var validationEvaluator = PrattEvaluator.createStandard();

// è‡ªå®šä¹‰éªŒè¯å‡½æ•°
validationEvaluator.setFunction("isEmail", function(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
});

validationEvaluator.setFunction("isStrongPassword", function(pwd) {
    return pwd.length >= 8 && /[A-Z]/.test(pwd) && /[0-9]/.test(pwd);
});

validationEvaluator.setFunction("isAdult", function(birthDate) {
    var age = (new Date().getTime() - birthDate.getTime()) / (365.25 * 24 * 3600 * 1000);
    return age >= 18;
});

// åŠ¨æ€éªŒè¯è§„åˆ™
var validationRules = {
    "user_registration": [
        {
            field: "email",
            rule: "isEmail(email) && email.length <= 100",
            message: "è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€ï¼ˆä¸è¶…è¿‡100å­—ç¬¦ï¼‰"
        },
        {
            field: "password", 
            rule: "isStrongPassword(password)",
            message: "å¯†ç å¿…é¡»è‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å†™å­—æ¯å’Œæ•°å­—"
        },
        {
            field: "confirmPassword",
            rule: "confirmPassword == password",
            message: "ç¡®è®¤å¯†ç å¿…é¡»ä¸å¯†ç ä¸€è‡´"
        },
        {
            field: "birthDate",
            rule: "isAdult(birthDate)",
            message: "ç”¨æˆ·å¿…é¡»å¹´æ»¡18å²"
        },
        {
            field: "terms",
            rule: "terms == true",
            message: "å¿…é¡»åŒæ„æœåŠ¡æ¡æ¬¾"
        }
    ]
};

function validateForm(formType, formData) {
    var rules = validationRules[formType];
    var errors = [];
    
    validationEvaluator.setVariable("formData", formData);
    
    // å°†è¡¨å•å­—æ®µç›´æ¥æ³¨å…¥åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼Œæ–¹ä¾¿å¼•ç”¨
    for (var field in formData) {
        validationEvaluator.setVariable(field, formData[field]);
    }
    
    for (var i = 0; i < rules.length; i++) {
        var rule = rules[i];
        
        if (!validationEvaluator.evaluateSafe(rule.rule, false)) {
            errors.push({
                field: rule.field,
                message: rule.message,
                rule: rule.rule
            });
        }
    }
    
    return {
        isValid: errors.length == 0,
        errors: errors
    };
}
```

#### é…ç½®åŒ–ç³»ç»Ÿå¼€å‘

**1. åŠ¨æ€UIå¸ƒå±€**
```actionscript
// å“åº”å¼UIé…ç½®ç³»ç»Ÿ
var layoutEvaluator = PrattEvaluator.createStandard();

// å±å¹•å’Œè®¾å¤‡ä¿¡æ¯
layoutEvaluator.setVariable("screen", {
    width: 1920,
    height: 1080,
    dpi: 96,
    aspectRatio: 16/9
});

layoutEvaluator.setVariable("device", {
    type: "desktop", // desktop, tablet, mobile
    orientation: "landscape",
    hasTouch: false
});

// åŠ¨æ€å¸ƒå±€è§„åˆ™
var layoutConfigs = {
    "main_panel": {
        x: "screen.width * 0.1",
        y: "screen.height * 0.05", 
        width: "device.type == 'mobile' ? screen.width * 0.9 : screen.width * 0.8",
        height: "screen.height * 0.85",
        visible: "true"
    },
    
    "sidebar": {
        x: "main_panel.x + main_panel.width + 10",
        y: "main_panel.y",
        width: "device.type == 'mobile' ? 0 : 200",
        height: "main_panel.height",
        visible: "device.type != 'mobile' && screen.width > 1024"
    },
    
    "toolbar": {
        x: "main_panel.x",
        y: "device.type == 'mobile' ? screen.height - 60 : main_panel.y - 40",
        width: "main_panel.width",
        height: "device.type == 'mobile' ? 60 : 35",
        visible: "true"
    }
};

function calculateLayout() {
    var layout = {};
    
    // ç¬¬ä¸€éï¼šè®¡ç®—åŸºç¡€ç»„ä»¶
    for (var componentId in layoutConfigs) {
        var config = layoutConfigs[componentId];
        layout[componentId] = {};
        
        for (var prop in config) {
            layout[componentId][prop] = layoutEvaluator.evaluateSafe(config[prop], 0);
        }
        
        // å°†è®¡ç®—ç»“æœæ³¨å…¥ä¸Šä¸‹æ–‡ï¼Œä¾›å…¶ä»–ç»„ä»¶å¼•ç”¨
        layoutEvaluator.setVariable(componentId, layout[componentId]);
    }
    
    return layout;
}
```

### 6.3 é›†æˆæŒ‡å—

#### å¿«é€Ÿå¼€å§‹

**æ­¥éª¤1ï¼šå¼•å…¥æ ¸å¿ƒæ–‡ä»¶**
```actionscript
// åœ¨æ‚¨çš„ä¸»åº”ç”¨ä¸­å¼•å…¥æ‰€æœ‰æ ¸å¿ƒç±»
import org.flashNight.gesh.pratt.PrattEvaluator;
import org.flashNight.gesh.pratt.PrattExpression;
import org.flashNight.gesh.pratt.PrattToken;

// å¦‚æœéœ€è¦è‡ªå®šä¹‰æ‰©å±•ï¼Œè¿˜å¯ä»¥å¼•å…¥ï¼š
import org.flashNight.gesh.pratt.PrattParser;
import org.flashNight.gesh.pratt.PrattParselet;
import org.flashNight.gesh.pratt.PrattLexer;
```

**æ­¥éª¤2ï¼šé€‰æ‹©åˆé€‚çš„åˆå§‹åŒ–æ–¹å¼**
```actionscript
// æ ‡å‡†é€šç”¨æ±‚å€¼å™¨
var evaluator:PrattEvaluator = PrattEvaluator.createStandard();

// ä¸“ç”¨äºæ¸¸æˆBuffç³»ç»Ÿçš„æ±‚å€¼å™¨ï¼ˆåŒ…å«é¢„ç½®çš„Buffå‡½æ•°ï¼‰
var buffEvaluator:PrattEvaluator = PrattEvaluator.createForBuff();

// è‡ªå®šä¹‰é…ç½®çš„æ±‚å€¼å™¨ï¼ˆé«˜çº§ç”¨æ³•ï¼‰
var customEvaluator:PrattEvaluator = PrattEvaluator.createWithCustomParser(
    function(parser:PrattParser) {
        // æ·»åŠ è‡ªå®šä¹‰è¿ç®—ç¬¦æˆ–è¯­æ³•
        parser.addBuffOperators();
    }
);
```

**æ­¥éª¤3ï¼šé…ç½®åº”ç”¨ä¸Šä¸‹æ–‡**
```actionscript
// æ³¨å…¥åº”ç”¨æ•°æ®
evaluator.setVariable("player", GameManager.getCurrentPlayer());
evaluator.setVariable("gameState", GameManager.getState());
evaluator.setVariable("config", ConfigManager.getGameConfig());

// æ³¨å…¥åº”ç”¨å‡½æ•°
evaluator.setFunction("random", function() {
    return Math.random();
});

evaluator.setFunction("getPlayerStat", function(statName:String) {
    return PlayerManager.getStat(statName);
});

evaluator.setFunction("isQuestCompleted", function(questId:String) {
    return QuestManager.isCompleted(questId);
});
```

**æ­¥éª¤4ï¼šæ‰§è¡Œè¡¨è¾¾å¼**
```actionscript
// åŸºæœ¬æ±‚å€¼
var damage = evaluator.evaluate("player.attack * 1.5 + weapon.bonus");

// å®‰å…¨æ±‚å€¼ï¼ˆæ¨èç”¨äºç”¨æˆ·è¾“å…¥çš„è¡¨è¾¾å¼ï¼‰
var discount = evaluator.evaluateSafe(
    userProvidedFormula, 
    0, // é»˜è®¤å€¼
    {expectedType: "number", validateFirst: true}
);

// æ‰¹é‡æ±‚å€¼
var formulas = [
    "player.health + 50",
    "player.mana * 0.8", 
    "calculateBonus(player.level)"
];
var results = evaluator.evaluateMultiple(formulas);
```

#### æ€§èƒ½ä¼˜åŒ–é›†æˆ

**1. é¢„ç¼–è¯‘å¸¸ç”¨è¡¨è¾¾å¼**
```actionscript
// åœ¨åº”ç”¨å¯åŠ¨æ—¶é¢„ç¼–è¯‘å¸¸ç”¨è¡¨è¾¾å¼ï¼Œå¡«å……ASTç¼“å­˜
var commonExpressions = [
    "player.level * 10",
    "Math.max(a, b, c)",
    "item.price * (1 - discount)",
    "player.stats.attack + weapon.damage"
];

for (var i = 0; i < commonExpressions.length; i++) {
    evaluator.parse(commonExpressions[i]); // åªè§£æä¸æ±‚å€¼ï¼Œå¡«å……ASTç¼“å­˜
}
```

**2. ä¸Šä¸‹æ–‡æ›´æ–°ç­–ç•¥**
```actionscript
// æ‰¹é‡æ›´æ–°ä¸Šä¸‹æ–‡ï¼Œå‡å°‘ç¼“å­˜æ¸…ç†æ¬¡æ•°
function updateGameContext(playerData, gameState, config) {
    // æš‚å­˜å½“å‰ä¸Šä¸‹æ–‡
    var oldContext = evaluator.getContext();
    
    // æ‰¹é‡æ›´æ–°
    evaluator.setVariable("player", playerData);
    evaluator.setVariable("gameState", gameState);
    evaluator.setVariable("config", config);
    
    // åªæ¸…ç†ä¸€æ¬¡ç¼“å­˜ï¼ˆåœ¨æœ€åä¸€æ¬¡setVariableä¸­å·²è‡ªåŠ¨å¤„ç†ï¼‰
}

// å¢é‡æ›´æ–°ç­–ç•¥
function updatePlayerStat(statName:String, newValue) {
    var player = evaluator.getVariable("player");
    player[statName] = newValue;
    // ç›´æ¥ä¿®æ”¹ä¸ä¼šè§¦å‘ç¼“å­˜æ¸…ç†ï¼Œéœ€è¦æ‰‹åŠ¨é€šçŸ¥
    evaluator.setVariable("player", player);
}
```

**3. å†…å­˜ç®¡ç†é›†æˆ**
```actionscript
// åœ¨åœºæ™¯åˆ‡æ¢æ—¶æ¸…ç†ç¼“å­˜
function onSceneChange() {
    evaluator.clearContext();
    // é‡æ–°è®¾ç½®æ–°åœºæ™¯çš„ä¸Šä¸‹æ–‡
    initializeSceneContext();
}

// å®šæœŸæ¸…ç†ï¼ˆå¯é€‰ï¼Œé€‚ç”¨äºé•¿æœŸè¿è¡Œçš„åº”ç”¨ï¼‰
var lastCleanupTime = getTimer();
function onFrame() {
    var now = getTimer();
    if (now - lastCleanupTime > 300000) { // 5åˆ†é’Ÿ
        evaluator.clearCache(); // å‡è®¾æˆ‘ä»¬æ·»åŠ äº†è¿™ä¸ªæ–¹æ³•
        lastCleanupTime = now;
    }
}
```

#### é”™è¯¯å¤„ç†é›†æˆ

```actionscript
// å…¨å±€é”™è¯¯å¤„ç†å™¨
function setupErrorHandling() {
    evaluator.setErrorHandler(function(error:Error, expression:String) {
        // è®°å½•é”™è¯¯æ—¥å¿—
        Logger.error("Expression evaluation failed", {
            expression: expression,
            error: error.message,
            stack: error.stack,
            timestamp: new Date(),
            context: evaluator.getContext()
        });
        
        // å‘é€é¥æµ‹æ•°æ®ï¼ˆå¦‚æœéœ€è¦ï¼‰
        Telemetry.reportError("pratt_evaluation_error", {
            expression_hash: hashExpression(expression),
            error_type: error.name,
            user_id: UserManager.getCurrentUserId(),
            game_version: GameInfo.getVersion()
        });
        
        // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
        if (error.name == "SyntaxError") {
            UI.showMessage("è¡¨è¾¾å¼æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¯­æ³•");
        } else if (error.name == "ReferenceError") {
            UI.showMessage("å¼•ç”¨äº†ä¸å­˜åœ¨çš„å˜é‡æˆ–å‡½æ•°");
        } else {
            UI.showMessage("è®¡ç®—å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•");
        }
    });
}

// è¡¨è¾¾å¼éªŒè¯é›†æˆ
function validateUserExpression(expression:String):Object {
    var validation = evaluator.validate(expression);
    
    if (!validation.valid) {
        var suggestions = evaluator.suggestFixes(expression, validation.error);
        return {
            valid: false,
            error: validation.error,
            suggestions: suggestions,
            userMessage: generateUserFriendlyError(validation.error)
        };
    }
    
    return {valid: true};
}

function generateUserFriendlyError(error:String):String {
    var errorPatterns = {
        "Undefined variable": "æ‰¾ä¸åˆ°å˜é‡ï¼Œè¯·æ£€æŸ¥æ‹¼å†™",
        "Unknown function": "æ‰¾ä¸åˆ°å‡½æ•°ï¼Œè¯·æ£€æŸ¥å‡½æ•°å",
        "Expected": "è¯­æ³•é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ‹¬å·å’Œè¿ç®—ç¬¦",
        "Division by zero": "ä¸èƒ½é™¤ä»¥é›¶"
    };
    
    for (var pattern in errorPatterns) {
        if (error.indexOf(pattern) >= 0) {
            return errorPatterns[pattern];
        }
    }
    
    return "è¡¨è¾¾å¼æ ¼å¼é”™è¯¯";
}
```

### 6.4 æœ€ä½³å®è·µ

#### æ€§èƒ½æœ€ä½³å®è·µ

**1. è¡¨è¾¾å¼è®¾è®¡åŸåˆ™**
```actionscript
// âœ… å¥½çš„åšæ³•ï¼šç®€æ´æ˜äº†çš„è¡¨è¾¾å¼
var goodExpression = "player.level * 2 + bonus";

// âŒ é¿å…ï¼šè¿‡åº¦å¤æ‚çš„åµŒå¥—
var badExpression = "((player.stats.base.attack + player.equipment.weapon.damage) * (1 + player.buffs.strength.multiplier / 100)) * (player.level > 50 ? (player.mastery.combat + player.skills.swords) / 200 : 1.0)";

// âœ… å¥½çš„åšæ³•ï¼šå°†å¤æ‚é€»è¾‘æ‹†åˆ†ä¸ºå¤šä¸ªæ­¥éª¤
var baseAttack = evaluator.evaluate("player.stats.base.attack + player.equipment.weapon.damage");
evaluator.setVariable("baseAttack", baseAttack);
var finalDamage = evaluator.evaluate("baseAttack * strengthMultiplier * masteryBonus");
```

**2. ç¼“å­˜å‹å¥½çš„ç¼–ç¨‹æ¨¡å¼**
```actionscript
// âœ… ç¼“å­˜å‹å¥½ï¼šæ ‡å‡†åŒ–è¡¨è¾¾å¼æ ¼å¼
var DAMAGE_FORMULA = "baseAttack * (1 + strengthBonus) * critMultiplier";

// âŒ ç¼“å­˜æ— æ•ˆï¼šåŠ¨æ€æ„å»ºçš„è¡¨è¾¾å¼
var dynamicFormula = "baseAttack * (1 + " + strengthBonus + ") * " + critMultiplier;

// âœ… æ›´å¥½çš„åšæ³•ï¼šä½¿ç”¨å˜é‡æ³¨å…¥
evaluator.setVariable("strengthBonus", currentStrengthBonus);
evaluator.setVariable("critMultiplier", currentCritMultiplier);
var result = evaluator.evaluate(DAMAGE_FORMULA); // å¯ä»¥ç¼“å­˜AST
```

**3. ä¸Šä¸‹æ–‡ç®¡ç†ç­–ç•¥**
```actionscript
// âœ… æ‰¹é‡ä¸Šä¸‹æ–‡æ›´æ–°
function updateCombatContext(combatState) {
    var updates = {
        "attacker": combatState.attacker,
        "target": combatState.target,
        "environment": combatState.environment,
        "round": combatState.round
    };
    
    evaluator.setVariables(updates); // ä¸€æ¬¡æ€§æ›´æ–°ï¼Œä¸€æ¬¡ç¼“å­˜æ¸…ç†
}

// âŒ é¢‘ç¹å•æ¬¡æ›´æ–°
function badUpdateContext(combatState) {
    evaluator.setVariable("attacker", combatState.attacker);     // æ¸…ç†ç¼“å­˜
    evaluator.setVariable("target", combatState.target);       // å†æ¬¡æ¸…ç†ç¼“å­˜
    evaluator.setVariable("environment", combatState.environment); // å†æ¬¡æ¸…ç†ç¼“å­˜
    // å¯¼è‡´å¤šæ¬¡ä¸å¿…è¦çš„ç¼“å­˜æ¸…ç†
}
```

#### å®‰å…¨æ€§æœ€ä½³å®è·µ

**1. è¾“å…¥éªŒè¯ä¸æ¸…ç†**
```actionscript
// ç”¨æˆ·è¾“å…¥è¡¨è¾¾å¼çš„å®‰å…¨å¤„ç†
function processUserExpression(userInput:String):Object {
    // 1. é•¿åº¦é™åˆ¶
    if (userInput.length > 1000) {
        return {error: "è¡¨è¾¾å¼è¿‡é•¿"};
    }
    
    // 2. å­—ç¬¦ç™½åå•æ£€æŸ¥
    var allowedChars = /^[a-zA-Z0-9+\-*/().,\s<>=!&|?:]+$/;
    if (!allowedChars.test(userInput)) {
        return {error: "åŒ…å«éæ³•å­—ç¬¦"};
    }
    
    // 3. è¯­æ³•é¢„éªŒè¯
    var validation = evaluator.validate(userInput);
    if (!validation.valid) {
        return {error: "è¯­æ³•é”™è¯¯: " + validation.error};
    }
    
    // 4. å‡½æ•°è°ƒç”¨ç™½åå•
    var dangerousFuncs = ["eval", "exec", "system"];
    for (var i = 0; i < dangerousFuncs.length; i++) {
        if (userInput.indexOf(dangerousFuncs[i]) >= 0) {
            return {error: "ä¸å…è®¸çš„å‡½æ•°è°ƒç”¨"};
        }
    }
    
    // 5. å®‰å…¨æ±‚å€¼
    return {
        result: evaluator.evaluateSafe(userInput, null, {
            timeout: 5000,
            maxDepth: 20,
            expectedType: "number"
        })
    };
}
```

**2. æƒé™æ§åˆ¶æœºåˆ¶**
```actionscript
// åŸºäºè§’è‰²çš„å‡½æ•°è®¿é—®æ§åˆ¶
function createRestrictedEvaluator(userRole:String):PrattEvaluator {
    var evaluator = PrattEvaluator.createStandard();
    
    // å®šä¹‰è§’è‰²æƒé™
    var permissions = {
        "guest": ["Math.*", "max", "min", "abs"],
        "user": ["Math.*", "max", "min", "abs", "player.*", "getStats"],
        "admin": ["*"] // å…¨éƒ¨æƒé™
    };
    
    var allowedFunctions = permissions[userRole] || permissions["guest"];
    
    // åŒ…è£…å‡½æ•°è°ƒç”¨æ£€æŸ¥
    var originalSetFunction = evaluator.setFunction;
    evaluator.setFunction = function(name:String, func:Function) {
        if (isAllowedFunction(name, allowedFunctions)) {
            originalSetFunction.call(evaluator, name, func);
        } else {
            throw new Error("Permission denied for function: " + name);
        }
    };
    
    return evaluator;
}

function isAllowedFunction(funcName:String, allowList:Array):Boolean {
    for (var i = 0; i < allowList.length; i++) {
        var pattern = allowList[i];
        if (pattern == "*" || pattern == funcName) {
            return true;
        }
        if (pattern.indexOf("*") >= 0) {
            var regex = new RegExp("^" + pattern.replace("*", ".*") + "$");
            if (regex.test(funcName)) {
                return true;
            }
        }
    }
    return false;
}
```

#### å¯ç»´æŠ¤æ€§æœ€ä½³å®è·µ

**1. è¡¨è¾¾å¼ç‰ˆæœ¬ç®¡ç†**
```actionscript
// è¡¨è¾¾å¼é…ç½®çš„ç‰ˆæœ¬åŒ–ç®¡ç†
var ExpressionRegistry = {
    "damage_calculation": {
        "v1.0": "attack * 1.5",
        "v1.1": "attack * 1.5 + weaponBonus", 
        "v2.0": "(attack + weaponBonus) * (1 + strengthBonus) * critMultiplier",
        "current": "v2.0"
    },
    
    "experience_gain": {
        "v1.0": "baseExp * levelMultiplier",
        "v1.1": "baseExp * levelMultiplier * (1 + premiumBonus)",
        "current": "v1.1"
    }
};

function getExpression(name:String, version:String):String {
    var expressions = ExpressionRegistry[name];
    if (!expressions) {
        throw new Error("Unknown expression: " + name);
    }
    
    version = version || expressions.current;
    var expression = expressions[version];
    
    if (!expression) {
        throw new Error("Unknown version " + version + " for expression " + name);
    }
    
    return expression;
}

// ä½¿ç”¨ç¤ºä¾‹
var damageFormula = getExpression("damage_calculation", "v2.0");
var damage = evaluator.evaluate(damageFormula);
```

**2. è¡¨è¾¾å¼æµ‹è¯•æ¡†æ¶**
```actionscript
// è¡¨è¾¾å¼å•å…ƒæµ‹è¯•æ¡†æ¶
var ExpressionTestSuite = {
    tests: [],
    
    addTest: function(name:String, expression:String, context:Object, expected:Object) {
        this.tests.push({
            name: name,
            expression: expression,
            context: context,
            expected: expected
        });
    },
    
    runTests: function():Object {
        var results = {passed: 0, failed: 0, errors: []};
        var testEvaluator = PrattEvaluator.createStandard();
        
        for (var i = 0; i < this.tests.length; i++) {
            var test = this.tests[i];
            
            try {
                // è®¾ç½®æµ‹è¯•ä¸Šä¸‹æ–‡
                testEvaluator.clearContext();
                for (var key in test.context) {
                    testEvaluator.setVariable(key, test.context[key]);
                }
                
                // æ‰§è¡Œæµ‹è¯•
                var result = testEvaluator.evaluate(test.expression);
                
                // éªŒè¯ç»“æœ
                if (this.compareResults(result, test.expected.value)) {
                    results.passed++;
                } else {
                    results.failed++;
                    results.errors.push({
                        test: test.name,
                        expected: test.expected.value,
                        actual: result,
                        type: "VALUE_MISMATCH"
                    });
                }
                
            } catch (e) {
                if (test.expected.error) {
                    // æœŸæœ›çš„é”™è¯¯
                    if (e.message.indexOf(test.expected.error) >= 0) {
                        results.passed++;
                    } else {
                        results.failed++;
                        results.errors.push({
                            test: test.name,
                            expected: test.expected.error,
                            actual: e.message,
                            type: "ERROR_MISMATCH"
                        });
                    }
                } else {
                    // æ„å¤–çš„é”™è¯¯
                    results.failed++;
                    results.errors.push({
                        test: test.name,
                        error: e.message,
                        type: "UNEXPECTED_ERROR"
                    });
                }
            }
        }
        
        return results;
    },
    
    compareResults: function(actual, expected):Boolean {
        if (typeof actual == "number" && typeof expected == "number") {
            return Math.abs(actual - expected) < 0.0001; // æµ®ç‚¹æ•°æ¯”è¾ƒ
        }
        return actual === expected;
    }
};

// æµ‹è¯•ç”¨ä¾‹å®šä¹‰
ExpressionTestSuite.addTest(
    "Basic arithmetic",
    "2 + 3 * 4",
    {},
    {value: 14}
);

ExpressionTestSuite.addTest(
    "Function call",
    "max(a, b, c)",
    {a: 5, b: 10, c: 3},
    {value: 10}
);

ExpressionTestSuite.addTest(
    "Undefined variable",
    "unknownVar + 5",
    {},
    {error: "Undefined variable"}
);

// è¿è¡Œæµ‹è¯•
var testResults = ExpressionTestSuite.runTests();
trace("Tests passed: " + testResults.passed + "/" + (testResults.passed + testResults.failed));
```

---

## 7. æ‰©å±•ä¸äºŒæ¬¡å¼€å‘

### 7.1 å¿«é€Ÿå…¥é—¨ï¼šæ·»åŠ æ–°çš„äºŒå…ƒè¿ç®—ç¬¦

#### ç¤ºä¾‹ï¼šæ·»åŠ ç®¡é“è¿ç®—ç¬¦ `|>`

ç®¡é“è¿ç®—ç¬¦å…è®¸å°†å·¦ä¾§çš„å€¼ä½œä¸ºå³ä¾§å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæä¾›å‡½æ•°å¼ç¼–ç¨‹é£æ ¼ï¼š

```actionscript
// ç›®æ ‡è¯­æ³•: value |> transform |> format
// ç­‰ä»·äº: format(transform(value))
```

**æ­¥éª¤1ï¼šæ‰©å±•PrattParselet**
```actionscript
// åœ¨PrattParseletç±»ä¸­æ·»åŠ ç®¡é“è¿ç®—ç¬¦æ”¯æŒ
public static function pipeOperator():PrattParselet {
    // ç®¡é“è¿ç®—ç¬¦ï¼šä¼˜å…ˆçº§è¾ƒä½(1)ï¼Œå·¦ç»“åˆ
    return new PrattParselet(INFIX, "PIPE_OPERATOR", 1, false);
}

// åœ¨parseInfixæ–¹æ³•ä¸­æ·»åŠ å¤„ç†é€»è¾‘
public function parseInfix(parser:PrattParser, left:PrattExpression, token:PrattToken):PrattExpression {
    switch (_subType) {
        // ... å…¶ä»–case
        
        case "PIPE_OPERATOR":
            // è§£æå³ä¾§çš„å‡½æ•°è¡¨è¾¾å¼
            var rightFunc:PrattExpression = parser.parseExpression(_precedence);
            
            // å°†ç®¡é“è½¬æ¢ä¸ºå‡½æ•°è°ƒç”¨ï¼šleft |> func è½¬æ¢ä¸º func(left)
            if (rightFunc.type == PrattExpression.IDENTIFIER) {
                // ç®€å•å‡½æ•°ï¼švalue |> transform
                return PrattExpression.functionCall(rightFunc, [left]);
            } else if (rightFunc.type == PrattExpression.PROPERTY_ACCESS) {
                // æ–¹æ³•è°ƒç”¨ï¼švalue |> obj.method
                return PrattExpression.functionCall(rightFunc, [left]);
            } else if (rightFunc.type == PrattExpression.FUNCTION_CALL) {
                // å·²æœ‰å‚æ•°çš„å‡½æ•°ï¼švalue |> func(arg2, arg3) è½¬æ¢ä¸º func(value, arg2, arg3)
                var newArgs:Array = [left].concat(rightFunc.arguments);
                return PrattExpression.functionCall(rightFunc.functionExpr, newArgs);
            } else {
                throw new Error("Invalid pipe target: must be a function");
            }
        
        // ... å…¶ä»–case
    }
}
```

**æ­¥éª¤2ï¼šæ³¨å†Œæ–°è¿ç®—ç¬¦**
```actionscript
// åœ¨PrattParserçš„åˆå§‹åŒ–æ–¹æ³•ä¸­æ³¨å†Œ
private function _initializeDefaultParselets():Void {
    // ... ç°æœ‰çš„è¿ç®—ç¬¦æ³¨å†Œ
    
    // æ³¨å†Œç®¡é“è¿ç®—ç¬¦
    registerInfix("|>", PrattParselet.pipeOperator());
}

// æˆ–è€…é€šè¿‡æ‰©å±•æ–¹æ³•åŠ¨æ€æ·»åŠ 
public function addPipeOperator():Void {
    registerInfix("|>", PrattParselet.pipeOperator());
}
```

**æ­¥éª¤3ï¼šä½¿ç”¨ç¤ºä¾‹**
```actionscript
var evaluator = PrattEvaluator.createStandard();

// æ·»åŠ ç®¡é“è¿ç®—ç¬¦æ”¯æŒ
evaluator.getParser().addPipeOperator(); // å‡è®¾æˆ‘ä»¬æš´éœ²äº†parserè®¿é—®

// æ³¨å†Œæµ‹è¯•å‡½æ•°
evaluator.setFunction("double", function(x) { return x * 2; });
evaluator.setFunction("addTen", function(x) { return x + 10; });
evaluator.setFunction("toString", function(x) { return String(x); });

// æµ‹è¯•ç®¡é“è¿ç®—ç¬¦
var result1 = evaluator.evaluate("5 |> double");           // ç­‰ä»·äº double(5) = 10
var result2 = evaluator.evaluate("5 |> double |> addTen"); // ç­‰ä»·äº addTen(double(5)) = 20
var result3 = evaluator.evaluate("5 |> double |> addTen |> toString"); // ç­‰ä»·äº toString(addTen(double(5))) = "20"

trace("Pipeline results:", result1, result2, result3); // è¾“å‡º: 10, 20, "20"
```

#### ç¤ºä¾‹ï¼šæ·»åŠ èŒƒå›´è¿ç®—ç¬¦ `..`

```actionscript
// ç›®æ ‡è¯­æ³•: 1..5 ç”Ÿæˆ [1, 2, 3, 4, 5]
//          start..end ç”Ÿæˆæ•°å­—èŒƒå›´æ•°ç»„

// æ­¥éª¤1ï¼šæ·»åŠ Parselet
public static function rangeOperator():PrattParselet {
    return new PrattParselet(INFIX, "RANGE_OPERATOR", 4, false);
}

// æ­¥éª¤2ï¼šå®ç°è§£æé€»è¾‘
case "RANGE_OPERATOR":
    var endExpr:PrattExpression = parser.parseExpression(_precedence);
    
    // åˆ›å»ºä¸€ä¸ªç‰¹æ®Šçš„å‡½æ•°è°ƒç”¨æ¥è¡¨ç¤ºèŒƒå›´æ“ä½œ
    var rangeFunc:PrattExpression = PrattExpression.identifier("__range__");
    return PrattExpression.functionCall(rangeFunc, [left, endExpr]);

// æ­¥éª¤3ï¼šåœ¨æ±‚å€¼å™¨ä¸­æ³¨å†ŒèŒƒå›´å‡½æ•°
evaluator.setFunction("__range__", function(start, end) {
    var result:Array = [];
    start = Number(start);
    end = Number(end);
    
    if (start <= end) {
        for (var i = start; i <= end; i++) {
            result.push(i);
        }
    } else {
        for (var i = start; i >= end; i--) {
            result.push(i);
        }
    }
    
    return result;
});

// ä½¿ç”¨ç¤ºä¾‹
var range1 = evaluator.evaluate("1..5");    // [1, 2, 3, 4, 5]
var range2 = evaluator.evaluate("10..6");   // [10, 9, 8, 7, 6]
```

### 7.2 è¿›é˜¶ï¼šæ·»åŠ æ–°çš„è¯­æ³•ç»“æ„

#### ç¤ºä¾‹ï¼šæ·»åŠ Lambdaè¡¨è¾¾å¼æ”¯æŒ

ç›®æ ‡è¯­æ³•ï¼š`(x, y) => x + y` æˆ– `x => x * 2`

**æ­¥éª¤1ï¼šå®šä¹‰æ–°çš„Tokenç±»å‹**
```actionscript
// åœ¨PrattTokenä¸­æ·»åŠ æ–°çš„Tokenç±»å‹
public static var T_ARROW:String = "ARROW";    // =>
public static var T_LAMBDA:String = "LAMBDA";  // lambdaè¡¨è¾¾å¼æ ‡è¯†
```

**æ­¥éª¤2ï¼šæ‰©å±•Lexerè¯†åˆ«Lambdaè¯­æ³•**
```actionscript
// åœ¨PrattLexerçš„å¤šå­—ç¬¦è¿ç®—ç¬¦æ‰«æä¸­æ·»åŠ 
private function _scanMultiCharOperator():String {
    var char1:String = _src.charAt(_idx);
    var char2:String = _idx + 1 < _len ? _src.charAt(_idx + 1) : "";
    
    // ... ç°æœ‰çš„å¤šå­—ç¬¦è¿ç®—ç¬¦
    
    // æ·»åŠ ç®­å¤´è¿ç®—ç¬¦
    if (char1 == "=" && char2 == ">") {
        _advanceChar(); _advanceChar();
        return "=>";
    }
    
    return null;
}
```

**æ­¥éª¤3ï¼šåˆ›å»ºLambdaè¡¨è¾¾å¼çš„ASTèŠ‚ç‚¹**
```actionscript
// åœ¨PrattExpressionä¸­æ·»åŠ æ–°çš„è¡¨è¾¾å¼ç±»å‹
public static var LAMBDA:String = "LAMBDA";

// Lambdaè¡¨è¾¾å¼çš„å±æ€§
public var parameters:Array;  // å‚æ•°åˆ—è¡¨ [{name: String}]
public var body:PrattExpression;  // å‡½æ•°ä½“è¡¨è¾¾å¼

// å·¥å‚æ–¹æ³•
public static function lambda(params:Array, bodyExpr:PrattExpression):PrattExpression {
    var expr:PrattExpression = new PrattExpression(LAMBDA);
    expr.parameters = params || [];
    expr.body = bodyExpr;
    return expr;
}
```

**æ­¥éª¤4ï¼šå®ç°Lambdaè§£æé€»è¾‘**
```actionscript
// åˆ›å»ºLambdaä¸“ç”¨çš„Parselet
public static function lambdaExpression():PrattParselet {
    return new PrattParselet(INFIX, "LAMBDA_EXPRESSION", 0, true);
}

// åœ¨parseInfixä¸­å¤„ç†Lambda
case "LAMBDA_EXPRESSION":
    // leftåº”è¯¥æ˜¯å‚æ•°åˆ—è¡¨ï¼ˆæ ‡è¯†ç¬¦æˆ–åˆ†ç»„è¡¨è¾¾å¼ï¼‰
    var params:Array = _extractLambdaParameters(left);
    
    // è§£æ => åçš„å‡½æ•°ä½“
    var body:PrattExpression = parser.parseExpression(_precedence - 1);
    
    return PrattExpression.lambda(params, body);

// æå–Lambdaå‚æ•°çš„è¾…åŠ©æ–¹æ³•
private function _extractLambdaParameters(paramExpr:PrattExpression):Array {
    var params:Array = [];
    
    if (paramExpr.type == PrattExpression.IDENTIFIER) {
        // å•å‚æ•°ï¼šx => x * 2
        params.push({name: paramExpr.name});
    } else if (paramExpr.type == PrattExpression.GROUP) {
        // å¤šå‚æ•°ï¼š(x, y) => x + y
        // éœ€è¦è§£æç»„å†…çš„é€—å·åˆ†éš”æ ‡è¯†ç¬¦åˆ—è¡¨
        params = _parseParameterList(paramExpr);
    } else {
        throw new Error("Invalid lambda parameters");
    }
    
    return params;
}
```

**æ­¥éª¤5ï¼šå®ç°Lambdaæ±‚å€¼**
```actionscript
// åœ¨PrattExpression.evaluateä¸­æ·»åŠ Lambdaå¤„ç†
case LAMBDA:
    // Lambdaè¡¨è¾¾å¼æ±‚å€¼åº”è¯¥è¿”å›ä¸€ä¸ªå¯è°ƒç”¨çš„å‡½æ•°å¯¹è±¡
    return _createLambdaFunction(this, context);

// åˆ›å»ºLambdaå‡½æ•°çš„è¾…åŠ©æ–¹æ³•
private function _createLambdaFunction(lambdaExpr:PrattExpression, closureContext:Object):Function {
    return function() {
        // åˆ›å»ºæ–°çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ŒåŒ…å«é—­åŒ…å˜é‡
        var execContext:Object = {};
        
        // ç»§æ‰¿é—­åŒ…ä¸Šä¸‹æ–‡
        for (var key in closureContext) {
            execContext[key] = closureContext[key];
        }
        
        // ç»‘å®šå‚æ•°åˆ°ä¸Šä¸‹æ–‡
        for (var i = 0; i < lambdaExpr.parameters.length; i++) {
            var param = lambdaExpr.parameters[i];
            execContext[param.name] = arguments[i];
        }
        
        // åœ¨æ–°ä¸Šä¸‹æ–‡ä¸­æ±‚å€¼å‡½æ•°ä½“
        return lambdaExpr.body.evaluate(execContext);
    };
}
```

**æ­¥éª¤6ï¼šä½¿ç”¨ç¤ºä¾‹**
```actionscript
var evaluator = PrattEvaluator.createStandard();

// æ³¨å†Œç®­å¤´è¿ç®—ç¬¦
evaluator.getParser().registerInfix("=>", PrattParselet.lambdaExpression());

// æ³¨å†Œé«˜é˜¶å‡½æ•°
evaluator.setFunction("map", function(array, mapFunc) {
    var result = [];
    for (var i = 0; i < array.length; i++) {
        result.push(mapFunc(array[i]));
    }
    return result;
});

evaluator.setFunction("filter", function(array, filterFunc) {
    var result = [];
    for (var i = 0; i < array.length; i++) {
        if (filterFunc(array[i])) {
            result.push(array[i]);
        }
    }
    return result;
});

// ä½¿ç”¨Lambdaè¡¨è¾¾å¼
evaluator.setVariable("numbers", [1, 2, 3, 4, 5]);

// å•å‚æ•°Lambda
var doubled = evaluator.evaluate("map(numbers, x => x * 2)");
trace("Doubled:", doubled); // [2, 4, 6, 8, 10]

// å¤šå‚æ•°Lambdaï¼ˆéœ€è¦æ‰©å±•è¯­æ³•æ”¯æŒï¼‰
// éœ€è¦å¯¹_extractLambdaParameterså’ŒPrattParserè¿›è¡Œè¿›ä¸€æ­¥çš„æ‰©å±•ï¼ˆä¾‹å¦‚ï¼Œå¤„ç†åˆ†ç»„å†…çš„é€—å·åˆ†éš”åˆ—è¡¨ï¼‰
var sumArray = evaluator.evaluate("map(numbers, (x, i) => x + i)");

// åµŒå¥—Lambda
var filtered = evaluator.evaluate("filter(map(numbers, x => x * 2), x => x > 5)");
trace("Filtered:", filtered); // [6, 8, 10]
```

### 7.3 è‡ªå®šä¹‰å‡½æ•°åº“å¼€å‘

#### åˆ›å»ºä¸“ç”¨å‡½æ•°åº“

```actionscript
// åˆ›å»ºæ•°å­¦æ‰©å±•å‡½æ•°åº“
class MathExtensions {
    public static function registerTo(evaluator:PrattEvaluator):Void {
        // ä¸‰è§’å‡½æ•°
        evaluator.setFunction("sin", function(x) { return Math.sin(Number(x)); });
        evaluator.setFunction("cos", function(x) { return Math.cos(Number(x)); });
        evaluator.setFunction("tan", function(x) { return Math.tan(Number(x)); });
        
        // åä¸‰è§’å‡½æ•°
        evaluator.setFunction("asin", function(x) { return Math.asin(Number(x)); });
        evaluator.setFunction("acos", function(x) { return Math.acos(Number(x)); });
        evaluator.setFunction("atan", function(x) { return Math.atan(Number(x)); });
        evaluator.setFunction("atan2", function(y, x) { return Math.atan2(Number(y), Number(x)); });
        
        // å¯¹æ•°å‡½æ•°
        evaluator.setFunction("log", function(x) { return Math.log(Number(x)); });
        evaluator.setFunction("log10", function(x) { return Math.log(Number(x)) / Math.LN10; });
        evaluator.setFunction("log2", function(x) { return Math.log(Number(x)) / Math.LN2; });
        
        // ç»Ÿè®¡å‡½æ•°
        evaluator.setFunction("sum", function() {
            var total = 0;
            for (var i = 0; i < arguments.length; i++) {
                total += Number(arguments[i]);
            }
            return total;
        });
        
        evaluator.setFunction("avg", function() {
            if (arguments.length == 0) return 0;
            var total = 0;
            for (var i = 0; i < arguments.length; i++) {
                total += Number(arguments[i]);
            }
            return total / arguments.length;
        });
        
        evaluator.setFunction("median", function() {
            if (arguments.length == 0) return 0;
            var arr = [];
            for (var i = 0; i < arguments.length; i++) {
                arr.push(Number(arguments[i]));
            }
            arr.sort(function(a, b) { return a - b; });
            var mid = Math.floor(arr.length / 2);
            return arr.length % 2 == 0 ? (arr[mid-1] + arr[mid]) / 2 : arr[mid];
        });
    }
}

// å­—ç¬¦ä¸²å¤„ç†å‡½æ•°åº“
class StringExtensions {
    public static function registerTo(evaluator:PrattEvaluator):Void {
        evaluator.setFunction("len", function(str) {
            return String(str).length;
        });
        
        evaluator.setFunction("upper", function(str) {
            return String(str).toUpperCase();
        });
        
        evaluator.setFunction("lower", function(str) {
            return String(str).toLowerCase();
        });
        
        evaluator.setFunction("trim", function(str) {
            return String(str).replace(/^\s+|\s+$/g, "");
        });
        
        evaluator.setFunction("substr", function(str, start, length) {
            return String(str).substr(Number(start), Number(length));
        });
        
        evaluator.setFunction("indexOf", function(str, searchValue) {
            return String(str).indexOf(String(searchValue));
        });
        
        evaluator.setFunction("replace", function(str, searchValue, replaceValue) {
            return String(str).replace(String(searchValue), String(replaceValue));
        });
        
        evaluator.setFunction("split", function(str, separator) {
            return String(str).split(String(separator));
        });
        
        evaluator.setFunction("join", function(array, separator) {
            return array.join(String(separator));
        });
    }
}

// æ—¥æœŸæ—¶é—´å‡½æ•°åº“
class DateTimeExtensions {
    public static function registerTo(evaluator:PrattEvaluator):Void {
        evaluator.setFunction("now", function() {
            return new Date().getTime();
        });
        
        evaluator.setFunction("today", function() {
            var date = new Date();
            date.setHours(0, 0, 0, 0);
            return date.getTime();
        });
        
        evaluator.setFunction("year", function(timestamp) {
            return new Date(Number(timestamp)).getFullYear();
        });
        
        evaluator.setFunction("month", function(timestamp) {
            return new Date(Number(timestamp)).getMonth() + 1; // 1-based
        });
        
        evaluator.setFunction("day", function(timestamp) {
            return new Date(Number(timestamp)).getDate();
        });
        
        evaluator.setFunction("hour", function(timestamp) {
            return new Date(Number(timestamp)).getHours();
        });
        
        evaluator.setFunction("minute", function(timestamp) {
            return new Date(Number(timestamp)).getMinutes();
        });
        
        evaluator.setFunction("daysDiff", function(timestamp1, timestamp2) {
            var diff = Number(timestamp2) - Number(timestamp1);
            return Math.floor(diff / (24 * 60 * 60 * 1000));
        });
        
        evaluator.setFunction("formatDate", function(timestamp, format) {
            var date = new Date(Number(timestamp));
            format = String(format || "yyyy-MM-dd");
            
            var replacements = {
                "yyyy": date.getFullYear(),
                "MM": String(date.getMonth() + 1).length == 1 ? "0" + (date.getMonth() + 1) : String(date.getMonth() + 1),
                "dd": String(date.getDate()).length == 1 ? "0" + date.getDate() : String(date.getDate()),
                "HH": String(date.getHours()).length == 1 ? "0" + date.getHours() : String(date.getHours()),
                "mm": String(date.getMinutes()).length == 1 ? "0" + date.getMinutes() : String(date.getMinutes()),
                "ss": String(date.getSeconds()).length == 1 ? "0" + date.getSeconds() : String(date.getSeconds())
            };
            
            for (var pattern in replacements) {
                format = format.replace(pattern, replacements[pattern]);
            }
            
            return format;
        });
    }
}

// ä½¿ç”¨ç¤ºä¾‹
var evaluator = PrattEvaluator.createStandard();

// åŠ è½½æ‰©å±•å‡½æ•°åº“
MathExtensions.registerTo(evaluator);
StringExtensions.registerTo(evaluator);
DateTimeExtensions.registerTo(evaluator);

// ä½¿ç”¨æ‰©å±•å‡½æ•°
var result1 = evaluator.evaluate("sin(PI/2)");                    // 1
var result2 = evaluator.evaluate("avg(1, 2, 3, 4, 5)");          // 3
var result3 = evaluator.evaluate("upper('hello world')");         // "HELLO WORLD"
var result4 = evaluator.evaluate("formatDate(now(), 'yyyy-MM-dd')"); // "2024-01-15"
```

---

## 8. æ•…éšœæ’é™¤ä¸FAQ

### 8.1 å¸¸è§é—®é¢˜

#### Q1: è¡¨è¾¾å¼æ±‚å€¼ç»“æœä¸æ­£ç¡®

**ç—‡çŠ¶**: ç›¸åŒçš„è¡¨è¾¾å¼åœ¨ä¸åŒæ—¶é—´æ±‚å€¼å¾—åˆ°ä¸åŒç»“æœï¼Œæˆ–ç»“æœä¸é¢„æœŸä¸ç¬¦ã€‚

**å¯èƒ½åŸå› **:
1. **ç¼“å­˜æœªåŠæ—¶æ›´æ–°** - ä¸Šä¸‹æ–‡å˜åŒ–åç¼“å­˜æœªæ¸…ç†
2. **æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜** - JavaScriptæµ®ç‚¹æ•°è¿ç®—ç²¾åº¦è¯¯å·®
3. **ç±»å‹è½¬æ¢é—®é¢˜** - éšå¼ç±»å‹è½¬æ¢å¯¼è‡´æ„å¤–ç»“æœ
4. **å˜é‡ä½œç”¨åŸŸé—®é¢˜** - å˜é‡åå†²çªæˆ–è¦†ç›–

**è§£å†³æ–¹æ¡ˆ**:
```actionscript
// é—®é¢˜è¯Šæ–­
function diagnoseEvaluationIssue(expression:String, expectedResult, actualResult) {
    var diagnostic = {
        expression: expression,
        expected: expectedResult,
        actual: actualResult,
        context: evaluator.getContext(),
        cacheStats: evaluator.getCacheStats()
    };
    
    trace("=== è¡¨è¾¾å¼è¯Šæ–­æŠ¥å‘Š ===");
    trace("è¡¨è¾¾å¼: " + expression);
    trace("æœŸæœ›ç»“æœ: " + expectedResult + " (ç±»å‹: " + typeof expectedResult + ")");
    trace("å®é™…ç»“æœ: " + actualResult + " (ç±»å‹: " + typeof actualResult + ")");
    
    // æ£€æŸ¥ç¼“å­˜çŠ¶æ€
    if (diagnostic.cacheStats.resultHitRate > 0.8) {
        trace("âš ï¸ é«˜ç¼“å­˜å‘½ä¸­ç‡ï¼Œå¯èƒ½æ˜¯ç¼“å­˜é—®é¢˜");
        trace("å»ºè®®: å°è¯•ç¦ç”¨ç¼“å­˜é‡æ–°æ±‚å€¼");
        
        var noCacheResult = evaluator.evaluate(expression, false);
        if (noCacheResult == expectedResult) {
            trace("âœ… ç¦ç”¨ç¼“å­˜åç»“æœæ­£ç¡®ï¼Œç¡®è®¤ä¸ºç¼“å­˜é—®é¢˜");
            trace("è§£å†³æ–¹æ¡ˆ: è°ƒç”¨ evaluator.clearCache() æˆ–æ£€æŸ¥ä¸Šä¸‹æ–‡æ›´æ–°é€»è¾‘");
        }
    }
    
    // æ£€æŸ¥ç±»å‹è½¬æ¢
    if (typeof expectedResult != typeof actualResult) {
        trace("âš ï¸ ç»“æœç±»å‹ä¸åŒ¹é…ï¼Œå¯èƒ½æ˜¯ç±»å‹è½¬æ¢é—®é¢˜");
        trace("å»ºè®®: æ£€æŸ¥è¡¨è¾¾å¼ä¸­çš„ç±»å‹è½¬æ¢é€»è¾‘");
    }
    
    // æ£€æŸ¥æµ®ç‚¹æ•°ç²¾åº¦
    if (typeof expectedResult == "number" && typeof actualResult == "number") {
        var diff = Math.abs(expectedResult - actualResult);
        if (diff > 0 && diff < 1e-10) {
            trace("âš ï¸ å¾®å°æ•°å€¼å·®å¼‚ï¼Œå¯èƒ½æ˜¯æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜");
            trace("å»ºè®®: ä½¿ç”¨ Math.round() æˆ–è®¾ç½®å®¹å·®æ¯”è¾ƒ");
        }
    }
    
    return diagnostic;
}

// å¼ºåˆ¶æ¸…é™¤æ‰€æœ‰ç¼“å­˜
function clearAllCaches() {
    evaluator.clearContext();
    // é‡æ–°è®¾ç½®å¿…è¦çš„ä¸Šä¸‹æ–‡
    initializeApplicationContext();
}

// æµ®ç‚¹æ•°å®‰å…¨æ¯”è¾ƒ
function isNearlyEqual(a:Number, b:Number, tolerance:Number):Boolean {
    tolerance = tolerance || 1e-9;
    return Math.abs(a - b) < tolerance;
}
```

**é¢å¤–è¡¥å……**ï¼š æœ¬å¼•æ“ä¸»è¦æ˜¯æ±‚å€¼å™¨è€Œéå®Œæ•´çš„è§£é‡Šå™¨ã€‚è™½ç„¶æ”¯æŒèµ‹å€¼è¿ç®—ç¬¦ï¼Œä½†å…¶æ ¸å¿ƒæ˜¯è®¡ç®—å¹¶è¿”å›ä¸€ä¸ªå€¼ã€‚å¯¹ä¸Šä¸‹æ–‡çš„ä¿®æ”¹åº”è¯¥é€šè¿‡evaluator.setVariable()æ¥å®Œæˆï¼Œä»¥ç¡®ä¿ç¼“å­˜å’ŒçŠ¶æ€çš„ä¸€è‡´æ€§ã€‚ç›´æ¥åœ¨è¡¨è¾¾å¼ä¸­èµ‹å€¼å¯èƒ½ä¼šäº§ç”Ÿå‰¯ä½œç”¨ï¼Œä¸”å…¶è¡Œä¸ºå¯èƒ½ä¸é¢„æœŸä¸ç¬¦ï¼ˆå–å†³äºASTæ±‚å€¼é¡ºåºï¼‰ã€‚

#### Q2: æ€§èƒ½é—®é¢˜ - è¡¨è¾¾å¼æ±‚å€¼å¤ªæ…¢

**ç—‡çŠ¶**: è¡¨è¾¾å¼æ±‚å€¼è€—æ—¶è¿‡é•¿ï¼Œå½±å“åº”ç”¨å“åº”æ€§ã€‚

**è§£å†³æ–¹æ¡ˆ**:
```actionscript
// æ€§èƒ½åˆ†æå·¥å…·
function analyzePerformance(expression:String, iterations:Number):Object {
    iterations = iterations || 1000;
    
    var analysis = {
        expression: expression,
        complexity: _analyzeComplexity(expression),
        timings: {},
        recommendations: []
    };
    
    // æµ‹è¯•æ— ç¼“å­˜æ€§èƒ½
    var noCacheTime = _measureTime(function() {
        for (var i = 0; i < iterations; i++) {
            evaluator.evaluate(expression, false);
        }
    });
    analysis.timings.noCache = noCacheTime / iterations;
    
    // æµ‹è¯•ç¼“å­˜æ€§èƒ½
    var cacheTime = _measureTime(function() {
        for (var i = 0; i < iterations; i++) {
            evaluator.evaluate(expression, true);
        }
    });
    analysis.timings.withCache = cacheTime / iterations;
    
    // æ€§èƒ½å»ºè®®
    if (analysis.timings.noCache > 1.0) {
        analysis.recommendations.push("è¡¨è¾¾å¼è¿‡äºå¤æ‚ï¼Œè€ƒè™‘æ‹†åˆ†ä¸ºå¤šä¸ªç®€å•è¡¨è¾¾å¼");
    }
    
    if (analysis.timings.withCache > 0.1) {
        analysis.recommendations.push("ç¼“å­˜æ•ˆæœä¸ä½³ï¼Œæ£€æŸ¥ä¸Šä¸‹æ–‡æ›´æ–°é¢‘ç‡");
    }
    
    if (analysis.complexity.functions > 5) {
        analysis.recommendations.push("å‡½æ•°è°ƒç”¨è¿‡å¤šï¼Œè€ƒè™‘é¢„è®¡ç®—éƒ¨åˆ†ç»“æœ");
    }
    
    return analysis;
}

// è¡¨è¾¾å¼ä¼˜åŒ–å»ºè®®
function optimizeExpression(expression:String):Object {
    var optimizations = {
        original: expression,
        optimized: expression,
        changes: []
    };
    
    // å¸¸é‡æŠ˜å ä¼˜åŒ–
    var constantPattern = /(\d+)\s*([+\-*/])\s*(\d+)/g;
    optimizations.optimized = optimizations.optimized.replace(constantPattern, 
        function(match, a, op, b) {
            var result;
            switch(op) {
                case '+': result = Number(a) + Number(b); break;
                case '-': result = Number(a) - Number(b); break;
                case '*': result = Number(a) * Number(b); break;
                case '/': result = Number(a) / Number(b); break;
                default: return match;
            }
            optimizations.changes.push("å¸¸é‡æŠ˜å : " + match + " â†’ " + result);
            return String(result);
        }
    );
    
    // å‡½æ•°è°ƒç”¨ä¼˜åŒ–å»ºè®®
    if (expression.indexOf("Math.") != -1) {
        optimizations.changes.push("å»ºè®®: å°†é¢‘ç¹ä½¿ç”¨çš„Mathå‡½æ•°é¢„å…ˆè®¡ç®—å¹¶ç¼“å­˜");
    }
    
    return optimizations;
}
```

#### Q3: å†…å­˜æ³„æ¼é—®é¢˜

**ç—‡çŠ¶**: é•¿æ—¶é—´è¿è¡Œåå†…å­˜ä½¿ç”¨æŒç»­å¢é•¿ï¼Œæœ€ç»ˆå¯¼è‡´åº”ç”¨å¡é¡¿æˆ–å´©æºƒã€‚

**è§£å†³æ–¹æ¡ˆ**:
```actionscript
// å†…å­˜ç›‘æ§å·¥å…·
var MemoryMonitor = {
    cacheCheckInterval: 60000, // 1åˆ†é’Ÿ
    maxCacheSize: 1000,
    lastCleanup: getTimer(),
    
    startMonitoring: function() {
        setInterval(this.checkMemoryUsage, this.cacheCheckInterval);
    },
    
    checkMemoryUsage: function() {
        var now = getTimer();
        var cacheSize = this.getCacheSize();
        
        trace("=== å†…å­˜ç›‘æ§æŠ¥å‘Š ===");
        trace("ç¼“å­˜å¤§å°: " + cacheSize.result + " é¡¹ (ç»“æœç¼“å­˜)");
        trace("ASTç¼“å­˜: " + cacheSize.ast + " é¡¹");
        trace("æ€»å†…å­˜ä¼°ç®—: ~" + Math.round((cacheSize.result * 8 + cacheSize.ast * 200) / 1024) + " KB");
        
        if (cacheSize.result > this.maxCacheSize) {
            trace("âš ï¸ ç¼“å­˜è¿‡å¤§ï¼Œæ‰§è¡Œæ¸…ç†");
            this.performCleanup();
        }
        
        this.lastCleanup = now;
    },
    
    getCacheSize: function():Object {
        var resultCount = 0, astCount = 0;
        
        // è®¡ç®—ç»“æœç¼“å­˜å¤§å°
        for (var key in evaluator._resultCache) {
            resultCount++;
        }
        
        // è®¡ç®—ASTç¼“å­˜å¤§å°
        for (var key in evaluator._expressionCache) {
            astCount++;
        }
        
        return {result: resultCount, ast: astCount};
    },
    
    performCleanup: function() {
        // ä¿ç•™æœ€å¸¸ç”¨çš„è¡¨è¾¾å¼ï¼Œæ¸…ç†å…¶ä½™çš„
        var usage = this.getUsageStats();
        var keepCount = Math.floor(this.maxCacheSize * 0.8);
        
        // æŒ‰ä½¿ç”¨é¢‘ç‡æ’åºï¼Œä¿ç•™top 80%
        var sortedExpressions = [];
        for (var expr in usage) {
            sortedExpressions.push({expr: expr, count: usage[expr]});
        }
        sortedExpressions.sort(function(a, b) { return b.count - a.count; });
        
        var newResultCache = {};
        var newAstCache = {};
        
        for (var i = 0; i < keepCount && i < sortedExpressions.length; i++) {
            var expr = sortedExpressions[i].expr;
            if (evaluator._resultCache[expr] !== undefined) {
                newResultCache[expr] = evaluator._resultCache[expr];
            }
            if (evaluator._expressionCache[expr] !== undefined) {
                newAstCache[expr] = evaluator._expressionCache[expr];
            }
        }
        
        evaluator._resultCache = newResultCache;
        evaluator._expressionCache = newAstCache;
        
        trace("âœ… ç¼“å­˜æ¸…ç†å®Œæˆï¼Œä¿ç•™ " + keepCount + " ä¸ªæœ€å¸¸ç”¨è¡¨è¾¾å¼");
    },
    
    getUsageStats: function():Object {
        // è¿™é‡Œéœ€è¦è·Ÿè¸ªè¡¨è¾¾å¼ä½¿ç”¨é¢‘ç‡
        // ç®€åŒ–ç‰ˆæœ¬ï¼Œå®é™…åº”ç”¨ä¸­åº”è¯¥å®ç°ä½¿ç”¨è®¡æ•°å™¨
        return evaluator._usageCounter || {};
    }
};

// å¯åŠ¨å†…å­˜ç›‘æ§
MemoryMonitor.startMonitoring();
```

### 8.2 æ€§èƒ½é—®é¢˜è¯Šæ–­

#### æ€§èƒ½åˆ†æå·¥å…·å¥—ä»¶

```actionscript
// ç»¼åˆæ€§èƒ½åˆ†æå™¨
var PerformanceProfiler = {
    profiles: [],
    isEnabled: false,
    
    enable: function() {
        this.isEnabled = true;
        this.patchEvaluator();
    },
    
    disable: function() {
        this.isEnabled = false;
        this.unpatchEvaluator();
    },
    
    // å¯¹æ±‚å€¼å™¨è¿›è¡Œæ€§èƒ½ç›‘æ§åŒ…è£…
    patchEvaluator: function() {
        var originalEvaluate = evaluator.evaluate;
        var self = this;
        
        evaluator.evaluate = function(expression, useCache) {
            if (!self.isEnabled) {
                return originalEvaluate.call(this, expression, useCache);
            }
            
            var startTime = getTimer();
            var startMemory = System.totalMemory;
            
            var result;
            var error = null;
            
            try {
                result = originalEvaluate.call(this, expression, useCache);
            } catch (e) {
                error = e;
                throw e;
            } finally {
                var endTime = getTimer();
                var endMemory = System.totalMemory;
                
                self.recordProfile({
                    expression: expression,
                    duration: endTime - startTime,
                    memoryDelta: endMemory - startMemory,
                    useCache: useCache,
                    success: error == null,
                    error: error ? error.message : null,
                    timestamp: new Date(),
                    complexity: self.calculateComplexity(expression)
                });
            }
            
            return result;
        };
    },
    
    recordProfile: function(profile) {
        this.profiles.push(profile);
        
        // ä¿æŒæœ€è¿‘1000æ¡è®°å½•
        if (this.profiles.length > 1000) {
            this.profiles = this.profiles.slice(-1000);
        }
    },
    
    generateReport: function():Object {
        if (this.profiles.length == 0) {
            return {error: "æ²¡æœ‰æ€§èƒ½æ•°æ®"};
        }
        
        var report = {
            totalEvaluations: this.profiles.length,
            timeRange: {
                start: this.profiles[0].timestamp,
                end: this.profiles[this.profiles.length - 1].timestamp
            },
            performance: this.analyzePerformance(),
            expressions: this.analyzeExpressions(),
            recommendations: []
        };
        
        // ç”Ÿæˆæ€§èƒ½å»ºè®®
        report.recommendations = this.generateRecommendations(report);
        
        return report;
    },
    
    analyzePerformance: function():Object {
        var durations = this.profiles.map(function(p) { return p.duration; });
        var memoryDeltas = this.profiles.map(function(p) { return p.memoryDelta; });
        
        return {
            avgDuration: this.average(durations),
            maxDuration: Math.max.apply(null, durations),
            minDuration: Math.min.apply(null, durations),
            p95Duration: this.percentile(durations, 0.95),
            
            avgMemoryDelta: this.average(memoryDeltas),
            maxMemoryDelta: Math.max.apply(null, memoryDeltas),
            
            errorRate: this.profiles.filter(function(p) { return !p.success; }).length / this.profiles.length,
            cacheHitRate: this.profiles.filter(function(p) { return p.useCache; }).length / this.profiles.length
        };
    },
    
    analyzeExpressions: function():Object {
        var expressionStats = {};
        
        for (var i = 0; i < this.profiles.length; i++) {
            var profile = this.profiles[i];
            var expr = profile.expression;
            
            if (!expressionStats[expr]) {
                expressionStats[expr] = {
                    count: 0,
                    totalDuration: 0,
                    maxDuration: 0,
                    complexity: profile.complexity,
                    errors: 0
                };
            }
            
            var stats = expressionStats[expr];
            stats.count++;
            stats.totalDuration += profile.duration;
            stats.maxDuration = Math.max(stats.maxDuration, profile.duration);
            if (!profile.success) stats.errors++;
        }
        
        // è®¡ç®—å¹³å‡æ—¶é—´å¹¶æ’åº
        var sortedExpressions = [];
        for (var expr in expressionStats) {
            var stats = expressionStats[expr];
            stats.avgDuration = stats.totalDuration / stats.count;
            stats.expression = expr;
            sortedExpressions.push(stats);
        }
        
        sortedExpressions.sort(function(a, b) { return b.avgDuration - a.avgDuration; });
        
        return {
            total: sortedExpressions.length,
            slowest: sortedExpressions.slice(0, 10),  // æœ€æ…¢çš„10ä¸ª
            mostUsed: sortedExpressions.sort(function(a, b) { return b.count - a.count; }).slice(0, 10)
        };
    },
    
    generateRecommendations: function(report):Array {
        var recommendations = [];
        
        // æ€§èƒ½å»ºè®®
        if (report.performance.avgDuration > 1.0) {
            recommendations.push({
                type: "PERFORMANCE",
                severity: "HIGH",
                message: "å¹³å‡æ±‚å€¼æ—¶é—´è¿‡é•¿ (" + report.performance.avgDuration.toFixed(2) + "ms)",
                solution: "è€ƒè™‘ä¼˜åŒ–å¤æ‚è¡¨è¾¾å¼æˆ–å¢å¼ºç¼“å­˜ç­–ç•¥"
            });
        }
        
        if (report.performance.errorRate > 0.1) {
            recommendations.push({
                type: "RELIABILITY", 
                severity: "HIGH",
                message: "é”™è¯¯ç‡è¿‡é«˜ (" + (report.performance.errorRate * 100).toFixed(1) + "%)",
                solution: "åŠ å¼ºè¾“å…¥éªŒè¯å’Œé”™è¯¯å¤„ç†"
            });
        }
        
        if (report.performance.cacheHitRate < 0.5) {
            recommendations.push({
                type: "CACHING",
                severity: "MEDIUM", 
                message: "ç¼“å­˜å‘½ä¸­ç‡è¾ƒä½ (" + (report.performance.cacheHitRate * 100).toFixed(1) + "%)",
                solution: "æ£€æŸ¥è¡¨è¾¾å¼æ˜¯å¦ç»å¸¸å˜åŒ–ï¼Œè€ƒè™‘ä¼˜åŒ–ç¼“å­˜ç­–ç•¥"
            });
        }
        
        // è¡¨è¾¾å¼ç‰¹å®šå»ºè®®
        var slowExpressions = report.expressions.slowest.filter(function(e) { return e.avgDuration > 2.0; });
        if (slowExpressions.length > 0) {
            recommendations.push({
                type: "EXPRESSION_OPTIMIZATION",
                severity: "MEDIUM",
                message: "å‘ç° " + slowExpressions.length + " ä¸ªæ…¢è¡¨è¾¾å¼",
                solution: "ä¼˜åŒ–æˆ–æ‹†åˆ†è¿™äº›è¡¨è¾¾å¼: " + slowExpressions.map(function(e) { return e.expression; }).join(", ")
            });
        }
        
        return recommendations;
    },
    
    // å·¥å…·æ–¹æ³•
    average: function(arr) {
        return arr.reduce(function(sum, val) { return sum + val; }, 0) / arr.length;
    },
    
    percentile: function(arr, p) {
        var sorted = arr.slice().sort(function(a, b) { return a - b; });
        var index = Math.floor(sorted.length * p);
        return sorted[index];
    },
    
    calculateComplexity: function(expression) {
        var operators = (expression.match(/[+\-*/()]/g) || []).length;
        var functions = (expression.match(/\w+\s*\(/g) || []).length;
        var properties = (expression.match(/\.\w+/g) || []).length;
        
        return {
            operators: operators,
            functions: functions,
            properties: properties,
            score: operators + functions * 2 + properties
        };
    }
};

// ä½¿ç”¨ç¤ºä¾‹
PerformanceProfiler.enable();

// è¿è¡Œä¸€æ®µæ—¶é—´åç”ŸæˆæŠ¥å‘Š
setTimeout(function() {
    var report = PerformanceProfiler.generateReport();
    trace("=== æ€§èƒ½åˆ†ææŠ¥å‘Š ===");
    trace("æ€»æ±‚å€¼æ¬¡æ•°: " + report.totalEvaluations);
    trace("å¹³å‡è€—æ—¶: " + report.performance.avgDuration.toFixed(2) + "ms");
    trace("é”™è¯¯ç‡: " + (report.performance.errorRate * 100).toFixed(1) + "%");
    trace("ç¼“å­˜å‘½ä¸­ç‡: " + (report.performance.cacheHitRate * 100).toFixed(1) + "%");
    
    trace("\næœ€æ…¢çš„è¡¨è¾¾å¼:");
    for (var i = 0; i < Math.min(5, report.expressions.slowest.length); i++) {
        var expr = report.expressions.slowest[i];
        trace("  " + (i+1) + ". " + expr.expression + " (" + expr.avgDuration.toFixed(2) + "ms)");
    }
    
    trace("\næ€§èƒ½å»ºè®®:");
    for (var i = 0; i < report.recommendations.length; i++) {
        var rec = report.recommendations[i];
        trace("  [" + rec.severity + "] " + rec.message);
        trace("    è§£å†³æ–¹æ¡ˆ: " + rec.solution);
    }
}, 60000); // 1åˆ†é’Ÿåç”ŸæˆæŠ¥å‘Š
```

---

## 9. æ€»ç»“ä¸å±•æœ›

### æŠ€æœ¯æˆå°±æ€»ç»“

æœ¬è„šæœ¬å¼•æ“ä»£è¡¨äº†åœ¨ActionScript 2.0æŠ€æœ¯æ ˆä¸‹çš„ä¸€æ¬¡**å“è¶Šçš„å·¥ç¨‹å®è·µ**ã€‚å®ƒä¸ä»…æˆåŠŸå®ç°äº†ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡çš„è¡¨è¾¾å¼æ±‚å€¼ç³»ç»Ÿï¼Œæ›´åœ¨è®¾è®¡ç†å¿µã€æŠ€æœ¯æ¶æ„å’Œå·¥ç¨‹å“è´¨æ–¹é¢æ ‘ç«‹äº†æ ‡æ†ï¼š

#### ğŸ¯ **æ¶æ„è®¾è®¡çš„å“è¶Šæ€§**

**1. ç»å…¸ç®—æ³•çš„ç°ä»£åº”ç”¨**
- é‡‡ç”¨Prattè§£æç®—æ³•ï¼Œä¼˜é›…åœ°è§£å†³äº†è¿ç®—ç¬¦ä¼˜å…ˆçº§è¿™ä¸€ç¼–è¯‘å™¨è®¾è®¡çš„æ ¸å¿ƒéš¾é¢˜
- é€šè¿‡ç­–ç•¥æ¨¡å¼å®ç°è¯­æ³•è§„åˆ™çš„å®Œå…¨è§£è€¦ï¼Œå±•ç°äº†å¯¹è®¾è®¡æ¨¡å¼çš„æ·±åº¦ç†è§£
- åˆ†å±‚æ¶æ„ç¡®ä¿äº†ç»„ä»¶é—´çš„æ¸…æ™°èŒè´£åˆ†ç¦»ï¼Œä¸ºåç»­æ‰©å±•å¥ å®šäº†åšå®åŸºç¡€

**2. æ€§èƒ½ä¼˜åŒ–çš„å‰ç»æ€§**
- ä¸¤çº§ç¼“å­˜æœºåˆ¶çš„è®¾è®¡å ªç§°ç»å…¸ï¼Œæ—¢ä¿è¯äº†æ€§èƒ½åˆç»´æŠ¤äº†ä¸€è‡´æ€§
- æ™ºèƒ½çš„ç¼“å­˜å¤±æ•ˆç­–ç•¥é¿å…äº†è¿‡åº¦æ¸…ç†ï¼Œä½“ç°äº†å¯¹æ€§èƒ½å’Œæ­£ç¡®æ€§å¹³è¡¡çš„ç²¾å‡†æŠŠæ§
- å†…å­˜ç®¡ç†å’Œå¯¹è±¡é‡ç”¨ç­–ç•¥å±•ç°äº†å¯¹èµ„æºå—é™ç¯å¢ƒçš„æ·±åº¦ä¼˜åŒ–

**3. å¯æ‰©å±•æ€§çš„è¿œè§**
- Parseletç­–ç•¥æ¨¡å¼ä½¿å¾—æ·»åŠ æ–°è¯­æ³•ç»“æ„å˜å¾—ç®€å•ç›´æ¥
- å·¥å‚æ¨¡å¼æ”¯æŒä¸åŒåœºæ™¯çš„ä¸“ç”¨é…ç½®ï¼ˆå¦‚Buffç³»ç»Ÿï¼‰
- ä¸Šä¸‹æ–‡ç®¡ç†çš„çµæ´»æ€§ä¸ºå„ç§åº”ç”¨åœºæ™¯æä¾›äº†é€‚é…èƒ½åŠ›

#### ğŸ›¡ï¸ **å·¥ç¨‹å“è´¨çš„ä¸“ä¸šæ€§**

**1. é”™è¯¯å¤„ç†çš„å®Œå¤‡æ€§**
- ä»è¯æ³•åˆ†æåˆ°è¿è¡Œæ—¶æ±‚å€¼çš„å…¨é“¾è·¯é”™è¯¯å¤„ç†
- ç²¾ç¡®çš„ä½ç½®ä¿¡æ¯è·Ÿè¸ªï¼Œä¸ºè°ƒè¯•æä¾›æœ‰åŠ›æ”¯æŒ
- å®‰å…¨æ±‚å€¼æ¥å£å’Œå®¹é”™æœºåˆ¶ä¿è¯äº†ç³»ç»Ÿçš„å¥å£®æ€§

**2. è°ƒè¯•æ”¯æŒçš„è´´å¿ƒæ€§**
- ASTå¯è§†åŒ–å·¥å…·å¸®åŠ©ç†è§£å¤æ‚è¡¨è¾¾å¼ç»“æ„
- æ‰§è¡Œè¿½è¸ªå™¨æä¾›è¯¦ç»†çš„æ±‚å€¼æ­¥éª¤åˆ†æ
- æ€§èƒ½åˆ†æå™¨ä¸ºç³»ç»Ÿä¼˜åŒ–æä¾›é‡åŒ–æŒ‡æ ‡

**3. å…¼å®¹æ€§å¤„ç†çš„å‘¨å…¨æ€§**
- é’ˆå¯¹ä¸åŒFlash Playerç‰ˆæœ¬çš„ç»†è‡´å…¼å®¹æ€§å¤„ç†
- å¯¹å„ç§ç¼–è¯‘å™¨ç¯å¢ƒï¼ˆMTASCã€Flexï¼‰çš„é€‚é…æ”¯æŒ
- ActionScript 2.0è¯­è¨€é™åˆ¶çš„å·§å¦™è§„é¿å’Œè§£å†³

#### ğŸš€ **åˆ›æ–°ç‚¹çš„çªç ´æ€§**

**1. ç»Ÿä¸€ç±»ASTè®¾è®¡**
- ç”¨å•ä¸€ç±»è¡¨ç¤ºæ‰€æœ‰è¡¨è¾¾å¼ç±»å‹ï¼Œç®€åŒ–äº†æ¶æ„å¤æ‚åº¦
- é€šè¿‡å·¥å‚æ–¹æ³•ä¿è¯ç±»å‹å®‰å…¨ï¼Œå±•ç°äº†è®¾è®¡çš„å·§æ€

**2. ä¸Šä¸‹æ–‡å˜é‡æŸ¥æ‰¾çš„å¥å£®å®ç°**
- è§£å†³äº†ActionScript 2.0ä¸­æ— æ³•åŒºåˆ†"å±æ€§ä¸å­˜åœ¨"å’Œ"å±æ€§å€¼ä¸ºundefined"çš„æŠ€æœ¯éš¾é¢˜
- ä½“ç°äº†å¯¹è¯­è¨€é™·é˜±çš„æ·±åˆ»ç†è§£å’Œç²¾å¦™è§£å†³

**3. å¤šåœºæ™¯é€‚é…çš„çµæ´»æ€§**
- é€šè¿‡é¢„é…ç½®å·¥å‚æ–¹æ³•æ”¯æŒä¸åŒåº”ç”¨åœºæ™¯
- Buffç³»ç»Ÿä¸“ç”¨å‡½æ•°åº“å±•ç°äº†å¯¹æ¸¸æˆå¼€å‘é¢†åŸŸçš„æ·±åº¦ç†è§£

### åº”ç”¨ä»·å€¼è¯„ä¼°

#### ğŸ® **æ¸¸æˆå¼€å‘é¢†åŸŸçš„é©å‘½æ€§å½±å“**

æœ¬ç³»ç»Ÿä¸ºæ¸¸æˆå¼€å‘å¸¦æ¥äº†å‰æ‰€æœªæœ‰çš„çµæ´»æ€§ï¼š

- **åŠ¨æ€å¹³è¡¡è°ƒæ•´**ï¼šé€šè¿‡è¡¨è¾¾å¼é…ç½®ï¼Œå¯ä»¥åœ¨ä¸é‡æ–°ç¼–è¯‘çš„æƒ…å†µä¸‹è°ƒæ•´æ¸¸æˆå¹³è¡¡æ€§
- **å†…å®¹åˆ›ä½œå·¥å…·**ï¼šä¸ºæ¸¸æˆè®¾è®¡å¸ˆæä¾›äº†å¼ºå¤§çš„è§„åˆ™æè¿°è¯­è¨€
- **æ¨¡ç»„æ”¯æŒ**ï¼šä¸ºç©å®¶è‡ªå®šä¹‰å†…å®¹æä¾›äº†å®‰å…¨çš„è„šæœ¬æ‰§è¡Œç¯å¢ƒ

#### ğŸ’¼ **ä¼ä¸šåº”ç”¨çš„å®ç”¨ä»·å€¼**

- **ä¸šåŠ¡è§„åˆ™å¼•æ“**ï¼šå¤æ‚çš„ä¸šåŠ¡é€»è¾‘å¯ä»¥é€šè¿‡è¡¨è¾¾å¼é…ç½®è€Œéç¡¬ç¼–ç å®ç°
- **åŠ¨æ€å®šä»·ç³»ç»Ÿ**ï¼šç”µå•†å¹³å°çš„ä¿ƒé”€è§„åˆ™å¯ä»¥å®æ—¶è°ƒæ•´è€Œæ— éœ€å‘å¸ƒæ–°ç‰ˆæœ¬
- **æƒé™æ§åˆ¶ç³»ç»Ÿ**ï¼šåŸºäºè¡¨è¾¾å¼çš„æƒé™åˆ¤æ–­æä¾›äº†æå¤§çš„çµæ´»æ€§

#### ğŸ”§ **æŠ€æœ¯æ¶æ„çš„ç¤ºèŒƒæ„ä¹‰**

æœ¬ç³»ç»Ÿçš„è®¾è®¡ç†å¿µå’Œå®ç°æ–¹æ³•å¯¹ç°ä»£è½¯ä»¶å¼€å‘ä»å…·æœ‰é‡è¦å‚è€ƒä»·å€¼ï¼š

- **å¾®æœåŠ¡æ¶æ„**ï¼šç»„ä»¶è§£è€¦çš„æ€æƒ³ä¸å¾®æœåŠ¡ç†å¿µé«˜åº¦å¥‘åˆ
- **é¢†åŸŸç‰¹å®šè¯­è¨€(DSL)**ï¼šä¸ºä¸åŒä¸šåŠ¡é¢†åŸŸè®¾è®¡ä¸“ç”¨è¯­è¨€çš„èŒƒä¾‹
- **æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**ï¼šç¼“å­˜è®¾è®¡å’Œå†…å­˜ç®¡ç†çš„æœ€ä½³å®è·µ


### æœ€ç»ˆè¯„ä»·

æœ¬è„šæœ¬å¼•æ“ä¸ä»…æ˜¯ä¸€ä¸ª**æŠ€æœ¯å®ç°**ï¼Œæ›´æ˜¯ä¸€ä¸ª**å·¥ç¨‹è‰ºæœ¯å“**ã€‚å®ƒåœ¨æœ‰é™çš„æŠ€æœ¯æ¡ä»¶ä¸‹ï¼Œé€šè¿‡ç²¾å·§çš„è®¾è®¡å’Œå“è¶Šçš„å·¥ç¨‹å®è·µï¼Œåˆ›é€ äº†ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€æ€§èƒ½ä¼˜å¼‚ã€æ˜“äºæ‰©å±•çš„è¡¨è¾¾å¼æ±‚å€¼ç³»ç»Ÿã€‚

è¿™ä¸ªé¡¹ç›®ä½“ç°äº†è½¯ä»¶å·¥ç¨‹çš„æœ€é«˜å¢ƒç•Œï¼š
- **æŠ€æœ¯æ·±åº¦**ï¼šå¯¹ç®—æ³•å’Œæ•°æ®ç»“æ„çš„æ·±åˆ»ç†è§£
- **å·¥ç¨‹ç´ å…»**ï¼šå¯¹ä»£ç è´¨é‡å’Œç³»ç»Ÿè®¾è®¡çš„ä¸¥æ ¼è¦æ±‚  
- **å®ç”¨ä¸»ä¹‰**ï¼šå¯¹çœŸå®ä¸šåŠ¡éœ€æ±‚çš„å‡†ç¡®æŠŠæ¡
- **å‰ç»è§†é‡**ï¼šå¯¹æŠ€æœ¯å‘å±•è¶‹åŠ¿çš„æ•é”æ´å¯Ÿ

åœ¨è½¯ä»¶æŠ€æœ¯æ—¥æ–°æœˆå¼‚çš„ä»Šå¤©ï¼Œè¿™ä¸ªåœ¨ActionScript 2.0æ—¶ä»£è¯ç”Ÿçš„ç³»ç»Ÿï¼Œå…¶è®¾è®¡ç†å¿µå’ŒæŠ€æœ¯æ€æƒ³ä¾ç„¶å…·æœ‰é‡è¦çš„å‚è€ƒä»·å€¼å’ŒæŒ‡å¯¼æ„ä¹‰ã€‚å®ƒå‘Šè¯‰æˆ‘ä»¬ï¼Œ**çœŸæ­£ä¼˜ç§€çš„è½¯ä»¶ä¸åœ¨äºä½¿ç”¨äº†æœ€æ–°çš„æŠ€æœ¯ï¼Œè€Œåœ¨äºå¯¹é—®é¢˜æœ¬è´¨çš„æ·±åˆ»ç†è§£å’Œå¯¹è§£å†³æ–¹æ¡ˆçš„ç²¾å¦™è®¾è®¡**ã€‚

---
