# stateFlags 兼容缓冲期 - 动态修改点审计文档

> 生成时间: 2025-12-09
> 最后审计: 2025-12-09（全量扫描验证）
> 目的: 记录所有对 stateFlags 相关布尔属性进行动态修改/读取的位置，以便后续迁移

## 审计结论摘要

| 属性 | 运行期写入 | 运行期读取 | 框架层迁移状态 | 访问器依赖 |
|------|------------|------------|----------------|------------|
| 友军伤害 | ⚠️ 1处（核弹爆炸.xml:128） | ✅ 已迁移 | ✅ BulletQueueProcessor | 🔴 必需 |
| 不硬直 | ❌ 无 | ✅ 已迁移 | ✅ BulletQueueProcessor | 🟢 可选 |
| 水平击退反向 | ⚠️ 1处（裂地拳.xml:22） | ⚠️ 1处待迁移 | ✅ HitUpdater | 🔴 必需 |
| 远距离不消失 | ❌ 无 | ✅ 已迁移 | ✅ NormalBulletLifecycle | 🟢 可选 |
| 击中地图 | ✅ 已迁移 | ⚠️ 12处待迁移 | ✅ 全部已迁移 | 🔴 必需 |

## 概述

当前通过 `installStateFlagsAccessors` 安装的访问器属性：

| 属性名 | 状态位 | 位值 | 说明 |
|--------|--------|------|------|
| 友军伤害 | STATE_FRIENDLY_FIRE | 1 << 2 = 4 | 控制子弹是否可伤害友军 |
| 不硬直 | STATE_NO_STUN | 1 << 0 = 1 | 控制攻击者是否进入硬直 |
| 水平击退反向 | STATE_REVERSE_KNOCKBACK | 1 << 1 = 2 | 反转击退方向（吸引效果） |
| 远距离不消失 | STATE_LONG_RANGE | 1 << 3 = 8 | 子弹超出射程不自动销毁 |
| 击中地图 | STATE_HIT_MAP | 1 << 5 = 32 | 运行期标记，框架层已迁移 |

---

## 一、友军伤害 (STATE_FRIENDLY_FIRE)

### 1.1 运行期动态修改点 ⚠️ 需要访问器

#### 核弹爆炸.xml - 帧脚本动态修改
**文件**: `flashswf/arts/new/瓦巴杰克/LIBRARY/特效与子弹/核弹爆炸.xml`

| 行号 | 代码 | 触发时机 | 类型 |
|------|------|----------|------|
| 15 | `this.友军伤害 = false;` | 帧0（初始化） | 初始化 |
| 17 | `this.友军伤害 = true;` | 帧0（初始化） | 初始化 |
| **128** | `this.友军伤害 = true;` | **帧28（运行期）** | **🔴 动态修改** |

**业务逻辑**:
```actionscript
// 帧28：根据是否有"轰炸专家"被动技能决定是否开启友军伤害
if(获取发射对象.被动技能.轰炸专家 && 获取发射对象.被动技能.轰炸专家.启用) {
    this.子弹威力 *= 0.03 + 0.2/获取发射对象.被动技能.轰炸专家.等级;
    this.子弹敌我属性值 = !this.子弹敌我属性值;
    this.友军伤害 = true;  // 运行期动态设置！
}
```

#### 上帝之杖/巨大物理爆炸.xml
**文件**: `flashswf/arts/new/瓦巴杰克/LIBRARY/特效与子弹/上帝之杖/巨大物理爆炸.xml`

| 行号 | 代码 | 触发时机 | 类型 |
|------|------|----------|------|
| 15 | `this.友军伤害 = false;` | 帧0（初始化） | 初始化 |
| 17 | `this.友军伤害 = true;` | 帧0（初始化） | 初始化 |

### 1.2 框架层已迁移的读取点 ✅

| 文件 | 行号 | 代码 | 说明 |
|------|------|------|------|
| BulletQueueProcessor.as | 255 | `var isFriendlyFire:Boolean = (sf & STATE_FRIENDLY_FIRE) != 0;` | 队列分配时读取 |

**业务逻辑**: 根据友军伤害标志位决定子弹加入敌方队列还是全体队列

### 1.3 兼容性状态
- **访问器已安装**: ✅
- **运行期动态修改**: ✅ 存在（核弹爆炸帧28）
- **框架层读取**: ✅ 已迁移位运算
- **迁移优先级**: 🔴 高（XML动态修改待迁移）

---

## 二、不硬直 (STATE_NO_STUN)

### 2.1 初始化时设置点（非运行期）

#### scripts/逻辑/单位函数/单位函数_lsy_主角技能.as

| 行号 | 代码 | 函数名 | 说明 |
|------|------|--------|------|
| 261 | `子弹.不硬直 = true;` | 组合拳连续攻击 | 子弹创建后立即设置 |
| 429 | `function(不硬直)` | 凶斩攻击（参数） | 函数参数 |
| 442 | `子弹参数.不硬直 = 不硬直;` | 凶斩攻击 | 参数传递 |
| 469 | `子弹参数.不硬直 = true;` | 瞬步斩攻击 | 参数传递 |
| 616 | `子弹.不硬直 = true;` | 技能函数 | 子弹创建后设置 |
| 655 | `子弹参数.不硬直 = true;` | 迅斩攻击 | 参数传递 |

#### flashswf XML 资源文件

| 文件 | 行号 | 说明 |
|------|------|------|
| things0/.../空手跳.xml | 1850, 1930 | 空手跳技能 |
| things0/.../空手攻击.xml | 1698, 1760, 1822, 6215, 6277, 6339, 6401 | 空手攻击多段 |
| things0/.../技能.xml | 3659, 4807, 4863, 4919, 4975, 5031, 5087, 5143, 5199, 5255, 6136, 8059, 8130, 8201 | 各种技能 |
| things2/.../子弹碎片-异形飞血.xml | 96 | 异形飞血 |
| 素材库-诺亚新敌人/.../sprite 861.xml | 92 | 闪6特工 |
| 素材库-诺亚新敌人/.../sprite 856.xml | 83 | 闪6特工 |
| 素材库-诺亚新敌人/.../攻击动作.xml | 106 | 诺亚克隆兽 |
| 素材库-诺亚新敌人/.../近战.xml | 142 | 方舟指挥官 |
| 素材库-诺亚新敌人/.../空手攻击.xml | 26, 47, 68, 89 | 方舟指挥官 |
| 素材库-诺亚新敌人/.../攻击动作.xml (蛙型) | 178, 234, 290, 346, 457, 513 | 蛙型仿生僵尸 |

### 2.2 运行期动态修改点
**无发现** - 所有 `不硬直` 的设置都在子弹创建阶段完成

### 2.3 框架层已迁移的读取点 ✅

| 文件 | 行号 | 代码 | 说明 |
|------|------|------|------|
| BulletQueueProcessor.as | 840 | `shouldStun = (flags & FLAG_MELEE) != 0 && ((bullet.stateFlags \| 0) & STATE_NO_STUN) == 0;` | 近战硬直判断 |

**业务逻辑**: 近战子弹命中时，检查 STATE_NO_STUN 标志位决定射击者是否进入硬直状态

### 2.4 兼容性状态
- **访问器已安装**: ✅
- **运行期动态修改**: ❌ 无
- **框架层读取**: ✅ 已迁移位运算
- **迁移优先级**: 🟢 低（所有设置均在初始化阶段，访问器可正常同步）

---

## 三、水平击退反向 (STATE_REVERSE_KNOCKBACK)

### 3.1 运行期动态修改点 ⚠️ 需要访问器

#### 裂地拳.xml - 帧脚本动态修改
**文件**: `flashswf/arts/new/瓦巴杰克/LIBRARY/特效与子弹/裂地拳.xml`

| 行号 | 代码 | 触发时机 | 类型 |
|------|------|----------|------|
| **22** | `this.水平击退反向 = true;` | **帧2（运行期）** | **🔴 动态修改** |

**业务逻辑**:
```actionscript
// 帧2：裂地拳效果，设置水平击退反向使目标向中心吸引
this.Z轴攻击范围 = 60;
this.子弹威力 *= 0.5;
this.水平击退速度 = 10;
this.水平击退反向 = true;  // 运行期动态设置！
```

### 3.2 运行期读取点

#### HitEventComponent.as - 地图元件受击处理（仍使用布尔属性）
**文件**: `scripts/类定义/org/flashNight/arki/unit/UnitComponent/Initializer/EventComponent/HitEventComponent.as`

| 行号 | 代码 | 说明 |
|------|------|------|
| **30** | `var hitDirection:Boolean = Boolean((target._x < shooter._x) ^ bullet.水平击退反向);` | **🔴 运行期读取**（仅用于地图元件） |

**业务逻辑**: 在地图元件命中事件中读取 `水平击退反向` 决定击退方向

**说明**: 此处为 `onMapElementHit` 函数，仅处理地图元件（如可破坏场景物）的受击逻辑，非常规单位。

#### HitUpdater.as - 单位受击处理（已迁移到位运算 ✅）
**文件**: `scripts/类定义/org/flashNight/arki/unit/UnitComponent/Updater/HitUpdater.as`

| 行号 | 代码 | 说明 |
|------|------|------|
| **34** | `var reverse:Boolean = (sf & STATE_REVERSE_KNOCKBACK) != 0;` | ✅ **已迁移位运算** |

**业务逻辑**: 常规单位（敌人/玩家）的受击方向判断已使用位运算读取 `stateFlags`

### 3.3 初始化时设置点

| 文件 | 行号 | 说明 |
|------|------|------|
| 战斗系统_fs_lsy_aka_重写子弹生成逻辑.as | 79 | 参数传递 |
| 战斗系统_fs_lsy_aka_重写子弹生成逻辑.as | 194 | 默认值 `false` |
| BulletAttributesFactory.as | 63, 184, 226 | 工厂类 |
| BulletAttributes.as | 42, 114, 164 | 属性类 |

### 3.4 兼容性状态
- **访问器已安装**: ✅
- **运行期动态修改**: ✅ 存在（裂地拳帧2）
- **运行期读取（地图元件）**: ✅ 存在（HitEventComponent.onMapElementHit）
- **运行期读取（常规单位）**: ✅ 已迁移位运算（HitUpdater.doHitUpdate）
- **迁移优先级**: 🔴 高（地图元件处理待迁移）

---

## 四、远距离不消失 (STATE_LONG_RANGE)

### 4.1 设置点

此属性由 `setFlagDependentDefaults` 从多个来源合并计算，无外部直接设置点。

### 4.2 运行期动态修改点
**无发现**

### 4.3 兼容性状态
- **访问器已安装**: ✅
- **运行期动态修改**: ❌ 无
- **迁移优先级**: 🟢 低

---

## 五、击中地图 (STATE_HIT_MAP)

### 5.1 运行期读取点 ⚠️ 需要访问器

#### 战斗系统_fs_联弹管理.as
**文件**: `scripts/逻辑/战斗系统/战斗系统_fs_联弹管理.as`

| 行号 | 代码 | 说明 |
|------|------|------|
| **77** | `if (clip.霰弹值 <= 1 \|\| clip.击中地图) {` | **🔴 运行期读取** |

**业务逻辑**:
```actionscript
_root.联弹系统.联弹消失 = function(clip:MovieClip):Void {
    clip.stop();
    clip.flag = true;
    // 判断条件：如果霰弹值小于等于1，或者已经击中地图，则直接移除该 MovieClip
    if (clip.霰弹值 <= 1 || clip.击中地图) {  // 运行期读取！
        clip.removeMovieClip();
    } else {
        clip.gotoAndStop(1);
    }
};
```

#### flashswf XML 资源文件 - 运行期读取

| 文件 | 行号 | 代码 |
|------|------|------|
| 原版素材库-子弹/联弹/抛物联弹.xml | 28 | `if (霰弹值 <= 1 \|\| 击中地图)` |
| 原版素材库-子弹/子弹-普通与穿刺组/铁枪磁轨弹.xml | 26 | `if(击中地图){` |
| 原版素材库-子弹/子弹-普通与穿刺组/糖果子弹.xml | 29 | `if(击中地图){` |
| 原版素材库-子弹/子弹-普通与穿刺组/等离子穿刺子弹.xml | 29 | `if(击中地图){` |
| 原版素材库-子弹/子弹-普通与穿刺组/等离子大穿刺子弹.xml | 29 | `if(击中地图){` |
| 原版素材库-子弹/子弹-普通与穿刺组/穿刺子弹.xml | 29 | `if(击中地图){` |
| 原版素材库-子弹/子弹-普通与穿刺组/次级穿刺子弹.xml | 27 | `if(击中地图){` |
| 原版素材库-子弹/子弹-普通与穿刺组/暴君收割机锯片.xml | 29 | `if(击中地图){` |
| 原版素材库-子弹/子弹-普通与穿刺组/暗器/翼炎钉针.xml | 37 | `if(击中地图){` |
| 原版素材库-子弹/子弹-普通与穿刺组/无壳穿刺子弹.xml | 29 | `if(击中地图){` |
| 原版素材库-子弹/子弹-普通与穿刺组/巴雷特子弹.xml | 26 | `if(击中地图){` |

### 5.2 框架层已迁移的位置

以下位置已完成位运算迁移，不再使用布尔属性：

| 文件 | 操作 | 状态 |
|------|------|------|
| NormalBulletLifecycle.as | 写入 `\|= STATE_HIT_MAP` | ✅ 已迁移 |
| BulletQueueProcessor.as | 写入/读取 | ✅ 已迁移 |
| BulletCancelQueueProcessor.as | 写入 | ✅ 已迁移 |
| DestructionFinalizer.as | 读取 | ✅ 已迁移 |

### 5.3 兼容性状态
- **访问器已安装**: ✅
- **运行期读取（外部）**: ✅ 存在（1处AS + 11处XML = 共12处待迁移）
- **迁移优先级**: 🟡 中（框架层已完成，外部资源待迁移）

---

## 迁移计划建议

### 阶段一：高优先级（运行期动态修改/读取）

| 属性 | 文件 | 操作类型 | 当前状态 | 建议 |
|------|------|----------|----------|------|
| 友军伤害 | 核弹爆炸.xml:128 | 写入 | ⚠️ 待迁移 | 改为 `this.stateFlags \|= STATE_FRIENDLY_FIRE` |
| 水平击退反向 | 裂地拳.xml:22 | 写入 | ⚠️ 待迁移 | 改为 `this.stateFlags \|= STATE_REVERSE_KNOCKBACK` |
| 水平击退反向 | HitEventComponent.as:30 | 读取 | ⚠️ 待迁移（仅地图元件） | 改为 `(bullet.stateFlags & STATE_REVERSE_KNOCKBACK) != 0` |
| 击中地图 | 战斗系统_fs_联弹管理.as:77 | 读取 | ⚠️ 待迁移 | 改为 `(clip.stateFlags & STATE_HIT_MAP) != 0` |
| 击中地图 | 多个子弹XML（11个文件） | 读取 | ⚠️ 待迁移 | 改为位运算检测 |

**注意**: `水平击退反向` 在 HitUpdater.as 中的读取已完成位运算迁移（常规单位受击），仅 HitEventComponent.as 中的地图元件受击逻辑待迁移。

### 阶段二：低优先级（初始化时设置）

这些设置都在子弹创建阶段，可以保持现状（依赖访问器自动同步）或逐步迁移：

- `不硬直`: 约60+处，全部为初始化
- `水平击退反向`: 约5处，初始化参数
- `友军伤害`: 约3处，初始化

### 阶段三：验证测试

1. 核弹测试：发射核弹 → 爆炸后期阶段的友军伤害行为
2. 裂地拳测试：使用裂地拳 → 击退方向是否反向
3. 联弹测试：发射联弹 → 击中地图后的消失逻辑

---

## 访问器移除条件

当满足以下条件时，可以移除 `installStateFlagsAccessors`：

- [ ] 核弹爆炸.xml:128 改为位运算
- [ ] 裂地拳.xml:22 改为位运算
- [ ] HitEventComponent.as:30 改为位运算
- [ ] 战斗系统_fs_联弹管理.as:77 改为位运算
- [ ] 所有子弹XML中的 `击中地图` 读取改为位运算
- [ ] 所有技能脚本中的 `不硬直` 设置确认被框架正确处理

---

## 附录：搜索命令

```bash
# 精确搜索各属性
grep -rn "\b友军伤害\b" --include="*.as" --include="*.xml"
grep -rn "\b不硬直\b" --include="*.as" --include="*.xml"
grep -rn "\b水平击退反向\b" --include="*.as" --include="*.xml"
grep -rn "\b远距离不消失\b" --include="*.as" --include="*.xml"
grep -rn "\.击中地图[^效]" --include="*.as" --include="*.xml"
```
